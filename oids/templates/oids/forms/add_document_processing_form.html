{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">
        {{ page_title }}
        {% if selected_oid %}
            для ОІД: <a href="{% url 'oids:oid_detail_view_name' selected_oid.id %}">{{ selected_oid.cipher }}</a>
        {% endif %}
    </h2>
    <form method="post" enctype="multipart/form-data" novalidate> {# enctype для завантаження файлів #}
        {% csrf_token %}
        {{ form.media }}

        {% for field in form %}
            <div class="form-group mb-3">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                    <small class="form-text text-muted">{{ field.help_text }}</small>
                {% endif %}
                {% for error in field.errors %}
                    <div class="alert alert-danger mt-1 p-1" role="alert">{{ error }}</div>
                {% endfor %}
            </div>
        {% endfor %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
        
        <button type="submit" class="btn btn-primary">Зберегти документ</button>
        {% if selected_oid %}
             <a href="{% url 'oids:oid_detail_view_name' selected_oid.id %}" class="btn btn-secondary">Скасувати</a>
        {% else %}
            <a href="{% url 'oids:main_dashboard' %}" class="btn btn-secondary">Скасувати</a>
        {% endif %}
    </form>
</div>
{% endblock %}

{% block page_specific_js %}
<script>
$(document).ready(function() {
    // Ініціалізація Select2
    // initSelect2Fields($('#documentForm'));

    // Тут потрібен JS для динамічного оновлення поля "Тип документа" (id_document_type)
    // на основі обраного "ОІД" (id_document_oid) та, можливо, "Елемент заявки".
    // Це вимагатиме AJAX-запиту до нового view, який повертатиме відфільтровані DocumentType.
    // Також потрібно буде налаштувати filtering_dynamic.js для цього.

    const oidSelect = $('#id_document_oid');
    const workRequestItemSelect = $('#id_work_request_item'); // Якщо це поле є
    const documentTypeSelect = $('#id_document_type'); // ID з DocumentForm

    function loadDocumentTypes() {
        const oidId = oidSelect.val();
        // const wrItemId = workRequestItemSelect.val(); // Якщо використовується
        
        // Припускаємо, що work_type визначається з обраного OID або WorkRequestItem
        // або передається як окремий параметр, якщо документ не пов'язаний з заявкою.
        // Ця логіка потребує уточнення.

        if (oidId) {
            // console.log(`OID обрано: ${oidId}, завантажуємо типи документів...`);
            // AJAX-запит для отримання типів документів
            // $.ajax({
            //     url: "{% url 'oids:ajax_load_document_types' %}", // Потрібно створити цей URL та View
            //     data: {
            //         'oid_id': oidId,
            //         // 'work_request_item_id': wrItemId // якщо потрібно
            //     },
            //     success: function(data) {
            //         documentTypeSelect.empty().append($('<option value="">Оберіть тип...</option>'));
            //         $.each(data, function(key, value) {
            //             documentTypeSelect.append($('<option></option>').attr('value', value.id).text(value.name));
            //         });
            //         documentTypeSelect.trigger('change'); // для Select2
            //     }
            // });
        } else {
            documentTypeSelect.empty().append($('<option value="">Спочатку оберіть ОІД</option>')).trigger('change');
        }
    }

    if (oidSelect.length) { // Якщо поле ОІД існує на формі
       oidSelect.on('change', loadDocumentTypes);
       // Початкове завантаження, якщо ОІД вже обрано (наприклад, при редагуванні або з initial)
       if(oidSelect.val()){
           loadDocumentTypes();
       }
    }
    // if (workRequestItemSelect.length) { // Якщо поле елемента заявки існує
    //    workRequestItemSelect.on('change', loadDocumentTypes);
    // }

});
</script>
{% endblock %}