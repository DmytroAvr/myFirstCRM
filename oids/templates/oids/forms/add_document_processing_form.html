{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Додати опрацювання документів" }}{% endblock %}

{% block content %}
<div class="container form-container">
    <h2 class="mb-4">
        {{ page_title|default:"Додати опрацювання документів" }}
        {% if selected_oid %}
            для ОІД: <a href="{% url 'oids:oid_detail_view_name' selected_oid.id %}">{{ selected_oid.cipher }}</a>
             ({{ selected_oid.get_oid_type_display }})
        {% endif %}
    </h2>

    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        {{ form.media }}

        <div class="table-like-form">
            {% for field in form %}
                <div class="form-row mb-3">
                    <div class="form-group-label" style="font-weight: bold; padding-right: 10px; min-width: 200px; display: inline-block; vertical-align: top;">
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                        {% if field.field.required %}
                            <span style="color: red;">*</span>
                        {% endif %}
                    </div>
                    <div class="form-group-field" style="display: inline-block; width: calc(100% - 220px);">
                        {{ field }}
                        {% if field.help_text %}
                            <br><small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}
                        {% for error in field.errors %}
                            <div class="alert alert-danger mt-1 p-1" role="alert" style="font-size: 0.9em;">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Зберегти документ</button>
            {% if selected_oid %}
                 <a href="{% url 'oids:oid_detail_view_name' selected_oid.id %}" class="btn btn-secondary">Скасувати</a>
            {% else %}
                <a href="{% url 'oids:main_dashboard' %}" class="btn btn-secondary">Скасувати</a>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}

{% block page_specific_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("AddDocumentProcessing JS: DOMContentLoaded");

    // --- Елементи DOM та URL ---
    const oidSelectElement = document.getElementById('{{ form.oid.id_for_label }}'); // ID з DocumentForm
    const workRequestItemSelectElement = document.getElementById('{{ form.work_request_item.id_for_label }}');
    const documentTypeSelectElement = document.getElementById('{{ form.document_type.id_for_label }}');
    // Додайте сюди інші select, які потрібно ініціалізувати TomSelect, наприклад, 'author'
    const authorSelectElement = document.getElementById('{{ form.author.id_for_label }}');


    const workRequestItemsAjaxUrl = "{% url 'oids:ajax_load_work_request_items_for_oid' %}";
    const documentTypesAjaxUrl = "{% url 'oids:ajax_load_document_types_for_oid_and_work' %}";

    if (typeof TomSelect === 'undefined') {
        console.error("AddDocumentProcessing JS: TomSelect library is NOT loaded!");
        return; 
    }
    console.log("AddDocumentProcessing JS: TomSelect library is loaded.");

    // --- Стан ---
    let currentSelectedOidId = null;
    let currentSelectedOidType = null; // Будемо зберігати тип обраного ОІД (МОВНА/ПЕМІН)
    let currentSelectedWorkType = null;  // Тип робіт з обраного WorkRequestItem

    // --- TomSelect екземпляри ---
    let tomSelectOid = null;
    let tomSelectWRI = null; // WorkRequestItem
    let tomSelectDocType = null;
    let tomSelectAuthor = null; // Для поля Автор

    // --- Утилітарна функція для конфігурації TomSelect ---
    function getTomSelectConfig(elementId, placeholder, isDisabled = false, initialOptions = [], allowClear = true, isMulti = false) {
        console.log(`CONFIG: TomSelect for #${elementId}. Placeholder: "${placeholder}", Disabled: ${isDisabled}`);
        return {
            plugins: isMulti ? ['remove_button'] : [],
            create: false, placeholder: placeholder,
            valueField: 'id', labelField: 'text', searchField: ['text'],
            options: initialOptions, disabled: isDisabled, allowEmptyOption: allowClear,
        };
    }

    // --- Модуль/Логіка для поля "Тип Документа" (DocumentType) ---
    const DocumentTypeManager = {
        init: function() {
            if (documentTypeSelectElement) {
                const config = getTomSelectConfig(documentTypeSelectElement.id, 'Спочатку оберіть ОІД та Тип робіт', true);
                tomSelectDocType = new TomSelect(documentTypeSelectElement, config);
                documentTypeSelectElement.tomselectInstance = tomSelectDocType;
                console.log("DocTypeManager: TomSelect for DocumentType INITIALIZED (disabled).");
            } else { console.warn("DocTypeManager: DocumentType select element not found."); }
        },
        load: function(oidId, oidType, workType) {
            console.log(`DocTypeManager: load CALLED. OID ID: ${oidId}, OID Type: ${oidType}, Work Type: ${workType}`);
            if (!tomSelectDocType) { console.warn("DocTypeManager: TomSelect instance not ready."); return; }

            tomSelectDocType.clear();
            tomSelectDocType.clearOptions();
            tomSelectDocType.sync();

            if (oidId && oidType) { // Тип ОІД має бути відомий
                tomSelectDocType.enable();
                tomSelectDocType.placeholder = 'Завантаження типів документів...';
                
                const params = new URLSearchParams({ oid_id: oidId });
                // Тип робіт (workType) є опціональним для цього запиту, 
                // сервер сам вирішить, які типи документів показувати, якщо workType не передано
                if (workType) {
                    params.append('work_type', workType);
                }
                console.log(`DocTypeManager: Fetching DocumentTypes from: ${documentTypesAjaxUrl}?${params.toString()}`);

                fetch(`${documentTypesAjaxUrl}?${params.toString()}`)
                    .then(response => {
                        if (!response.ok) return response.text().then(text => { throw new Error(`Net error DocTypes: ${response.statusText}. Server: ${text}`);});
                        return response.json();
                    })
                    .then(data => {
                        console.log("DocTypeManager: DocumentTypes data received:", data);
                        const options = data.map(dt => ({ id: dt.id.toString(), text: dt.text }));
                        tomSelectDocType.addOptions(options);
                        tomSelectDocType.refreshOptions(false);
                        const items = tomSelectDocType.dropdown_content.querySelectorAll('.option').length;
                        console.log(`DocTypeManager: Options in DocumentType dropdown: ${items}`);
                        tomSelectDocType.placeholder = options.length > 0 ? 'Оберіть тип документа...' : 'Типи документів не знайдено';
                        if (options.length > 0 && items > 0) tomSelectDocType.open();
                    })
                    .catch(error => { console.error("DocTypeManager: Error loading DocumentTypes:", error); tomSelectDocType.placeholder = 'Помилка завантаження типів'; tomSelectDocType.refreshOptions(false);});
            } else {
                tomSelectDocType.disable();
                tomSelectDocType.placeholder = 'Спочатку оберіть ОІД (та Тип робіт)';
            }
        }
    };

    // --- Модуль/Логіка для поля "Елемент Заявки" (WorkRequestItem) ---
    const WorkRequestItemManager = {
        init: function() {
            if (workRequestItemSelectElement) {
                const config = getTomSelectConfig(workRequestItemSelectElement.id, 'Спочатку оберіть ОІД', true, [], true, []); // Не multi, allowClear=true
                tomSelectWRI = new TomSelect(workRequestItemSelectElement, config);
                workRequestItemSelectElement.tomselectInstance = tomSelectWRI;
                console.log("WRIManager: TomSelect for WorkRequestItem INITIALIZED (disabled).");

                // Слухач на зміну Елемента Заявки -> оновлюємо Тип Документа
                tomSelectWRI.on('change', function(selectedWRI_Id) {
                    console.log("WRIManager: WorkRequestItem selection CHANGED. Selected WRI ID:", selectedWRI_Id);
                    currentSelectedWorkType = null; // Скидаємо попередній тип робіт
                    if (selectedWRI_Id) {
                        const selectedOptionData = this.options[selectedWRI_Id]; // Отримуємо дані опції
                        if (selectedOptionData && selectedOptionData.work_type) {
                            currentSelectedWorkType = selectedOptionData.work_type;
                            console.log("WRIManager: Extracted WorkType from selected WRI:", currentSelectedWorkType);
                        } else {
                            console.warn("WRIManager: Could not extract WorkType from selected WRI option data:", selectedOptionData);
                        }
                    }
                    // Оновлюємо типи документів на основі нового типу робіт (та поточного ОІД та його типу)
                    if (currentSelectedOidId && currentSelectedOidType) {
                         DocumentTypeManager.load(currentSelectedOidId, currentSelectedOidType, currentSelectedWorkType);
                    } else {
                        DocumentTypeManager.load(null, null, null); // Очистити типи документів
                    }
                });

            } else { console.warn("WRIManager: WorkRequestItem select element not found."); }
        },
        load: function(oidId) {
            console.log(`WRIManager: load CALLED. OID ID: ${oidId}`);
            if (!tomSelectWRI) { console.warn("WRIManager: TomSelect instance not ready."); return; }

            tomSelectWRI.clear();
            tomSelectWRI.clearOptions();
            tomSelectWRI.sync();
            currentSelectedWorkType = null; // Скидаємо тип робіт, оскільки ОІД змінився

            if (oidId) {
                tomSelectWRI.enable();
                tomSelectWRI.placeholder = 'Завантаження елементів заявок...';
                
                console.log(`WRIManager: Fetching WorkRequestItems from: ${workRequestItemsAjaxUrl}?oid_id=${oidId}`);
                fetch(`${workRequestItemsAjaxUrl}?oid_id=${oidId}`)
                    .then(response => {
                        if (!response.ok) return response.text().then(text => { throw new Error(`Net error WRI: ${response.statusText}. Server: ${text}`);});
                        return response.json();
                    })
                    .then(data => {
                        console.log("WRIManager: WorkRequestItems data received:", data);
                        // Важливо: AJAX має повертати 'work_type' для кожної опції
                        const options = data.map(item => ({ 
                            id: item.id.toString(), 
                            text: item.text,
                            work_type: item.work_type // Зберігаємо тип робіт в даних опції
                        }));
                        tomSelectWRI.addOptions(options);
                        tomSelectWRI.refreshOptions(false);
                        const items = tomSelectWRI.dropdown_content.querySelectorAll('.option').length;
                        console.log(`WRIManager: Options in WRI dropdown: ${items}`);
                        tomSelectWRI.placeholder = options.length > 0 ? 'Оберіть елемент заявки (необов\'язково)' : 'Для ОІД немає пов\'язаних заявок';
                    })
                    .catch(error => { console.error("WRIManager: Error loading WorkRequestItems:", error); tomSelectWRI.placeholder = 'Помилка завантаження заявок'; tomSelectWRI.refreshOptions(false);});
            } else {
                tomSelectWRI.disable();
                tomSelectWRI.placeholder = 'Спочатку оберіть ОІД';
            }
        }
    };

    // --- Модуль/Логіка для поля "ОІД" ---
    const OidManager = {
        init: function() {
            if (oidSelectElement) {
                // Якщо ОІД вже обраний на сторінці (наприклад, initial_oid з view)
                // TomSelect має автоматично підхопити його з HTML <select>
                const config = getTomSelectConfig(oidSelectElement.id, 'Оберіть ОІД...', false, [], true, []); // Не multi
                tomSelectOid = new TomSelect(oidSelectElement, config);
                oidSelectElement.tomselectInstance = tomSelectOid;
                console.log("OidManager: TomSelect for OID INITIALIZED.");

                // Отримуємо початково обраний ОІД ID та його тип
                currentSelectedOidId = tomSelectOid.getValue();
                if (currentSelectedOidId) {
                    const selectedOptionElement = oidSelectElement.options[oidSelectElement.selectedIndex];
                    if (selectedOptionElement && selectedOptionElement.dataset.oidType) {
                         currentSelectedOidType = selectedOptionElement.dataset.oidType;
                    } else {
                        // Якщо типу немає в data-атрибуті, його потрібно буде завантажити або отримати інакше
                        console.warn("OidManager: OID type not found in data-attribute for pre-selected OID. DocumentType filtering might be incomplete.");
                    }
                    console.log(`OidManager: Initial OID ID: ${currentSelectedOidId}, OID Type: ${currentSelectedOidType}`);
                }


                tomSelectOid.on('change', function(selectedOid) {
                    console.log("OidManager: OID selection CHANGED. Selected OID ID:", selectedOid);
                    currentSelectedOidId = selectedOid;
                    currentSelectedOidType = null; // Скидаємо тип, потрібно отримати новий

                    if (selectedOid) {
                        // Отримуємо data-oid-type з обраної опції TomSelect (якщо він там є)
                        // TomSelect зберігає оригінальні дані опції в this.options[value]
                        const optionData = this.options[selectedOid]; 
                        if (optionData && optionData.dataset && optionData.dataset.oidType) { // Якщо data-атрибут скопіювався
                            currentSelectedOidType = optionData.dataset.oidType;
                        } else {
                            // Або з самого HTML елемента, якщо TomSelect його не копіює
                            const selectedOptionElement = oidSelectElement.querySelector(`option[value="${selectedOid}"]`);
                            if (selectedOptionElement && selectedOptionElement.dataset.oidType) {
                                currentSelectedOidType = selectedOptionElement.dataset.oidType;
                            } else {
                                 console.warn("OidManager: OID type not found in data-attribute for selected OID. DocumentType filtering might be incomplete.");
                                 // Тут можна зробити AJAX запит для отримання типу ОІД, якщо потрібно
                            }
                        }
                        console.log(`OidManager: New OID Type from selection: ${currentSelectedOidType}`);
                        WorkRequestItemManager.load(selectedOid);
                        DocumentTypeManager.load(selectedOid, currentSelectedOidType, null); // Завантажуємо типи документів без типу робіт спочатку
                    } else {
                        WorkRequestItemManager.load(null); // Очистити WRI
                        DocumentTypeManager.load(null, null, null); // Очистити DocumentTypes
                    }
                });

                // Початкове завантаження залежних полів, якщо ОІД вже обраний
                if (currentSelectedOidId) {
                    console.log("OidManager: Triggering initial load for dependent fields based on pre-selected OID.");
                    WorkRequestItemManager.load(currentSelectedOidId);
                    DocumentTypeManager.load(currentSelectedOidId, currentSelectedOidType, null);
                } else {
                    // Якщо ОІД не обраний, деактивуємо залежні поля
                    WorkRequestItemManager.load(null);
                    DocumentTypeManager.load(null, null, null);
                }


            } else { console.warn("OidManager: OID select element not found."); }
        }
    };
    
    // Ініціалізація поля "Автор"
    if (authorSelectElement) {
        const authorConfig = getTomSelectConfig(authorSelectElement.id, 'Оберіть автора...', false, [], true, []);
        tomSelectAuthor = new TomSelect(authorSelectElement, authorConfig);
        authorSelectElement.tomselectInstance = tomSelectAuthor;
        console.log("AddDocumentProcessing JS: TomSelect for Author INITIALIZED.");
    }


    // --- Головна ініціалізація ---
    OidManager.init();
    WorkRequestItemManager.init();
    DocumentTypeManager.init();

    // Обмеження для полів дат
    const processDateInput = document.getElementById('{{ form.process_date.id_for_label }}');
    const workDateInput = document.getElementById('{{ form.work_date.id_for_label }}');
    // ... (логіка для обмеження дат, якщо потрібна)

    // Переконайтесь, що URL-и для AJAX визначені (можна у <head> або перед цим скриптом)
    if (!workRequestItemsAjaxUrl || !documentTypesAjaxUrl) {
        console.error("AddDocumentProcessing JS: One or more AJAX URLs are not defined!");
    }
});
</script>
{% endblock %}