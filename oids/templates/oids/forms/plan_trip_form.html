{# oids/templates/oids/forms/plan_trip_form.html #}
{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Запланувати відрядження" }}{% endblock %}

{% block content %}
<div class="container form-container">
    <h2 class="mb-4">{{ page_title|default:"Планування нового відрядження" }}</h2>
    
    <form method="post" novalidate id="planTripForm">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
            </div>
        {% endif %}

        <fieldset class="mb-3 p-3 border rounded">
            <legend class="w-auto px-2 h6">Дати відрядження</legend>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.start_date.id_for_label }}" class="form-label fw-bold">{{ form.start_date.label }}:</label>
                    {{ form.start_date }}
                    {% for error in form.start_date.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.end_date.id_for_label }}" class="form-label fw-bold">{{ form.end_date.label }}:</label>
                    {{ form.end_date }}
                    {% for error in form.end_date.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
            </div>
        </fieldset>

        <fieldset class="mb-3 p-3 border rounded">
            <legend class="w-auto px-2 h6">Учасники та об'єкти</legend>
            <div class="mb-3">
                <label for="{{ form.units.id_for_label }}" class="form-label fw-bold">{{ form.units.label }}:</label>
                {{ form.units }}
                {% if form.units.help_text %}<small class="form-text text-muted d-block">{{ form.units.help_text }}</small>{% endif %}
                {% for error in form.units.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>

            <div class="mb-3">
                <label for="{{ form.oids.id_for_label }}" class="form-label fw-bold">{{ form.oids.label }}:</label>
                {{ form.oids }}
                {% if form.oids.help_text %}<small class="form-text text-muted d-block">{{ form.oids.help_text }}</small>{% endif %}
                {% for error in form.oids.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>

            <div class="mb-3">
                <label for="{{ form.persons.id_for_label }}" class="form-label fw-bold">{{ form.persons.label }}:</label>
                {{ form.persons }}
                {% if form.persons.help_text %}<small class="form-text text-muted d-block">{{ form.persons.help_text }}</small>{% endif %}
                {% for error in form.persons.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>
        </fieldset>

        <fieldset class="mb-3 p-3 border rounded">
            <legend class="w-auto px-2 h6">Додаткова інформація</legend>
            <div class="mb-3">
                <label for="{{ form.work_requests.id_for_label }}" class="form-label fw-bold">{{ form.work_requests.label }}:</label>
                {{ form.work_requests }}
                {% if form.work_requests.help_text %}<small class="form-text text-muted d-block">{{ form.work_requests.help_text }}</small>{% endif %}
                {% for error in form.work_requests.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.purpose.id_for_label }}" class="form-label fw-bold">{{ form.purpose.label }}:</label>
                {{ form.purpose }}
                {% if form.purpose.help_text %}<small class="form-text text-muted d-block">{{ form.purpose.help_text }}</small>{% endif %}
                {% for error in form.purpose.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>
        </fieldset>
        
        <div class="form-actions mt-4">
            <button type="submit" class="btn btn-primary">Зберегти відрядження</button>
            <a href="{% url 'oids:list_trips' %}" class="btn btn-secondary">Скасувати</a> {# Або main_dashboard #}
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Plan Trip Form JS: DOMContentLoaded. V7 Debug (Filter WorkRequests).");

    const unitsSelectElement = document.getElementById('id_trip_form_units');
    const oidsSelectElement = document.getElementById('id_trip_form_oids');
    const workRequestsSelectElement = document.getElementById('id_work_requests'); // ID вашого поля заявок

    let tomSelectUnits = null;
    let tomSelectOids = null;
    let tomSelectWorkRequests = null;

    // URL-и для AJAX (переконайтесь, що вони правильно визначені у base.html або тут)
    const oidsAjaxUrl = window.AJAX_LOAD_OIDS_FOR_MULTIPLE_UNITS_URL || "{% url 'oids:ajax_load_oids_for_multiple_units' %}";
    const workRequestsAjaxUrl = window.AJAX_LOAD_WORK_REQUESTS_FOR_OIDS_URL || "{% url 'oids:ajax_load_work_requests_for_oids' %}";
    
    console.log("Plan Trip Form JS: AJAX URL for OIDs:", oidsAjaxUrl);
    console.log("Plan Trip Form JS: AJAX URL for WorkRequests:", workRequestsAjaxUrl);

    if (typeof TomSelect === 'undefined') {
        console.error("Plan Trip Form JS: TomSelect library is NOT loaded!");
        return; 
    }
    console.log("Plan Trip Form JS: TomSelect library is loaded.");

    // Функція для ініціалізації TomSelect з базовими налаштуваннями
    function initializeGenericTomSelect(element, placeholder, allowClear = true, plugins = ['remove_button']) {
        if (!element) return null;
        console.log(`Plan Trip Form JS: Initializing TomSelect for #${element.id}`);
        const instance = new TomSelect(element, {
            plugins: plugins,
            create: false,
            placeholder: placeholder,
            allowEmptyOption: allowClear,
        });
        element.tomselectInstance = instance;
        return instance;
    }
    
    // Ініціалізація TomSelect для ВЧ
    if (unitsSelectElement && unitsSelectElement.classList.contains('tomselect-field')) {
        tomSelectUnits = initializeGenericTomSelect(unitsSelectElement, 'Оберіть ВЧ...');
    }

    // Функція для отримання конфігурації TomSelect для ОІДів
    function getOidTomSelectConfig(placeholderText = 'Оберіть...', isDisabled = true) {
        // ... (як було раніше) ...
        return {
            plugins: ['remove_button'], create: false, placeholder: placeholderText,
            valueField: 'id', labelField: 'text', searchField: ['text'],
            options: [], disabled: isDisabled, allowEmptyOption: true,
        };
    }
    
    // Початкова ініціалізація TomSelect для ОІДів (деактивований)
    if (oidsSelectElement && oidsSelectElement.classList.contains('tomselect-field')) {
        const initialOidConfig = getOidTomSelectConfig('Спочатку оберіть ВЧ...', true);
        tomSelectOids = new TomSelect(oidsSelectElement, initialOidConfig);
        oidsSelectElement.tomselectInstance = tomSelectOids;
    }

    // Ініціалізація TomSelect для Заявок (початково може бути деактивований або показувати всі)
    if (workRequestsSelectElement && workRequestsSelectElement.classList.contains('tomselect-field')) {
        tomSelectWorkRequests = initializeGenericTomSelect(workRequestsSelectElement, 'Спочатку оберіть ОІДи...', true);
        if (tomSelectWorkRequests) tomSelectWorkRequests.disable(); // Деактивуємо, поки не обрані ОІДи
    }

    // --- НОВА ФУНКЦІЯ для фільтрації Заявок ---
    function filterWorkRequestsByOids(selectedOidIds) {
        console.log("Plan Trip Form JS: filterWorkRequestsByOids called with OID IDs:", selectedOidIds);
        if (!tomSelectWorkRequests) {
            console.warn("Plan Trip Form JS: TomSelect for Work Requests not initialized. Cannot filter.");
            return;
        }

        tomSelectWorkRequests.clear();
        tomSelectWorkRequests.clearOptions();
        tomSelectWorkRequests.sync();

        if (selectedOidIds && selectedOidIds.length > 0) {
            tomSelectWorkRequests.enable();
            tomSelectWorkRequests.placeholder = 'Завантаження заявок...';

            const params = new URLSearchParams();
            selectedOidIds.forEach(id => params.append('oid_ids[]', id));
            const queryString = params.toString();
            console.log(`Plan Trip Form JS: Fetching Work Requests from: ${workRequestsAjaxUrl}?${queryString}`);

            fetch(`${workRequestsAjaxUrl}?${queryString}`)
                .then(response => {
                    console.log("Plan Trip Form JS: Work Requests fetch response status:", response.status);
                    if (!response.ok) return response.text().then(text => { throw new Error(`Network error (WorkRequests): ${response.statusText}. Server: ${text}`); });
                    return response.json();
                })
                .then(data => {
                    console.log("Plan Trip Form JS: Work Requests data received:", data); // Цей лог у вас є
                    if (!Array.isArray(data)) {
                        console.error('Plan Trip Form JS: Expected array from AJAX (WorkRequests), got:', typeof data);
                        tomSelectWorkRequests.placeholder = 'Помилка формату даних заявок';
                        tomSelectWorkRequests.refreshOptions(false);
                        return;
                    }

                    const options = data.map(wr => ({ 
                        id: wr.id.toString(), 
                        text: wr.text 
                    }));
                    console.log("Plan Trip Form JS: Mapped Work Request options for TomSelect:", options);

                    // 1. Очистити поточні обрані значення (якщо є)
                    tomSelectWorkRequests.clear(); 
                    console.log("Plan Trip Form JS: Work Requests TomSelect - called .clear()");

                    // 2. Очистити ВСІ існуючі опції зі списку
                    tomSelectWorkRequests.clearOptions(); 
                    console.log("Plan Trip Form JS: Work Requests TomSelect - called .clearOptions()");
                    
                    // 3. Додати нові, відфільтровані опції
                    if (options.length > 0) {
                        tomSelectWorkRequests.addOptions(options);
                        console.log(`Plan Trip Form JS: ${options.length} Work Request options passed to addOptions.`);
                    } else {
                        console.log("Plan Trip Form JS: No Work Request options to add (data was empty).");
                    }

                    // 4. Оновити відображення опцій у випадаючому списку
                    tomSelectWorkRequests.refreshOptions(false); 
                    console.log("Plan Trip Form JS: Work Requests TomSelect - called .refreshOptions(false).");

                    // 5. Оновити відображення обраних елементів (якщо такі є після очищення і додавання)
                    tomSelectWorkRequests.refreshItems(); // Може не знадобитися, якщо clear() вже все зробив

                    // 6. Перевірка кількості опцій в DOM (для дебагу)
                    const itemsInDropdownWR = tomSelectWorkRequests.dropdown_content.querySelectorAll('.option').length;
                    console.log(`Plan Trip Form JS: Number of .option elements in WorkRequests dropdown_content: ${itemsInDropdownWR}`);

                    tomSelectWorkRequests.placeholder = options.length > 0 ? 'Оберіть пов\'язані заявки...' : 'Заявок для обраних ОІДів не знайдено';

                    if (options.length > 0 && itemsInDropdownWR === 0) {
                        console.warn("Plan Trip Form JS (WorkRequests): Options were added, refresh called, but dropdown DOM seems empty for Work Requests.");
                    } else if (options.length > 0 && itemsInDropdownWR > 0) {
                        console.log("Plan Trip Form JS (WorkRequests): SUCCESS! Work Request options should be updated and visible.");
                    }

                })
                .catch(error => {
                    console.error("Plan Trip Form JS: Error loading Work Requests:", error);
                    tomSelectWorkRequests.placeholder = 'Помилка завантаження заявок';
                    tomSelectWorkRequests.refreshOptions(false);
                });
        } else {
            tomSelectWorkRequests.disable();
            tomSelectWorkRequests.placeholder = 'Спочатку оберіть ОІДи...';
            console.log("Plan Trip Form JS: No OIDs selected, Work Requests select disabled.");
        }
    }


    // Слухач на зміну ВЧ (як було, але тепер ми маємо `tomSelectOids` як let)
    if (tomSelectUnits && oidsSelectElement) {
        tomSelectUnits.on('change', function(selectedUnitIdsStringArray) {
            const selectedUnitIds = selectedUnitIdsStringArray.map(id => parseInt(id, 10)).filter(id => !isNaN(id));
            console.log("Plan Trip Form JS: Units selection changed. Parsed selected Unit IDs:", selectedUnitIds);
            
            if (oidsSelectElement.tomselectInstance) {
                oidsSelectElement.tomselectInstance.destroy();
                oidsSelectElement.tomselectInstance = null;
            }
            // Очищаємо також список заявок, оскільки вони залежать від ОІДів
            if (tomSelectWorkRequests) {
                tomSelectWorkRequests.clear(); tomSelectWorkRequests.clearOptions(); tomSelectWorkRequests.sync();
                tomSelectWorkRequests.disable(); tomSelectWorkRequests.placeholder = 'Спочатку оберіть ОІДи...';
            }


            if (selectedUnitIds && selectedUnitIds.length > 0) {
                const newOidConfig = getOidTomSelectConfig('Завантаження ОІДів...', false);
                tomSelectOids = new TomSelect(oidsSelectElement, newOidConfig); // Присвоюємо оновлений екземпляр
                oidsSelectElement.tomselectInstance = tomSelectOids;
                console.log("Plan Trip Form JS: oidsTomSelect RE-INITIALIZED for fetch.");

                // ... (код fetch для ОІДів, як у вашій попередній робочій версії) ...
                const params = new URLSearchParams();
                selectedUnitIds.forEach(id => params.append('unit_ids[]', id));
                const queryString = params.toString();
                fetch(`${oidsAjaxUrl}?${queryString}`)
                    .then(response => {
                        if (!response.ok) return response.text().then(text => { throw new Error(`Network error (OIDs): ${response.statusText}. Server: ${text}`); });
                        return response.json();
                    })
                    .then(data => {
                        const options = data.map(oid => ({
                            id: oid.id.toString(),
                            text: `${oid.cipher} (${oid.full_name || 'Без назви'}) - ВЧ: ${oid.unit_code}`
                        }));
                        tomSelectOids.addOptions(options);




                         tomSelectOids.refreshOptions(false); 
                        // tomSelectOids.refreshItems(); 

                        const itemsInDropdown = tomSelectOids.dropdown_content.querySelectorAll('.option').length;
                        console.log(`Plan Trip Form JS: Number of .option elements in dropdown (RECREATED instance): ${itemsInDropdown}`);

                        tomSelectOids.placeholder = options.length > 0 ? 'Оберіть ОІД(и)...' : 'Для обраних ВЧ ОІДи не знайдено';

                        if (options.length > 0 && itemsInDropdown > 0) {
                            console.log("Plan Trip Form JS: SUCCESS! Options are in dropdown DOM. Attempting to open.");
                            tomSelectOids.open(); // <--- ЯВНО ВІДКРИВАЄМО СПИСОК
                        } else if (options.length > 0 && itemsInDropdown === 0) {
                            console.warn("Plan Trip Form JS: Options were processed, but not rendered in dropdown DOM. Attempting to open anyway.");
                            tomSelectOids.open(); // <--- Спробуємо відкрити, навіть якщо DOM порожній (можливо, він оновиться при відкритті)
                        } else {
                            console.log("Plan Trip Form JS: No options to display, or dropdown already reflects this.");
                        }

                        // Додатково, переконайтеся, що елемент не деактивовано
                        if (tomSelectOids.isDisabled) {
                            console.log("Plan Trip Form JS: oidsTomSelect is disabled, enabling it.");
                            tomSelectOids.enable();
                        }
                        // Після успішного завантаження ОІДів, викликаємо фільтрацію заявок (якщо ОІДи обрані)
                        // Але краще викликати це, коли змінюється вибір У ОІДІВ
                        // filterWorkRequestsByOids(tomSelectOids.getValue()); // Можливо, передчасно
                    })
                    .catch(error => { /* ... обробка помилки ... */ });
            } else {
                // ... (логіка для деактивації tomSelectOids, як було) ...
                 if (oidsSelectElement.tomselectInstance) { // Використовуємо екземпляр, прив'язаний до елемента
                    const ts = oidsSelectElement.tomselectInstance;
                    ts.clear(); ts.clearOptions(); ts.disable();
                    ts.placeholder = 'Спочатку оберіть ВЧ...'; ts.sync();
                }
            }
        });
        // ... (ініціалізація при завантаженні, якщо ВЧ обрані, як було) ...
    }
    
    // --- НОВИЙ СЛУХАЧ: на зміну обраних ОІДів ---
    if (oidsSelectElement && oidsSelectElement.tomselectInstance) {
        // Важливо: oidsSelectElement.tomselectInstance може бути переініціалізований,
        // тому цей слухач краще додавати після кожної переініціалізації oidsTomSelect
        // АБО, якщо tomSelectOids - це завжди актуальний екземпляр, то можна так:
        // Однак, оскільки ми перестворюємо tomSelectOids, цей слухач потрібно буде додавати кожного разу
        // після new TomSelect(oidsSelectElement, newOidConfig).
        // Простіший варіант - додати його один раз і перевіряти існування oidsSelectElement.tomselectInstance
        oidsSelectElement.addEventListener('change', function() { // Слухач на оригінальний HTML select
            if (oidsSelectElement.tomselectInstance) {
                const selectedOidIds = oidsSelectElement.tomselectInstance.getValue();
                console.log("Plan Trip Form JS: OIDs selection changed. Selected OID IDs:", selectedOidIds);
                filterWorkRequestsByOids(selectedOidIds);
            }
        });
         console.log("Plan Trip Form JS: 'change' listener attached to OIDs select (for filtering WorkRequests).");
    }


    // Ініціалізація при завантаженні сторінки (для ВЧ)
    if (tomSelectUnits) { // Перевіряємо, чи tomSelectUnits ініціалізований
        const initialUnitValues = tomSelectUnits.getValue();
        if (initialUnitValues && initialUnitValues.length > 0) {
            console.log("Plan Trip Form JS: Units pre-selected on load, triggering 'change'. Values:", initialUnitValues);
            tomSelectUnits.trigger('change');
        } else {
             console.log("Plan Trip Form JS: No units pre-selected on load.");
             if (tomSelectOids) {tomSelectOids.disable(); tomSelectOids.placeholder = 'Спочатку оберіть ВЧ...';}
             if (tomSelectWorkRequests) {tomSelectWorkRequests.disable(); tomSelectWorkRequests.placeholder = 'Спочатку оберіть ОІДи...';}
        }
    }
    

    // ... (решта вашого JS, наприклад, для обмеження дат) ...
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    if (startDateInput && endDateInput) {
        startDateInput.addEventListener('change', function() { if (this.value) endDateInput.min = this.value; });
        endDateInput.addEventListener('change', function() { if (this.value) startDateInput.max = this.value; });
    }
});
</script>
{% endblock %}