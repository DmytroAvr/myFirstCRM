{% extends "oids/base.html" %}
{% load static %} {# Якщо base.html вже має load static, тут це не обов'язково #}

{% block title %}{{ page_title|default:"Запланувати відрядження" }}{% endblock %}

{% block content %}
<div class="container form-container">
    <h2 class="mb-4">{{ page_title|default:"Запланувати відрядження" }}</h2>
    
    <form method="post" novalidate>
        {% csrf_token %}
        
        {# {{ form.media }} - Розкоментуй, якщо твої віджети дат використовують JS/CSS #}

        {# Виведення загальних помилок форми #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        {# Виведення полів форми у вигляді, схожому на таблицю, або просто групами #}
        {# Варіант 1: Простий рендеринг (as_p, as_table, as_ul) #}
        {# {{ form.as_p }} #}

        {# Варіант 2: Ручний рендеринг для більшого контролю (схоже на таблицю) #}
        <div class="table-like-form">
            {% for field in form %}
                <div class="form-row mb-3">
                    <div class="form-group-label" style="font-weight: bold; padding-right: 10px; min-width: 200px; display: inline-block; vertical-align: top;">
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                    </div>
                    <div class="form-group-field" style="display: inline-block; width: calc(100% - 220px);">
                        {{ field }}
                        {% if field.help_text %}
                            <br><small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}
                        {% for error in field.errors %}
                            <div class="alert alert-danger mt-1 p-1" role="alert" style="font-size: 0.9em;">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Зберегти відрядження</button>
            <a href="{% url 'oids:main_dashboard' %}" class="btn btn-secondary">Скасувати</a>
        </div>
    </form>
</div>
{% endblock %}

{% block page_specific_js %}
<script>
$(document).ready(function() {
    // Ініціалізація Select2 для полів цієї форми, якщо вони мають клас .select2
    // initSelect2Fields($('.form-container')); // Передаємо контейнер форми як scope

    // Якщо ти будеш додавати динамічну фільтрацію ОІДів на основі обраних ВЧ
    // саме на цій формі, тут потрібно буде налаштувати filtering_dynamic.js.
    // Наприклад:
    // if (typeof initializeDynamicFilters === 'function') {
    //     const tripFormFilterConfig = [
    //         {
    //             sourceSelectSelector: '#id_trip_units_form', // ID з TripForm
    //             targetSelectSelector: '#id_trip_oids_form',   // ID з TripForm
    //             paramName: 'unit_ids[]', // Якщо units - ModelMultipleChoiceField
    //             // URL для завантаження ОІДів для кількох ВЧ (потрібен відповідний AJAX view)
    //             // url: $('#id_trip_units_form').data('ajax-url-oids-for-multiple-units') 
    //             // Або для однієї ВЧ, якщо логіка інша:
    //             // url: $('#id_trip_units_form').data('ajax-url-oids-for-unit') 
    //             placeholder: { default: 'Спочатку оберіть ВЧ', loading: 'Завантаження ОІД...', error: 'Помилка', empty: 'Немає ОІД'},
    //             transformItem: item => ({ id: item.id, text: `${item.cipher} - ${item.name || ''}` }),
    //             clearTargetsSelectors: ['#id_trip_oids_form'] 
    //         }
    //     ];
    //     // Потрібно адаптувати initializeDynamicFilters, щоб він міг приймати конфігурації
    //     // або викликати setupDynamicFilter для кожної конфігурації тут.
    //     tripFormFilterConfig.forEach(config => {
    //         if ($(config.sourceSelectSelector).length && $(config.targetSelectSelector).length) {
    //             // Переконайся, що URL встановлено в data-атрибуті
    //             const ajaxUrl = $(config.sourceSelectSelector).data('ajax-url-oids-for-multiple-units') || $(config.sourceSelectSelector).data('ajax-url-oids-for-unit');
    //             if (ajaxUrl) {
    //                 config.url = ajaxUrl;
    //                 setupDynamicFilter(config);
    //             } else {
    //                 console.warn(`URL для AJAX не знайдено на ${config.sourceSelectSelector}`);
    //             }
    //         }
    //     });
    // }
});
</script>
{% endblock %}