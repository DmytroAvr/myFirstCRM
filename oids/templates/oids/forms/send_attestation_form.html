{# oids/forms/send_attestation_form.html #}
{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container form-container">
    <h2 class="mb-4">{{ page_title }}</h2>

    <form method="post" enctype="multipart/form-data" novalidate id="sendAttestationForm">
        {% csrf_token %}
        {# {{ form.media }} #}

        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}<p class="mb-0">{{ error }}</p>{% endfor %}
            </div>
        {% endif %}

        <fieldset class="mb-3 p-3 border rounded">
            <legend class="w-auto px-2 h6">Дані вихідного листа та вибір об'єктів</legend>

            {# Явний рендеринг полів головної частини форми #}
            {% for field in form %}
                {% if field.name != 'attestation_acts' and field.name != 'oid' and field.name != 'unit' %}
                <div class="row mb-3 align-items-center">
                    <label for="{{ field.id_for_label }}" class="col-sm-3 col-form-label text-sm-end fw-bold">
                        {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}:
                    </label>
                    <div class="col-sm-9">
                        {{ field }}
                        {% if field.help_text %}<small class="form-text text-muted d-block">{{ field.help_text }}</small>{% endif %}
                        {% for error in field.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            
            {# Поле Unit #}
            <div class="row mb-3 align-items-center">
                <label for="{{ form.unit.id_for_label }}" class="col-sm-3 col-form-label text-sm-end fw-bold">
                    {{ form.unit.label }}{% if form.unit.field.required %}<span class="text-danger">*</span>{% endif %}:
                </label>
                <div class="col-sm-9">
                    {{ form.unit }}
                    {% if form.unit.help_text %}<small class="form-text text-muted d-block">{{ form.unit.help_text }}</small>{% endif %}
                    {% for error in form.unit.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
            </div>

            {# Поле OID #}
            <div class="row mb-3 align-items-center">
                <label for="{{ form.oid.id_for_label }}" class="col-sm-3 col-form-label text-sm-end fw-bold">
                    {{ form.oid.label }}{% if form.oid.field.required %}<span class="text-danger">*</span>{% endif %}:
                </label>
                <div class="col-sm-9">
                    {{ form.oid }}
                    {% if form.oid.help_text %}<small class="form-text text-muted d-block">{{ form.oid.help_text }}</small>{% endif %}
                    {% for error in form.oid.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
            </div>
        </fieldset>

        <fieldset class="mb-3 p-3 border rounded">
            <legend class="w-auto px-2 h6">Акти Атестації для відправки</legend>
            <div class="mb-3">
                <label for="{{ form.attestation_acts.id_for_label }}" class="form-label fw-bold">
                    {{ form.attestation_acts.label }}{% if form.attestation_acts.field.required %}<span class="text-danger">*</span>{% endif %}:
                </label>
                {{ form.attestation_acts }}
                {% if form.attestation_acts.help_text %}<small class="form-text text-muted d-block">{{ form.attestation_acts.help_text }}</small>{% endif %}
                {% for error in form.attestation_acts.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>
        </fieldset>

        <div class="form-actions mt-4">
            <button type="submit" class="btn btn-primary">Сформувати та зберегти відправку</button>
            <a href="{% url 'oids:list_attestation_registrations' %}" class="btn btn-secondary">Скасувати</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("SendAttestation JS: DOMContentLoaded.");

    const unitSelect = document.getElementById('id_att_reg_send_unit');
    const oidSelect = document.getElementById('id_att_reg_send_oid');
    const actsSelect = document.getElementById('id_att_reg_send_acts');
    // Інші поля TomSelect, наприклад, sent_by
    const sentBySelect = document.getElementById('{{ form.sent_by.id_for_label }}'); 
    // const unitsM2MSelect = document.getElementById('{{ form.units.id_for_label }}'); // Якщо поле units є у формі

    const oidsForUnitUrl = window.AJAX_LOAD_OIDS_FOR_UNIT_URL || "{% url 'oids:ajax_load_oids_for_unit' %}";
    const actsForOidUrl = window.AJAX_LOAD_ATTESTATION_ACTS_FOR_OID_URL || "{% url 'oids:ajax_load_attestation_acts_for_oid' %}";

    if (typeof TomSelect === 'undefined') { console.error("SendAttestation JS: TomSelect NOT loaded!"); return; }
    console.log("SendAttestation JS: TomSelect library loaded.");

    let tsUnit, tsOid, tsActs, tsSentBy; // tsUnitsM2M;

    function initTomSelect(element, placeholder, isDisabled = false, isMulti = false, initialOpts = null) {
        if (!element) { console.warn(`TomSelect init: Element not found for ${placeholder}`); return null; }
        console.log(`TomSelect init: Initializing for ${element.id}, placeholder: ${placeholder}, disabled: ${isDisabled}, multi: ${isMulti}`);
        let config = {
            plugins: isMulti ? ['remove_button'] : [],
            create: false, placeholder: placeholder, allowEmptyOption: true,
            valueField: 'id', labelField: 'text', searchField: ['text'],
            options: initialOpts || [], disabled: isDisabled
        };
        const instance = new TomSelect(element, config);
        element.tomselectInstance = instance;
        
        // Перевірка опцій після ініціалізації
        let htmlOptions = [];
        Array.from(element.options).forEach(opt => { if (opt.value) htmlOptions.push({id:opt.value, text:opt.text, selected: opt.selected});});
        const domOptsCount = instance.dropdown_content.querySelectorAll('.option').length;
        console.log(`TomSelect init: For ${element.id} - HTML opts: ${htmlOptions.length}, TS DOM opts: ${domOptsCount}`);
        if (domOptsCount === 0 && htmlOptions.length > 0) {
            console.warn(`TomSelect init: For ${element.id} - empty after init, manual add.`);
            instance.addOptions(htmlOptions);
            instance.refreshOptions(false);
            htmlOptions.forEach(opt => { if(opt.selected) instance.addItem(opt.id, true); });
            console.log(`TomSelect init: For ${element.id} - DOM opts after manual add: ${instance.dropdown_content.querySelectorAll('.option').length}`);
        }
        return instance;
    }

    // Ініціалізація основних полів
    if (unitSelect) tsUnit = initTomSelect(unitSelect, 'Оберіть ВЧ...', false, false);
    if (oidSelect) tsOid = initTomSelect(oidSelect, 'Спочатку оберіть ВЧ...', true, false);
    if (actsSelect) tsActs = initTomSelect(actsSelect, 'Спочатку оберіть ОІД...', true, true); // Multi-select
    if (sentBySelect) tsSentBy = initTomSelect(sentBySelect, 'Оберіть...', false, false);
    // if (unitsM2MSelect) tsUnitsM2M = initTomSelect(unitsM2MSelect, 'Оберіть ВЧ для листа...', false, true);


    function loadOids(unitId) {
        if (!tsOid) { console.warn("SendAttestation JS: OID TomSelect not ready for loadOids."); return; }
        tsOid.clear(); tsOid.clearOptions(); tsOid.sync();
        loadActs(null); // Очистити акти, оскільки ОІД зміниться

        if (unitId && unitId !== "") {
            tsOid.enable(); tsOid.placeholder = 'Завантаження ОІДів...';
            fetch(`${oidsForUnitUrl}?unit_id=${unitId}`)
                .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t || `Error ${r.status}`); }))
                .then(data => {
                    console.log("SendAttestation JS: OIDs for Unit received:", data);
                    const options = data.map(oid => ({ id: oid.id.toString(), text: `${oid.cipher} (${oid.full_name || 'Без назви'})` }));
                    tsOid.addOptions(options);
                    tsOid.refreshOptions(false);
                    tsOid.placeholder = options.length ? 'Оберіть ОІД...' : 'Для ВЧ немає ОІДів';
                    // Якщо є initial OID для цієї ВЧ, можна його обрати (логіка для редагування/помилок)
                }).catch(e => { console.error("SendAttestation JS: Error loading OIDs:", e); if (tsOid) tsOid.placeholder = 'Помилка завантаження ОІДів'; });
        } else {
            tsOid.disable(); tsOid.placeholder = 'Спочатку оберіть ВЧ';
        }
    }

    function loadActs(oidId) {
        if (!tsActs) { console.warn("SendAttestation JS: Acts TomSelect not ready for loadActs."); return; }
        tsActs.clear(); tsActs.clearOptions(); tsActs.sync();

        if (oidId && oidId !== "") {
            tsActs.enable(); tsActs.placeholder = 'Завантаження Актів Атестації...';
            fetch(`${actsForOidUrl}?oid_id=${oidId}`)
                .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t || `Error ${r.status}`); }))
                .then(data => {
                    console.log("SendAttestation JS: Attestation Acts for OID received:", data);
                    const options = data.map(act => ({ id: act.id.toString(), text: act.text }));
                    tsActs.addOptions(options);
                    tsActs.refreshOptions(false);
                    tsActs.placeholder = options.length ? 'Оберіть акти...' : 'Для ОІД немає доступних актів';
                }).catch(e => { console.error("SendAttestation JS: Error loading Attestation Acts:", e); if (tsActs) tsActs.placeholder = 'Помилка завантаження актів'; });
        } else {
            tsActs.disable(); tsActs.placeholder = 'Спочатку оберіть ОІД';
        }
    }

    // Слухачі подій
    if (tsUnit) {
        tsUnit.on('change', function(value) {
            console.log("SendAttestation JS: Unit changed to:", value);
            loadOids(value);
        });
        // Якщо є початкове значення для Unit, завантажуємо ОІДи
        if (tsUnit.getValue() && tsUnit.getValue() !== "") {
            loadOids(tsUnit.getValue());
        }
    }

    if (tsOid) {
        tsOid.on('change', function(value) {
            console.log("SendAttestation JS: OID changed to:", value);
            loadActs(value);
        });
        // Якщо є початкове значення для OID (і Unit також), завантажуємо Акти
        // (ця логіка спрацює, якщо `loadOids` викликає `setValue` для `tsOid`)
    }
});
</script>
{% endblock %}