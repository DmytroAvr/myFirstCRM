{# oids/forms/send_attestation_form.html #}
{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container form-container">
    <h2 class="mb-4">{{ page_title }}</h2>

    <form method="post" enctype="multipart/form-data" novalidate id="sendAttestationRegForm">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}<p class="mb-0">{{ error }}</p>{% endfor %}
            </div>
        {% endif %}

        <fieldset class="mb-3 p-3 border rounded">
            <legend class="w-auto px-2 h6">Крок 1: Оберіть Військові Частини</legend>
            <div class="mb-3">
                <label for="{{ form.selected_units.id_for_label }}" class="form-label fw-bold">{{ form.selected_units.label }}:</label>
                {{ form.selected_units }}
                {% if form.selected_units.help_text %}<small class="form-text text-muted d-block">{{ form.selected_units.help_text }}</small>{% endif %}
                {% for error in form.selected_units.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>
        </fieldset>

        <fieldset class="mb-3 p-3 border rounded">
            <legend class="w-auto px-2 h6">Крок 2: Оберіть ОІДи</legend>
            <div class="mb-3">
                <label for="{{ form.selected_oids.id_for_label }}" class="form-label fw-bold">{{ form.selected_oids.label }}:</label>
                {{ form.selected_oids }}
                {% if form.selected_oids.help_text %}<small class="form-text text-muted d-block">{{ form.selected_oids.help_text }}</small>{% endif %}
                {% for error in form.selected_oids.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>
        </fieldset>

        <fieldset class="mb-3 p-3 border rounded">
            <legend class="w-auto px-2 h6">Крок 3: Оберіть Акти Атестації для відправки</legend>
            <div class="mb-3">
                <label for="{{ form.attestation_acts_to_send.id_for_label }}" class="form-label fw-bold">{{ form.attestation_acts_to_send.label }}:</label>
                {{ form.attestation_acts_to_send }}
                {% if form.attestation_acts_to_send.help_text %}<small class="form-text text-muted d-block">{{ form.attestation_acts_to_send.help_text }}</small>{% endif %}
                {% for error in form.attestation_acts_to_send.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>
        </fieldset>

        <fieldset class="mb-3 p-3 border rounded">
            <legend class="w-auto px-2 h6">Дані вихідного супровідного листа</legend>
            {# Рендеримо решту полів форми #}
            {% for field in form %}
                {% if field.name != 'selected_units' and field.name != 'selected_oids' and field.name != 'attestation_acts_to_send' %}
                <div class="row mb-3 align-items-center">
                    <label for="{{ field.id_for_label }}" class="col-sm-3 col-form-label text-sm-end fw-bold">
                        {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}:
                    </label>
                    <div class="col-sm-9">
                        {{ field }}
                        {% if field.help_text %}<small class="form-text text-muted d-block">{{ field.help_text }}</small>{% endif %}
                        {% for error in field.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </fieldset>

        <div class="form-actions mt-4">
            <button type="submit" class="btn btn-primary">Сформувати та зберегти відправку</button>
            <a href="{% url 'oids:list_attestation_registrations' %}" class="btn btn-secondary">Скасувати</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("SendAttestationRegForm JS: DOMContentLoaded.");

    const unitsSelectorElement = document.getElementById('id_att_reg_send_units_selector');
    const oidsSelectorElement = document.getElementById('id_att_reg_send_oids_selector');
    const actsSelectorElement = document.getElementById('id_att_reg_send_acts_selector');
    const sentBySelectorElement = document.getElementById('{{ form.sent_by.id_for_label }}'); // ID з форми

    const oidsForUnitsUrl = window.AJAX_LOAD_OIDS_FOR_MULTIPLE_UNITS_URL || "{% url 'oids:ajax_load_oids_for_multiple_units' %}";
    const actsForOidsUrl = window.AJAX_LOAD_ATTESTATION_ACTS_FOR_MULTIPLE_OIDS_URL || "{% url 'oids:ajax_load_attestation_acts_for_multiple_oids' %}";

    if (typeof TomSelect === 'undefined') { console.error("SendAttestationRegForm JS: TomSelect NOT loaded!"); return; }
    console.log("SendAttestationRegForm JS: TomSelect library loaded.");

    let tsUnits, tsOids, tsActs, tsSentBy;

    function initTomSelect(element, placeholder, isDisabled = false, isMulti = true, initialOpts = []) {
        if (!element) { console.warn("TomSelect init: Element not found for placeholder:", placeholder); return null; }
        console.log(`TomSelect init: For #${element.id}. Placeholder: "${placeholder}", Disabled: ${isDisabled}, Multi: ${isMulti}`);
        let config = {
            plugins: isMulti ? ['remove_button'] : [], create: false, placeholder: placeholder,
            allowEmptyOption: !isMulti, // Для single select дозволяємо порожню опцію, для multi - ні, якщо required
            valueField: 'id', labelField: 'text', searchField: ['text'],
            options: initialOpts, disabled: isDisabled
        };
        const instance = new TomSelect(element, config);
        element.tomselectInstance = instance;
        
        let htmlOptions = [];
        Array.from(element.options).forEach(opt => { if (opt.value) htmlOptions.push({id:opt.value, text:opt.text, selected:opt.selected});});
        const domOptsCount = instance.dropdown_content.querySelectorAll('.option').length;
        if (domOptsCount === 0 && htmlOptions.length > 0 && !initialOpts.length) { // Якщо не передавали опції в config
            console.warn(`TomSelect init: #${element.id} empty, manual add.`);
            instance.addOptions(htmlOptions);
            instance.refreshOptions(false);
            htmlOptions.forEach(opt => { if(opt.selected) instance.addItem(opt.id, true); });
        }
        return instance;
    }

    // Ініціалізація
    if (unitsSelectorElement) tsUnits = initTomSelect(unitsSelectorElement, 'Оберіть ВЧ...', false, true);
    if (oidsSelectorElement) tsOids = initTomSelect(oidsSelectorElement, 'Спочатку оберіть ВЧ...', true, true);
    if (actsSelectorElement) tsActs = initTomSelect(actsSelectorElement, 'Спочатку оберіть ОІД(и)...', true, true);
    if (sentBySelectorElement) tsSentBy = initTomSelect(sentBySelectorElement, 'Оберіть...', false, false);

    function loadOidsForUnits(unitIds) {
        if (!tsOids) return;
        tsOids.clear(); tsOids.clearOptions(); tsOids.sync();
        loadActsForOids([]); // Очистити акти, бо ОІДи зміняться

        if (unitIds && unitIds.length > 0) {
            tsOids.enable(); tsOids.placeholder = 'Завантаження ОІДів...';
            const params = new URLSearchParams();
            unitIds.forEach(id => params.append('unit_ids[]', id));
            fetch(`${oidsForUnitsUrl}?${params.toString()}`)
                .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t || `Error ${r.status}`); }))
                .then(data => {
                    console.log("SendAttestationRegForm JS: OIDs for Units received:", data);
                    const options = data.map(oid => ({ id: oid.id.toString(), text: `${oid.cipher} (${oid.full_name || oid.unit_code})` }));
                    tsOids.addOptions(options);
                    tsOids.refreshOptions(false);
                    tsOids.placeholder = options.length ? 'Оберіть ОІД(и)...' : 'Для обраних ВЧ немає ОІДів';
                }).catch(e => { console.error("SendAttestationRegForm JS: Error loading OIDs:", e); if (tsOids) tsOids.placeholder = 'Помилка завантаження ОІДів';});
        } else {
            tsOids.disable(); tsOids.placeholder = 'Спочатку оберіть ВЧ';
        }
    }

    function loadActsForOids(oidIds) {
        if (!tsActs) return;
        tsActs.clear(); tsActs.clearOptions(); tsActs.sync();

        if (oidIds && oidIds.length > 0) {
            tsActs.enable(); tsActs.placeholder = 'Завантаження Актів...';
            const params = new URLSearchParams();
            oidIds.forEach(id => params.append('oid_ids[]', id));
            fetch(`${actsForOidsUrl}?${params.toString()}`)
                .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t || `Error ${r.status}`); }))
                .then(data => {
                    console.log("SendAttestationRegForm JS: Acts for OIDs received:", data);
                    const options = data.map(act => ({ id: act.id.toString(), text: act.text }));
                    tsActs.addOptions(options);
                    tsActs.refreshOptions(false);
                    tsActs.placeholder = options.length ? 'Оберіть Акти Атестації...' : 'Для обраних ОІДів немає доступних Актів';
                }).catch(e => { console.error("SendAttestationRegForm JS: Error loading Acts:", e); if (tsActs) tsActs.placeholder = 'Помилка завантаження Актів';});
        } else {
            tsActs.disable(); tsActs.placeholder = 'Спочатку оберіть ОІД(и)';
        }
    }

    // Слухачі подій
    if (tsUnits) {
        tsUnits.on('change', function(value) { // value - це масив ID
            console.log("SendAttestationRegForm JS: Units changed to:", value);
            loadOidsForUnits(value);
        });
        // Початкове завантаження ОІДів, якщо ВЧ вже обрані (наприклад, при помилці валідації)
        const initialUnits = tsUnits.getValue();
        if (initialUnits && initialUnits.length > 0) loadOidsForUnits(initialUnits);
    }

    if (tsOids) {
        tsOids.on('change', function(value) { // value - це масив ID
            console.log("SendAttestationRegForm JS: OIDs changed to:", value);
            loadActsForOids(value);
        });
        // Початкове завантаження Актів, якщо ОІДи вже обрані (складніше, бо залежить від ВЧ)
        // Можна викликати, якщо initialUnits та initialOids встановлені
    }
});
</script>
{% endblock %}