{# oids/templates/oids/forms/add_work_request_form.html #}
{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Додати заявку на проведення робіт" }}{% endblock %}

{% block content %}
<div class="container form-container">
    <h2 class="mb-4">{{ page_title|default:"Нова заявка на проведення робіт" }}</h2>

    <form method="post" novalidate id="workRequestFormWithItems">
        {% csrf_token %}

        {# === Основна інформація про заявку (WorkRequestForm) === #}
        <fieldset class="mb-4 p-3 border rounded">
            <legend class="w-auto px-2 h5">Загальна інформація</legend>
            {% if main_form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in main_form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
            </div>
            {% endif %}

            {% for field in main_form %}
            <div class="row mb-3 align-items-center">
                <label for="{{ field.id_for_label }}" class="col-sm-3 col-form-label text-sm-end fw-bold">
                    {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}:
                </label>
                <div class="col-sm-9">
                    {{ field }}
                    {% if field.help_text %}<small class="form-text text-muted d-block">{{ field.help_text }}</small>{% endif %}
                    {% for error in field.errors %}
                    <div class="alert alert-danger mt-1 p-1 py-0" role="alert" style="font-size: 0.9em;">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </fieldset>

        {# === Елементи заявки (WorkRequestItemFormSet) === #}
		<legend class="w-auto px-2 h5">ОІДи та роботи в заявці</legend>
        <fieldset class="mb-4 p-3 border rounded">
            {{ formset.management_form }} {# Дуже важливо для роботи формсетів! #}
            
            {% if formset.non_form_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in formset.non_form_errors %}<p>{{ error }}</p>{% endfor %}
            </div>
            {% endif %}

            <div id="work-request-items-container">
                {% for item_form in formset.forms %}
                <div class="work-request-item-form mb-3 p-2 border rounded" {% if forloop.first and not item_form.initial %}style="background-color: #f8f9fa;"{% endif %}>
                    {% if item_form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for error in item_form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="row g-2">
                        {% for hidden_field in item_form.hidden_fields %}{{ hidden_field }}{% endfor %}
                        
                        {% with field=item_form.oid %}
                        <div class="col-md-5">
                            <label for="{{ field.id_for_label }}" class="form-label visually-hidden">{{ field.label }}</label>
                            {{ field }} {# віджет вже має клас 'form-select tomselect-oid-item' #}
                            {% for error in field.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                        </div>
                        {% endwith %}

                        {% with field=item_form.work_type %}
                        <div class="col-md-4">
                             <label for="{{ field.id_for_label }}" class="form-label visually-hidden">{{ field.label }}</label>
                            {{ field }} {# віджет вже має клас 'form-select' #}
                            {% for error in field.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                        </div>
                        {% endwith %}
                        
                        <div class="col-md-2">
                             {% if item_form.instance.pk or formset.forms|length > 1 and formset.can_delete %} 
                                {% with field=item_form.DELETE %}
                                <div class="form-check mt-3">
                                    {{ field }}
                                    <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
                                </div>
                                {% endwith %}
                            {% endif %}
                        </div>
                        <div class="col-md-1">
                             <button type="button" class="btn btn-sm btn-success add-oid-modal-per-row" title="Створити новий ОІД для цієї ВЧ">
                                <i class="fas fa-plus"></i> +
                            </button>
                        </div>
                    </div>
                     {% if item_form.oid.help_text or item_form.work_type.help_text %}
                        <small class="form-text text-muted d-block mt-1">
                            {% if item_form.oid.help_text %} {{ item_form.oid.help_text }} {% endif %}
                            {% if item_form.work_type.help_text %} {{ item_form.work_type.help_text }} {% endif %}
                        </small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-work-request-item" class="btn btn-outline-success btn-sm mt-2">
                <i class="fas fa-plus"></i> Додати ще ОІД/роботу
            </button>
        </fieldset>

        <div class="form-actions mt-4">
            <button type="submit" class="btn btn-primary">Зберегти заявку</button>
            <a href="{% url 'oids:list_work_requests' %}" class="btn btn-secondary">Скасувати</a>
        </div>
    </form>

    {# Шаблон для нової форми формсету (буде використовуватися JavaScript) #}
    <template id="work-request-item-empty-form-template">
        {% spaceless %}
        {% with item_form=formset.empty_form %}
        <div class="work-request-item-form mb-3 p-2 border rounded" style="background-color: #f8f9fa;">
            <div class="row g-2 ">
                {% for hidden_field in item_form.hidden_fields %}{{ hidden_field }}{% endfor %}
                {% with field=item_form.oid %}
                <div class="col-md-5">
                    <label for="{{ field.id_for_label }}" class="form-label visually-hidden">{{ field.label }}</label>
                    {{ field }}
                </div>
                {% endwith %}
                {% with field=item_form.work_type %}
                <div class="col-md-4">
                    <label for="{{ field.id_for_label }}" class="form-label visually-hidden">{{ field.label }}</label>
                    {{ field }}
                </div>
                {% endwith %}
                <div class="col-md-2 form-item-delete-button-container">
                    {# Кнопка видалення з'явиться, якщо форм більше однієї #}
					{# Сюди JavaScript додасть кнопку "Видалити" або поле DELETE #}
                </div>			
                <div class="col-md-1">
                     <button type="button" class="btn btn-sm btn-success add-oid-modal-per-row" title="Створити новий ОІД для цієї ВЧ">
                        <i class="fas fa-plus"></i> +
                    </button>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endspaceless %}
    </template>
</div>
{% endblock %}

{# oids/templates/oids/forms/add_work_request_form.html #}
{# ... (початок вашого шаблону) ... #}

{% block extra_js %}
<script>
// JavaScript модуль для управління формсетом WorkRequestItem
const WorkRequestItemFormsetManager = (function() {
    // ... (початок вашого модуля WorkRequestItemFormsetManager, як і раніше) ...
    let unitSelectElement;
    let itemsContainer;
    let addButton;
    let emptyFormTemplateHtml;
    let totalFormsInput;
    let formsetPrefix;
    let maxFormsCount;
    let minFormsCount;
    let canDeleteForms;
    let currentSelectedUnitId = null;

    const OID_SELECT_CLASS = 'tomselect-oid-item';

    function getTomSelectDefaultOptions(placeholderText = 'Оберіть...') {
        return {
            create: false,
            placeholder: placeholderText,
            valueField: 'id',
            labelField: 'text',
            searchField: ['text'],
            disabled: true,
            options: [],
            allowEmptyOption: true,
        };
    }

    function initializeTomSelectForOid(selectElement, unitId) {
        if (!selectElement || typeof TomSelect === 'undefined') {
            console.warn("Formset JS: TomSelect library not loaded or selectElement missing for OID init.");
            return null;
        }
        let placeholder = 'Спочатку оберіть ВЧ';
        let isDisabled = true;
        if (unitId) {
            placeholder = 'Оберіть ОІД...';
            isDisabled = false;
        }
        const config = getTomSelectDefaultOptions(placeholder);
        config.disabled = isDisabled;

        if (selectElement.tomselectInstance) {
            console.log("Formset JS: Destroying existing TomSelect for OID:", selectElement.id);
            selectElement.tomselectInstance.destroy();
        }
        const tomSelect = new TomSelect(selectElement, config);
        selectElement.tomselectInstance = tomSelect;
        console.log(`Formset JS: Initialized TomSelect for OID: [${selectElement.id}] for Unit ID: [${unitId || 'None'}]`);

        if (unitId) {
            loadOidOptions(tomSelect, unitId, selectElement.dataset.currentOidValue || null);
        }
        return tomSelect;
    }

    function loadOidOptions(tomSelectInstance, unitId, selectedOidValue = null) {
        if (!tomSelectInstance || !unitId) {
            if (tomSelectInstance) {
                tomSelectInstance.clear(); tomSelectInstance.clearOptions();
                tomSelectInstance.disable(); tomSelectInstance.placeholder = 'Спочатку оберіть ВЧ';
                tomSelectInstance.sync();
            }
            console.warn("Formset JS: loadOidOptions - No TomSelect instance or no Unit ID. Unit ID:", unitId);
            return;
        }
        console.log(`Formset JS: (Direct Fetch) Loading OID options for TomSelect (ID: ${tomSelectInstance.input.id}), Unit ID: [${unitId}]`);

        tomSelectInstance.enable();
        tomSelectInstance.placeholder = 'Завантаження ОІДів...';
        tomSelectInstance.clear(); tomSelectInstance.clearOptions(); tomSelectInstance.sync();

        let ajaxUrl = window.AJAX_LOAD_OIDS_FOR_UNIT_URL || "{% url 'oids:ajax_load_oids_for_unit' %}";
        console.log(`Formset JS: (Direct Fetch) FINAL ajaxUrl for fetch: [${ajaxUrl}], unit_id: [${unitId}]`);

        if (!ajaxUrl || ajaxUrl.includes("None") || ajaxUrl.trim() === "" || ajaxUrl.trim() === "null" || ajaxUrl.startsWith('{')) {
            console.error('Formset JS: AJAX URL for OIDs is invalid or not resolved:', ajaxUrl);
            tomSelectInstance.placeholder = 'Помилка: Невірний URL';
            return;
        }

        fetch(`${ajaxUrl}?unit_id=${unitId}`)
            .then(response => {
                console.log('Formset JS: (Direct Fetch) Fetch response status for OIDs:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Network error (OIDs): ${response.status} ${response.statusText}. Server: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Formset JS: (Direct Fetch) AJAX data received for OIDs:', data);
                if (!Array.isArray(data)) {
                    console.error('Formset JS: (Direct Fetch) Expected array from AJAX (OIDs), got:', typeof data, data);
                    tomSelectInstance.placeholder = 'Помилка: невірний формат даних';
                    return;
                }
                const options = data.map(oid => ({
                    id: oid.id.toString(),
                    text: `${oid.cipher} (${oid.full_name || 'Без назви'})`
                }));
                console.log('Formset JS: (Direct Fetch) Mapped options for OID TomSelect:', options);
                
                tomSelectInstance.addOptions(options); // Додаємо опції
                console.log(`Formset JS: (Direct Fetch) ${options.length} options ADDED to TomSelect [${tomSelectInstance.input.id}].`);

                // Після додавання опцій, перевіримо, чи вони дійсно є в TomSelect
                const currentTomSelectOptions = tomSelectInstance.options;
                console.log(`Formset JS: (Direct Fetch) Options currently IN TomSelect [${tomSelectInstance.input.id}]:`, JSON.parse(JSON.stringify(currentTomSelectOptions)));


                tomSelectInstance.placeholder = options.length > 0 ? 'Оберіть ОІД...' : 'ОІДи для цієї ВЧ не знайдено';
                if (selectedOidValue) {
                    console.log("Formset JS: (Direct Fetch) Attempting to restore OID selection:", selectedOidValue, "for TomSelect:", tomSelectInstance.input.id);
                    tomSelectInstance.addItem(selectedOidValue.toString(), true); // true - silent
                }
                 tomSelectInstance.refreshOptions(false); // Примусове оновлення може допомогти
                 tomSelectInstance.refreshItems();      // І оновлення обраних елементів
            })
            .catch((error) => {
                console.error("Formset JS: (Direct Fetch) CATCH block - Error during AJAX load for OIDs:", error);
                tomSelectInstance.placeholder = 'Помилка завантаження ОІДів';
            });
    }

    function updateAllOidSelects(unitId) {
        console.log("Formset JS: Updating all OID selects for Unit ID:", unitId);
        currentSelectedUnitId = unitId;
        const oidSelects = itemsContainer.querySelectorAll(`select.${OID_SELECT_CLASS}`);
        oidSelects.forEach(select => {
            const currentValue = select.tomselectInstance ? select.tomselectInstance.getValue() : select.dataset.currentOidValue;
            // Переініціалізація може бути надмірною, спробуємо просто завантажити опції
            if (select.tomselectInstance) {
                 loadOidOptions(select.tomselectInstance, unitId, currentValue);
            } else {
                initializeTomSelectForOid(select, unitId); // Якщо ще не було ініціалізовано
            }
        });
    }

    function addForm() {
        console.log("Formset JS: Add button clicked.");
        const currentFormCount = itemsContainer.querySelectorAll('.work-request-item-form').length;
        
        if (maxFormsCount && currentFormCount >= maxFormsCount) {
            alert(`Максимальна кількість елементів (${maxFormsCount}) вже досягнута.`);
            return;
        }

        const newFormHtml = emptyFormTemplateHtml.replace(/__prefix__/g, currentFormCount);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        const newFormElement = tempDiv.firstElementChild;

        itemsContainer.appendChild(newFormElement);
        totalFormsInput.value = currentFormCount + 1;
        console.log("Formset JS: New form added. Total forms now:", totalFormsInput.value);

        const newOidSelect = newFormElement.querySelector(`select.${OID_SELECT_CLASS}`);
        if (newOidSelect) {
            initializeTomSelectForOid(newOidSelect, currentSelectedUnitId);
        }
        
        addDeleteButtonIfNeeded(newFormElement, currentFormCount);
        updateDeleteButtonsVisibility();

        const newCreateOidBtn = newFormElement.querySelector('.add-oid-modal-per-row');
        if (newCreateOidBtn) {
            newCreateOidBtn.addEventListener('click', handleShowCreateOidModalForRow);
        }
    }
    
    function addDeleteButtonIfNeeded(formElement, formIndex) {
        const deleteButtonContainer = formElement.querySelector('.form-item-delete-button-container');
        if (!deleteButtonContainer) {
            console.warn("Formset JS: Delete button container not found in form for index:", formIndex, formElement);
            return;
        }
        deleteButtonContainer.innerHTML = ''; 
        
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.classList.add('btn', 'btn-danger', 'btn-sm', 'remove-item-button'); // Додав mt-3 для відступу
        removeButton.innerHTML = '<i class="fas fa-trash" aria-hidden="true"></i>видалити'; // Тільки іконка для компактності
        removeButton.title = 'Видалити цей елемент';
        deleteButtonContainer.appendChild(removeButton);
        console.log("Formset JS: Added delete button to form index:", formIndex);

        // Коректне формування імені для поля DELETE
        const deleteInputName = `${formsetPrefix}-${formIndex}-DELETE`;
        // console.log("Formset JS: Searching for DELETE input with name:", deleteInputName); // DEBUG
        let deleteInput = formElement.querySelector(`input[name="${deleteInputName}"]`);
        if (deleteInput) {
            // console.log("Formset JS: Found DELETE input:", deleteInput); // DEBUG
            deleteInput.style.display = 'none'; // Приховуємо стандартний чекбокс, якщо він рендериться Django
        } else {
            // console.log("Formset JS: DELETE input not found by Django, could be created if needed for new forms not yet saved.");
        }
    }

    function removeForm(event) {
        // ... (код функції removeForm, як був, але переконайтесь, що він правильно оновлює TOTAL_FORMS та індекси) ...
        // Основна зміна в removeForm - це перенумерація після видалення НОВОЇ форми
        const clickedButton = event.target.closest('.remove-item-button');
        if (!clickedButton) return;

        console.log("Formset JS: Remove button clicked.");
        const itemFormToRemove = clickedButton.closest('.work-request-item-form');
        if (itemFormToRemove) {
            const deleteInput = itemFormToRemove.querySelector('input[type="checkbox"][name$="-DELETE"]');
            
            if (deleteInput && itemFormToRemove.dataset.isSaved === 'true') {
                console.log("Formset JS: Marking existing form for deletion.");
                deleteInput.checked = true;
                itemFormToRemove.style.display = 'none'; // Приховуємо форму
            } else {
                console.log("Formset JS: Removing new/unsaved form from DOM.");
                const oidSelect = itemFormToRemove.querySelector(`select.${OID_SELECT_CLASS}`);
                if (oidSelect && oidSelect.tomselectInstance) {
                    console.log("Formset JS: Destroying TomSelect for OID in removed form:", oidSelect.id);
                    oidSelect.tomselectInstance.destroy();
                }
                itemFormToRemove.remove();
                
                // Перенумерувати форми та оновити TOTAL_FORMS
                let currentVisibleFormIndex = 0;
                itemsContainer.querySelectorAll('.work-request-item-form').forEach((form) => {
                    // Оновлюємо тільки ті форми, які ще не позначені на видалення (не мають deleteInput.checked)
                    // або ті, які не мають deleteInput (нові, ще не збережені)
                    const currentDeleteInput = form.querySelector('input[type="checkbox"][name$="-DELETE"]');
                    if (!currentDeleteInput || !currentDeleteInput.checked) {
                        const oldPrefixPattern = new RegExp(`${formsetPrefix}-\\d+`, 'g');
                        const newPrefix = `${formsetPrefix}-${currentVisibleFormIndex}`;
                        
                        form.querySelectorAll('input, select, textarea, label').forEach(el => {
                            ['name', 'id', 'for'].forEach(attr => {
                                const currentAttrVal = el.getAttribute(attr);
                                if (currentAttrVal && currentAttrVal.includes(`${formsetPrefix}-`)) {
                                    el.setAttribute(attr, currentAttrVal.replace(oldPrefixPattern, newPrefix));
                                }
                            });
                         });
                        currentVisibleFormIndex++;
                    }
                });
                totalFormsInput.value = currentVisibleFormIndex; // Кількість НЕ видалених форм
                console.log("Formset JS: TOTAL_FORMS updated after DOM removal to:", totalFormsInput.value);
            }
            updateDeleteButtonsVisibility();
        }
    }
    
    function updateDeleteButtonsVisibility() {
        const visibleForms = Array.from(itemsContainer.querySelectorAll('.work-request-item-form'))
                                 .filter(form => {
                                     const deleteInput = form.querySelector('input[type="checkbox"][name$="-DELETE"]');
                                     return !deleteInput || !deleteInput.checked; // Видимі, якщо не позначені на видалення
                                 });
        console.log("Formset JS: Updating delete buttons. Visible forms:", visibleForms.length, "Min forms:", minFormsCount);
        
        visibleForms.forEach((form) => {
            const deleteButton = form.querySelector('.remove-item-button');
            if (deleteButton) {
                if (visibleForms.length > minFormsCount) {
                    deleteButton.style.display = 'inline-block';
                } else {
                    deleteButton.style.display = 'none';
                }
            }
        });
         // Додатково, якщо є форми, позначені на видалення, але minFormsCount вимагає їх наявності,
         // то кнопка видалення на останній видимій формі теж має бути прихована.
         // Це складніший сценарій, поки що зосередимось на базовій логіці.
    }
    

    function init() {
        // ... (код init, як був, але переконайтесь, що minFormsCount та canDeleteForms встановлюються правильно) ...
        console.log("Formset JS: Initializing WorkRequestItemFormsetManager.");
        unitSelectElement = document.getElementById('{{ main_form.unit.id_for_label }}');
        itemsContainer = document.getElementById('work-request-items-container');
        addButton = document.getElementById('add-work-request-item');
        const templateElement = document.getElementById('work-request-item-empty-form-template');
        
        if (!itemsContainer || !addButton || !templateElement || !unitSelectElement) {
            console.warn("Formset JS: Required elements for formset management not found.");
            return;
        }
        emptyFormTemplateHtml = templateElement.innerHTML;
        
        formsetPrefix = '{{ formset.prefix }}'; // 'items'
        totalFormsInput = document.getElementById(`id_${formsetPrefix}-TOTAL_FORMS`);
        const minFormsInputElement = document.getElementById(`id_${formsetPrefix}-MIN_NUM_FORMS`);
        const maxFormsInputElement = document.getElementById(`id_${formsetPrefix}-MAX_NUM_FORMS`);
        
        minFormsCount = minFormsInputElement ? parseInt(minFormsInputElement.value) : 0;
        maxFormsCount = maxFormsInputElement ? parseInt(maxFormsInputElement.value) : 1000; 
        canDeleteForms = "{{ formset.can_delete|yesno:'true,false' }}" === 'true';

        console.log(`Formset JS: Prefix: [${formsetPrefix}], TOTAL_FORMS_INPUT:`, totalFormsInput, `MIN_NUM: [${minFormsCount}], MAX_NUM: [${maxFormsCount}], CAN_DELETE: [${canDeleteForms}]`);
        if (!totalFormsInput) {
            console.error("Formset JS: TOTAL_FORMS input not found!");
            return;
        }

        itemsContainer.querySelectorAll('.work-request-item-form').forEach((form, index) => {
            const oidSelect = form.querySelector(`select.${OID_SELECT_CLASS}`);
            if (oidSelect) {
                oidSelect.dataset.currentOidValue = oidSelect.value;
                initializeTomSelectForOid(oidSelect, unitSelectElement.value);
            }
            const createOidBtn = form.querySelector('.add-oid-modal-per-row');
            if (createOidBtn) {
                createOidBtn.addEventListener('click', handleShowCreateOidModalForRow);
            }
            if (form.querySelector(`input[name$="-id"][value]`)) {
                form.dataset.isSaved = 'true';
            }
            addDeleteButtonIfNeeded(form, index);
        });

        addButton.addEventListener('click', addForm);
        itemsContainer.addEventListener('click', removeForm); 
        
        if (unitSelectElement) {
            currentSelectedUnitId = unitSelectElement.value;
            unitSelectElement.addEventListener('change', function() {
                updateAllOidSelects(this.value);
            });
            if (currentSelectedUnitId) {
                updateAllOidSelects(currentSelectedUnitId);
            }
        }
        updateDeleteButtonsVisibility();

       
    } // Кінець init

    return {
        init: init
    };
})(); // Кінець WorkRequestItemFormsetManager

document.addEventListener('DOMContentLoaded', function() {
    console.log("Add Work Request Form JS: DOMContentLoaded - Starting initializations. V3");
    const mainUnitSelect = document.getElementById('{{ main_form.unit.id_for_label }}');
    if (mainUnitSelect && mainUnitSelect.classList.contains('tomselect-main-unit') && typeof TomSelect !== 'undefined') {
        new TomSelect(mainUnitSelect, {
            create: false, placeholder: 'Оберіть ВЧ...', allowEmptyOption: true,
        });
        console.log("Add Work Request Form JS: TomSelect for main Unit initialized.");
    } else {
        console.warn("Add Work Request Form JS: TomSelect for main Unit NOT initialized.");
    }
    
    WorkRequestItemFormsetManager.init(); // Запускаємо менеджер формсету

    if (typeof window.AJAX_LOAD_OIDS_FOR_UNIT_URL === 'undefined') {
        let djangoUrl = "{% url 'oids:ajax_load_oids_for_unit' %}";
        if (djangoUrl && !djangoUrl.includes("None") && djangoUrl.trim() !== "" && !djangoUrl.startsWith('{')) {
            window.AJAX_LOAD_OIDS_FOR_UNIT_URL = djangoUrl;
        } else {
            console.error("Add Work Request Form JS: Fallback Django URL for AJAX_LOAD_OIDS_FOR_UNIT_URL is invalid! Value: " + djangoUrl);
        }
    }
    console.log("Add Work Request Form JS: AJAX_LOAD_OIDS_FOR_UNIT_URL is:", window.AJAX_LOAD_OIDS_FOR_UNIT_URL);
});
</script>

{% endblock %}