{# oids/templates/oids/forms/add_work_request_form.html #} {# ... (початок вашого шаблону до блоку extra_js) ... #} {% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Отримуємо ID полів з Django форми
        const unitSelectElement = document.getElementById("{{ form.unit.id_for_label }}");
        const oidsSelectElement = document.getElementById("{{ form.oids.id_for_label }}");
        const showCreateOidModalButton = document.getElementById("showCreateOidModalBtn"); // ID кнопки з вашого шаблону

        // Модальне вікно для створення ОІД (з base.html)
        const oidCreateModalElement = document.getElementById("createOidModal");
        let oidCreateModalInstance = null;
        if (oidCreateModalElement) {
            oidCreateModalInstance = new bootstrap.Modal(oidCreateModalElement);
        }
        const modalSelectedUnitNameElement = document.getElementById("modalSelectedUnitName"); // З base.html
        const modalHiddenUnitIdInput = document.getElementById("id_modal_hidden_unit_id"); // З base.html

        let tomSelectUnits = null;
        let tomSelectOids = null;

        // 1. Ініціалізація Tom Select для поля "Військова частина"
        if (unitSelectElement && unitSelectElement.classList.contains("tomselect-field-defer") && typeof TomSelect !== "undefined") {
            tomSelectUnits = new TomSelect(unitSelectElement, {
                create: false,
                placeholder: "Оберіть ВЧ...",
                allowEmptyOption: true,
                // Можна додати опцію завантаження через AJAX, якщо ВЧ дуже багато:
                // load: function(query, callback) { ... }
            });
        }

        // 2. Ініціалізація Tom Select для поля "Оберіть ОІД"
        if (oidsSelectElement && oidsSelectElement.classList.contains("tomselect-field-oids") && typeof TomSelect !== "undefined") {
            tomSelectOids = new TomSelect(oidsSelectElement, {
                create: false, // Створення ОІДів через модальне вікно
                plugins: ["remove_button"],
                placeholder: "Спочатку оберіть ВЧ...",
                valueField: "id",
                labelField: "text",
                searchField: ["text"],
                options: [], // Початково опції порожні
                disabled: !unitSelectElement?.value, // Деактивовано, якщо ВЧ не обрано
                render: {
                    // Можна кастомізувати вигляд опцій, якщо потрібно
                    // option: function(data, escape) {
                    //     return `<div>${escape(data.text)}</div>`;
                    // }
                },
            });
            // Зберігаємо екземпляр для доступу, якщо потрібно
            oidsSelectElement.tomselectInstance = tomSelectOids;
        }

        // 3. Динамічне завантаження ОІДів при зміні Військової частини
        if (unitSelectElement && tomSelectOids) {
            unitSelectElement.addEventListener("change", function () {
                const unitId = this.value;
                tomSelectOids.clear(); // Очистити обрані значення
                tomSelectOids.clearOptions(); // Очистити всі опції
                tomSelectOids.sync(); // Синхронізувати стан

                if (unitId) {
                    tomSelectOids.enable();
                    tomSelectOids.load(function (callback) {
                        const ajaxUrl = window.AJAX_LOAD_OIDS_FOR_UNIT_URL || "{% url 'oids:ajax_load_oids_for_unit' %}";
                        fetch(`${ajaxUrl}?unit_id=${unitId}`)
                            .then((response) => response.json())
                            .then((data) => {
                                // `data` має бути масивом об'єктів {id: ..., cipher: ..., full_name: ...}
                                // Ми перетворюємо його на формат, очікуваний TomSelect: {id: ..., text: ...}
                                const options = data.map((oid) => ({
                                    id: oid.id,
                                    text: `${oid.cipher} (${oid.full_name || "Без назви"})`,
                                }));
                                callback(options);
                                // Після завантаження можна відновити раніше обрані значення, якщо вони є
                                // Це важливо, якщо форма повертається з помилкою валідації.
                                // Потрібно передати старі значення `oids` з Django в JS.
                            })
                            .catch(() => {
                                tomSelectOids.addOption({ id: "", text: "Помилка завантаження ОІДів" });
                                callback(); // Завершити завантаження, навіть якщо з помилкою
                            });
                    });
                    tomSelectOids.placeholder = "Оберіть ОІД(и)...";
                } else {
                    tomSelectOids.disable();
                    tomSelectOids.placeholder = "Спочатку оберіть ВЧ...";
                }
            });

            // Якщо ВЧ вже обрана при завантаженні сторінки (наприклад, при помилці валідації форми),
            // ініціюємо завантаження ОІДів.
            if (unitSelectElement.value) {
                unitSelectElement.dispatchEvent(new Event("change"));
            }
        }

        // 4. Обробка відкриття модального вікна для створення ОІД
        if (showCreateOidModalButton && oidCreateModalInstance && unitSelectElement) {
            showCreateOidModalButton.addEventListener("click", function () {
                const selectedUnitValue = unitSelectElement.value;
                if (!selectedUnitValue) {
                    alert("Будь ласка, спочатку оберіть Військову частину.");
                    return;
                }

                const oidCreateFormElement = document.getElementById("ajaxOidCreateForm"); // з base.html
                const oidCreateFormAlertsElement = document.getElementById("oidCreateFormAlertsBootstrap"); // з base.html

                if (oidCreateFormElement) oidCreateFormElement.reset();
                if (oidCreateFormAlertsElement) oidCreateFormAlertsElement.innerHTML = "";

                if (modalSelectedUnitNameElement) {
                    const selectedUnitOption = unitSelectElement.options[unitSelectElement.selectedIndex];
                    modalSelectedUnitNameElement.textContent = selectedUnitOption ? selectedUnitOption.text : "не обрано";
                }
                if (modalHiddenUnitIdInput) {
                    modalHiddenUnitIdInput.value = selectedUnitValue;
                }

                // Очищення попередніх помилок валідації в модальній формі
                if (oidCreateFormElement) {
                    oidCreateFormElement.querySelectorAll(".is-invalid").forEach((el) => el.classList.remove("is-invalid"));
                    oidCreateFormElement.querySelectorAll(".invalid-feedback[data-field-errors-bs]").forEach((el) => (el.textContent = ""));
                }
                oidCreateModalInstance.show();
            });
        }

        // 5. Обробка успішного створення ОІД у модальному вікні
        // Ми очікуємо, що ваш глобальний main.js (або логіка в base.html для модалки)
        // згенерує подію на `oidCreateModalElement` після успішного AJAX запиту.
        if (oidCreateModalElement && tomSelectOids) {
            oidCreateModalElement.addEventListener("oid.created.success", function (event) {
                const newOidData = event.detail; // { oid_id: ..., oid_name: ..., unit_id: ... }

                if (newOidData && newOidData.oid_id && newOidData.oid_name) {
                    // Перевіряємо, чи створений ОІД належить до поточно обраної ВЧ
                    const currentUnitId = unitSelectElement.value;
                    if (newOidData.unit_id && newOidData.unit_id.toString() === currentUnitId) {
                        tomSelectOids.addOption({
                            id: newOidData.oid_id.toString(), // TomSelect очікує id як string
                            text: newOidData.oid_name,
                        });
                        tomSelectOids.addItem(newOidData.oid_id.toString()); // Додати та обрати
                    } else {
                        // Якщо ОІД створено для іншої ВЧ (малоймовірно при поточній логіці модалки, але для безпеки)
                        // або якщо ВЧ не обрана в основній формі, просто оновити список опцій,
                        // щоб він міг з'явитися, якщо користувач обере відповідну ВЧ.
                        // Це складніший сценарій, поки що просто інформуємо.
                        console.warn("Новий ОІД створено, але він не належить до поточно обраної ВЧ або ВЧ не обрано.");
                        // Можна викликати unitSelectElement.dispatchEvent(new Event('change')); щоб оновити список ОІДів
                    }
                    if (oidCreateModalInstance) oidCreateModalInstance.hide();
                }
            });
            // Обробка помилок з модального вікна (якщо main.js генерує подію)
            oidCreateModalElement.addEventListener("oid.created.error", function (event) {
                const errors = event.detail.errors;
                const formInModal = document.getElementById("ajaxOidCreateForm");
                const alertsInModal = document.getElementById("oidCreateFormAlertsBootstrap");
                if (formInModal && alertsInModal) {
                    let errorMessages = "<ul>";
                    for (const field in errors) {
                        const fieldElement = formInModal.querySelector(`[name="${field}"]`);
                        if (fieldElement) fieldElement.classList.add("is-invalid");
                        const errorContainer = formInModal.querySelector(`.invalid-feedback[data-field-errors-bs="${field}"]`);
                        if (errorContainer) errorContainer.textContent = errors[field].join(" ");

                        errors[field].forEach((err) => {
                            errorMessages += `<li>${field}: ${err}</li>`;
                        });
                    }
                    errorMessages += "</ul>";
                    alertsInModal.innerHTML = `<div class="alert alert-danger">${errorMessages}</div>`;
                }
            });
        }

        // Переконайтесь, що глобальна змінна AJAX_LOAD_OIDS_FOR_UNIT_URL визначена (наприклад, у base.html)
        if (typeof window.AJAX_LOAD_OIDS_FOR_UNIT_URL === "undefined") {
            // Якщо ні, можна встановити її тут як резервний варіант, АЛЕ КРАЩЕ ПЕРЕДАВАТИ З DJANGO
            console.warn("AJAX_LOAD_OIDS_FOR_UNIT_URL не визначено глобально. Використовується резервний URL.");
            window.AJAX_LOAD_OIDS_FOR_UNIT_URL = "{% url 'oids:ajax_load_oids_for_unit' %}";
        }
    });
</script>
{% endblock %}
