{# oids/templates/oids/forms/add_work_request_form.html #}
{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Додати заявку на проведення робіт" }}{% endblock %}

{% block content %}
<div class="container form-container">
    <h2 class="mb-4">{{ page_title|default:"Нова заявка на проведення робіт" }}</h2>

    <form method="post" novalidate id="mainWorkRequestForm"> {# Додав ID формі #}
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            {% for error in form.non_field_errors %}
            <p>{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}

        <div class="table-like-form">
            {# Поле Військова частина (Unit) #}
            {% with field=form.unit %}
            <div class="form-row mb-3">
                <div class="form-group-label" style="font-weight: bold; padding-right: 10px; min-width: 250px; display: inline-block; vertical-align: top;">
                    <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                    {% if field.field.required %}<span style="color: red;">*</span>{% endif %}
                </div>
                <div class="form-group-field" style="display: inline-block; width: calc(100% - 270px);">
                    {{ field }} {# Віджет вже має клас 'form-select tomselect-field-defer' з форми #}
                    {% if field.help_text %}<br><small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                    {% for error in field.errors %}<div class="alert alert-danger mt-1 p-1" role="alert" style="font-size: 0.9em;">{{ error }}</div>{% endfor %}
                </div>
            </div>
            {% endwith %}

            {# Поле Вхідний номер заявки #}
            {% with field=form.incoming_number %}
             <div class="form-row mb-3">
                <div class="form-group-label" style="font-weight: bold; padding-right: 10px; min-width: 250px; display: inline-block; vertical-align: top;">
                    <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                    {% if field.field.required %}<span style="color: red;">*</span>{% endif %}
                </div>
                <div class="form-group-field" style="display: inline-block; width: calc(100% - 270px);">
                    {{ field }}
                    {% if field.help_text %}<br><small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                    {% for error in field.errors %}<div class="alert alert-danger mt-1 p-1" role="alert" style="font-size: 0.9em;">{{ error }}</div>{% endfor %}
                </div>
            </div>
            {% endwith %}

            {# Поле Вхідна дата заявки #}
            {% with field=form.incoming_date %}
             <div class="form-row mb-3">
                <div class="form-group-label" style="font-weight: bold; padding-right: 10px; min-width: 250px; display: inline-block; vertical-align: top;">
                    <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                    {% if field.field.required %}<span style="color: red;">*</span>{% endif %}
                </div>
                <div class="form-group-field" style="display: inline-block; width: calc(100% - 270px);">
                    {{ field }}
                    {% if field.help_text %}<br><small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                    {% for error in field.errors %}<div class="alert alert-danger mt-1 p-1" role="alert" style="font-size: 0.9em;">{{ error }}</div>{% endfor %}
                </div>
            </div>
            {% endwith %}
            
            {# Поле Запитуваний тип роботи #}
            {% with field=form.request_work_type %}
             <div class="form-row mb-3">
                <div class="form-group-label" style="font-weight: bold; padding-right: 10px; min-width: 250px; display: inline-block; vertical-align: top;">
                    <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                    {% if field.field.required %}<span style="color: red;">*</span>{% endif %}
                </div>
                <div class="form-group-field" style="display: inline-block; width: calc(100% - 270px);">
                    {{ field }}
                    {% if field.help_text %}<br><small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                    {% for error in field.errors %}<div class="alert alert-danger mt-1 p-1" role="alert" style="font-size: 0.9em;">{{ error }}</div>{% endfor %}
                </div>
            </div>
            {% endwith %}

            {# Поле ОІДи #}
            {% with field=form.oids %}
            <div class="form-row mb-3">
                <div class="form-group-label" style="font-weight: bold; padding-right: 10px; min-width: 250px; display: inline-block; vertical-align: top;">
                    <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                    {% if field.field.required %}<span style="color: red;">*</span>{% endif %}
                </div>
                <div class="form-group-field" style="display: inline-block; width: calc(100% - 270px);">
                    {{ field }} {# Віджет вже має клас 'form-control tomselect-field-oids' з форми #}
                    <button type="button" class="btn btn-sm btn-success ms-2" id="showCreateOidModalBtnForRequest">
                        <i class="fas fa-plus"></i> Створити новий ОІД
                    </button>
                    {% if field.help_text %}<br><small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                    {% for error in field.errors %}<div class="alert alert-danger mt-1 p-1" role="alert" style="font-size: 0.9em;">{{ error }}</div>{% endfor %}
                </div>
            </div>
            {% endwith %}

            {# Поле Примітки #}
            {% with field=form.note %}
            <div class="form-row mb-3">
                <div class="form-group-label" style="font-weight: bold; padding-right: 10px; min-width: 250px; display: inline-block; vertical-align: top;">
                    <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                    {% if field.field.required %}<span style="color: red;">*</span>{% endif %}
                </div>
                <div class="form-group-field" style="display: inline-block; width: calc(100% - 270px);">
                    {{ field }}
                    {% if field.help_text %}<br><small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                    {% for error in field.errors %}<div class="alert alert-danger mt-1 p-1" role="alert" style="font-size: 0.9em;">{{ error }}</div>{% endfor %}
                </div>
            </div>
            {% endwith %}
        </div>

        <div class="form-actions mt-4">
            <button type="submit" class="btn btn-primary">Зберегти заявку</button>
            <a href="{% url 'oids:list_work_requests' %}" class="btn btn-secondary">Скасувати</a> {# Або main_dashboard #}
        </div>
    </form>
</div>

{# Модальне вікно для створення ОІД вже є в base.html, ми будемо його використовувати #}

{% endblock %}

{% block extra_js %} {# Замінив page_specific_js на extra_js для відповідності base.html #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('Work Request Form JS: DOMContentLoaded. V3 Debugging (Direct Fetch).');

    const unitSelectElement = document.getElementById('{{ form.unit.id_for_label }}');
    const oidsSelectElement = document.getElementById('{{ form.oids.id_for_label }}');
    const showCreateOidModalButton = document.getElementById('showCreateOidModalBtnForRequest'); 
    
    const oidCreateModalElement = document.getElementById('createOidModal');
    let oidCreateModalInstance = oidCreateModalElement ? new bootstrap.Modal(oidCreateModalElement) : null;
    const modalSelectedUnitNameElement = document.getElementById('modalSelectedUnitName'); 
    const modalHiddenUnitIdInput = document.getElementById('id_modal_hidden_unit_id'); 

    let tomSelectUnits = null;
    let tomSelectOids = null;

    if (typeof TomSelect === 'undefined') {
        console.error('Work Request Form JS: TomSelect library is NOT loaded!');
        return;
    } else {
        console.log('Work Request Form JS: TomSelect library is loaded.');
    }

    if (unitSelectElement && unitSelectElement.classList.contains('tomselect-field-defer')) {
        tomSelectUnits = new TomSelect(unitSelectElement, {
            create: false,
            placeholder: 'Оберіть ВЧ...',
            allowEmptyOption: true,
        });
        console.log('Work Request Form JS: TomSelect for Unit initialized.');
    } else {
        console.warn('Work Request Form JS: TomSelect for Unit NOT initialized.');
    }

    if (oidsSelectElement && oidsSelectElement.classList.contains('tomselect-field-oids')) {
        tomSelectOids = new TomSelect(oidsSelectElement, {
            create: false,
            plugins: ['remove_button'],
            placeholder: 'Спочатку оберіть ВЧ...',
            valueField: 'id',
            labelField: 'text',
            searchField: ['text'],
            options: [],
            disabled: !unitSelectElement?.value,
        });
        oidsSelectElement.tomselectInstance = tomSelectOids;
        console.log('Work Request Form JS: TomSelect for OIDs initialized.');
        if (!unitSelectElement || !unitSelectElement.value) {
             if(tomSelectOids) tomSelectOids.disable();
        }
    } else {
        console.warn('Work Request Form JS: TomSelect for OIDs NOT initialized.');
    }

    if (unitSelectElement && tomSelectOids) {
        console.log('Work Request Form JS: Attaching "change" listener to Unit select.');
        unitSelectElement.addEventListener('change', function () {
            const unitId = this.value;
            console.log(`Work Request Form JS: Unit changed. Selected Unit ID: [${unitId}]`);

            if (!tomSelectOids) {
                console.error('Work Request Form JS: tomSelectOids is not initialized in unit change listener!');
                return;
            }

            // Очищаємо TomSelect для ОІДів
            tomSelectOids.clear();        // Очистити обрані значення
            tomSelectOids.clearOptions(); // Очистити всі опції
            tomSelectOids.sync();         // Синхронізувати стан

            if (unitId) {
                console.log('Work Request Form JS: Unit ID is present. Enabling OID select and starting fetch.');
                tomSelectOids.enable();
                tomSelectOids.placeholder = 'Завантаження ОІДів...';
                
                let ajaxUrl = window.AJAX_LOAD_OIDS_FOR_UNIT_URL;
                if (!ajaxUrl) {
                    ajaxUrl = "{% url 'oids:ajax_load_oids_for_unit' %}";
                    console.log("Work Request Form JS: Using fallback Django URL for OIDs: [" + ajaxUrl + "]");
                } else {
                    console.log("Work Request Form JS: Using global URL for OIDs: [" + ajaxUrl + "]");
                }
                
                if (!ajaxUrl || ajaxUrl.includes("None") || ajaxUrl.trim() === "" || ajaxUrl.trim() === "null") {
                    console.error('Work Request Form JS: AJAX URL for OIDs is invalid or not resolved:', ajaxUrl);
                    tomSelectOids.placeholder = 'Помилка: Невірний URL';
                    return;
                }

                fetch(`${ajaxUrl}?unit_id=${unitId}`)
                    .then(response => {
                        console.log('Work Request Form JS: Fetch response status for OIDs:', response.status);
                        if (!response.ok) {
                            return response.text().then(text => {
                                console.error('Work Request Form JS: Network error response text (OIDs):', text);
                                throw new Error(`Network error (OIDs): ${response.status} ${response.statusText}. Server: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Work Request Form JS: AJAX data successfully received for OIDs:', data);
                        if (!Array.isArray(data)) {
                            console.error('Work Request Form JS: Expected array from AJAX (OIDs), got:', typeof data, data);
                            tomSelectOids.placeholder = 'Помилка: невірний формат даних';
                            return;
                        }
                        const options = data.map(oid => ({
                            id: oid.id.toString(), 
                            text: `${oid.cipher} (${oid.full_name || 'Без назви'})` 
                        }));
                        console.log('Work Request Form JS: Mapped options for OID TomSelect:', options);
                        
                        tomSelectOids.addOptions(options); // Додаємо нові опції
                        // tomSelectOids.refreshOptions(false); // Можливо, не потрібно після addOptions

                        tomSelectOids.placeholder = options.length > 0 ? 'Оберіть ОІД(и)...' : 'ОІДи для цієї ВЧ не знайдено';
                    })
                    .catch((error) => {
                        console.error("Work Request Form JS: CATCH block - Error during AJAX load for OIDs:", error);
                        tomSelectOids.placeholder = 'Помилка завантаження ОІДів';
                    });

            } else {
                console.log('Work Request Form JS: No Unit ID selected, disabling and clearing OID select.');
                tomSelectOids.disable();
                // tomSelectOids.clear(); // Вже зроблено на початку обробника
                // tomSelectOids.clearOptions(); // Вже зроблено на початку обробника
                // tomSelectOids.sync(); // Вже зроблено на початку обробника
                tomSelectOids.placeholder = 'Спочатку оберіть ВЧ...';
            }
        });
        console.log('Work Request Form JS: "change" listener attached to Unit select.');

        if (unitSelectElement.value) {
            console.log('Work Request Form JS: Unit already selected on page load (value: ' + unitSelectElement.value + '), dispatching "change" event.');
            unitSelectElement.dispatchEvent(new Event('change'));
        } else {
            console.log('Work Request Form JS: Unit not selected on page load. OID select remains disabled.');
            if(tomSelectOids) tomSelectOids.disable();
        }
    } else {
        console.warn('Work Request Form JS: Not attaching unit "change" listener. Check Unit select or OID TomSelect availability.');
    }

    // ... (решта вашого JS для модального вікна, як було) ...
    // Обробник для кнопки "Створити новий ОІД"
    if (showCreateOidModalButton && oidCreateModalInstance && unitSelectElement) {
        showCreateOidModalButton.addEventListener('click', function () {
            console.log('Work Request Form JS: "Create new OID" button clicked.');
            const selectedUnitValue = unitSelectElement.value;
            if (!selectedUnitValue) {
                alert('Будь ласка, спочатку оберіть Військову частину.');
                return;
            }
            // ... (решта логіки відкриття модалки)
             const oidCreateFormElement = document.getElementById('ajaxOidCreateForm');
            const oidCreateFormAlertsElement = document.getElementById('oidCreateFormAlertsBootstrap');

            if (oidCreateFormElement) oidCreateFormElement.reset();
            if (oidCreateFormAlertsElement) oidCreateFormAlertsElement.innerHTML = '';
            
            if (modalSelectedUnitNameElement) {
                 const selectedUnitOption = unitSelectElement.options[unitSelectElement.selectedIndex];
                 modalSelectedUnitNameElement.textContent = selectedUnitOption ? selectedUnitOption.text : 'не обрано';
            }
            if (modalHiddenUnitIdInput) { 
                modalHiddenUnitIdInput.value = selectedUnitValue;
            }
            
            if (oidCreateFormElement) {
                oidCreateFormElement.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                oidCreateFormElement.querySelectorAll('.invalid-feedback[data-field-errors-bs]').forEach(el => el.textContent = '');
            }
            oidCreateModalInstance.show();
        });
    }
    // Слухачі подій 'oid.created.success' та 'oid.created.error'
    if (oidCreateModalElement && oidsSelectElement && oidsSelectElement.tomselectInstance) {
        oidCreateModalElement.addEventListener('oid.created.success', function (event) {
            const newOidData = event.detail; 
            console.log('Work Request Form JS: "oid.created.success" event received:', newOidData);
            const currentUnitId = unitSelectElement.value;
            if (newOidData && newOidData.oid_id && newOidData.oid_name && newOidData.unit_id && newOidData.unit_id.toString() === currentUnitId) {
                const tsOids = oidsSelectElement.tomselectInstance;
                tsOids.addOption({ 
                    id: newOidData.oid_id.toString(),
                    text: newOidData.oid_name 
                });
                tsOids.addItem(newOidData.oid_id.toString());
                console.log('Work Request Form JS: New OID added and selected.');
                 if (oidCreateModalInstance) oidCreateModalInstance.hide();
            } else {
                 console.warn('Work Request Form JS: New OID does not belong to current unit or data invalid. Event detail:', newOidData, 'Current unit:', currentUnitId);
                 if (oidCreateModalInstance) oidCreateModalInstance.hide(); // Все одно закрити модалку
            }
        });
        oidCreateModalElement.addEventListener('oid.created.error', function(event) {
             console.log('Work Request Form JS: "oid.created.error" event received:', event.detail.errors);
            // ... (код обробки помилки) ...
        });
    }


    if (typeof window.AJAX_LOAD_OIDS_FOR_UNIT_URL === 'undefined') {
        let djangoUrl = "{% url 'oids:ajax_load_oids_for_unit' %}";
        if (djangoUrl && !djangoUrl.includes("None") && djangoUrl.trim() !== "") {
            window.AJAX_LOAD_OIDS_FOR_UNIT_URL = djangoUrl;
            console.log("Work Request Form JS: AJAX_LOAD_OIDS_FOR_UNIT_URL set by fallback to: [" + window.AJAX_LOAD_OIDS_FOR_UNIT_URL + "]");
        } else {
            console.error("Work Request Form JS: Fallback Django URL for AJAX_LOAD_OIDS_FOR_UNIT_URL is invalid!");
        }
    } else {
        console.log("Work Request Form JS: AJAX_LOAD_OIDS_FOR_UNIT_URL is globally defined: [" + window.AJAX_LOAD_OIDS_FOR_UNIT_URL + "]");
    }
});
</script>
{% endblock %}