{% extends "oids/base.html" %}
{% load static %} {# Якщо base.html вже має load static, тут це не обов'язково #}

{% block title %}{{ page_title|default:"Додати заявку на проведення робіт" }}{% endblock %}

{% block content %}
<div class="container form-container">
    <h2 class="mb-4">{{ page_title|default:"Нова заявка на проведення робіт" }}</h2>
    
    <form method="post" novalidate>
        {% csrf_token %}
        
        {# {{ form.media }} - Розкоментуй, якщо твої віджети (наприклад, для дати) використовують JS/CSS #}

        {# Виведення загальних помилок форми #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        {# Виведення полів форми #}
        <div class="table-like-form">
            {% for field in form %}
                <div class="form-row mb-3">
                    <div class="form-group-label" style="font-weight: bold; padding-right: 10px; min-width: 250px; display: inline-block; vertical-align: top;">
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                        {% if field.field.required %}
                            <span style="color: red;">*</span>
                        {% endif %}
                    </div>
                    <div class="form-group-field" style="display: inline-block; width: calc(100% - 270px);">
                        {{ field }}
                        {% if field.help_text %}
                            <br><small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}
                        {% for error in field.errors %}
                            <div class="alert alert-danger mt-1 p-1" role="alert" style="font-size: 0.9em;">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div class="form-actions mt-4">
            <button type="submit" class="btn btn-primary">Зберегти заявку</button>
            <a href="{% url 'oids:main_dashboard' %}" class="btn btn-secondary">Скасувати</a>
        </div>
    </form>
</div>
{% endblock %}

{% block page_specific_js %}
<script>
$(document).ready(function() {
    // Ініціалізація Select2 для полів цієї форми, якщо вони мають клас .select2
    // (або інший клас, який ти використовуєш для ініціалізації в select2-init.js)
    // Наприклад, якщо форма має ID 'addWorkRequestForm':
    // if (typeof initSelect2Fields === 'function') {
    //     initSelect2Fields($('#addWorkRequestForm')); 
    // }
    // Або якщо initSelect2Fields вже викликається глобально для всіх .select2, то це не потрібно.

    // Динамічна фільтрація ОІДів на основі обраної Військової частини
    // Якщо поле "Військова частина" має id 'id_unit' (з WorkRequestForm)
    // а поле "ОІДи" має id 'id_oids' (з WorkRequestForm)
    // і на #id_unit додано data-ajax-url="{% url 'oids:ajax_load_oids_for_unit' %}"
    
    // Це лише приклад, як можна було б налаштувати filtering_dynamic.js для цієї форми.
    // Переконайся, що відповідна конфігурація є в initializeDynamicFilters().
    // if (typeof initializeDynamicFilters === 'function' && typeof setupDynamicFilter === 'function') {
    //     const $unitSelectInForm = $('#id_unit'); // ID поля Unit у формі
    //     const $oidsSelectInForm = $('#id_oids'); // ID поля OIDs у формі

    //     if ($unitSelectInForm.length && $oidsSelectInForm.length) {
    //         const ajaxUrlForOids = $unitSelectInForm.data('ajax-url-oids-for-form'); // Потрібно додати цей data-атрибут до HTML поля Unit
            
    //         if (ajaxUrlForOids) {
    //             console.log("Налаштування фільтра для форми: Unit -> OIDs");
    //             setupDynamicFilter({
    //                 sourceSelectSelector: '#id_unit', // ID поля Unit у формі
    //                 targetSelectSelector: '#id_oids',   // ID поля OIDs у формі
    //                 url: ajaxUrlForOids, 
    //                 paramName: 'unit_id', 
    //                 placeholder: { default: 'Спочатку оберіть ВЧ', loading: 'Завантаження ОІД...', error: 'Помилка', empty: 'Немає ОІД для цієї ВЧ'},
    //                 transformItem: item => ({ id: item.id, text: item.name }), // name - це те, що повертає ajax_load_oids_for_unit
    //                 clearTargetsSelectors: ['#id_oids'] 
    //             });
    //         } else {
    //             console.warn("Не знайдено data-ajax-url-oids-for-form на #id_unit для динамічного завантаження ОІДів у формі.");
    //         }
    //     }
    // }
});
</script>
{% endblock %}