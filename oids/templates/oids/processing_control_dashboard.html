{# oids/templates/oids/processing_control_dashboard.html #}
{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">{{ page_title }}</h2>

    {# --- Блок: Опрацювання документів з відрядження --- #}
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Контроль опрацювання документів Заявок (після відряджень)</h4>
        </div>
        <div class="card-body">
            {# ... (вся форма фільтрації для wri_filter_form залишається тут) ... #}
            <form method="GET" class="mb-3 p-3 border bg-light rounded" id="wriFilterForm">
                 <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        {{ wri_filter_form.unit.label_tag }}
                        {{ wri_filter_form.unit }}
                    </div>
                    <div class="col-md-3">
                        {{ wri_filter_form.oid.label_tag }}
                        {{ wri_filter_form.oid }}
                    </div>
                    <div class="col-md-3">
                        {{ wri_filter_form.status.label_tag }}
                        {{ wri_filter_form.status }}
                    </div>
                    <div class="col-md-3">
                        {{ wri_filter_form.processed.label_tag }}
                        {{ wri_filter_form.processed }}
                    </div>
                </div>
                <div class="row g-2 mt-2 align-items-end">
                    <div class="col-md-2">
                        {{ wri_filter_form.deadline_from.label_tag }}
                        {{ wri_filter_form.deadline_from }}
                    </div>
                    <div class="col-md-2">
                        {{ wri_filter_form.deadline_to.label_tag }}
                        {{ wri_filter_form.deadline_to }}
                    </div>
                    <div class="col-md-2">
                        {{ wri_filter_form.trip_date_from.label_tag }}
                        {{ wri_filter_form.trip_date_from }}
                    </div>
                    <div class="col-md-2">
                        {{ wri_filter_form.trip_date_to.label_tag }}
                        {{ wri_filter_form.trip_date_to }}
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Фільтр Заявок</button>
                    </div>
                    <div class="col-md-2">
                         <a href="{% url 'oids:processing_control_dashboard' %}" class="btn btn-outline-secondary btn-sm w-100">Скинути</a>
                    </div>
                </div>
            </form>
            
            {# ... (вся таблиця для work_request_items залишається тут) ... #}
             {% if work_request_items.object_list %}
               <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=unit&wri_sort_order={% if current_wri_sort_by == 'unit' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">ВЧ / ОІД</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=unit&wri_sort_order={% if current_wri_sort_by == 'unit' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Тип ЕОТ</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=req_num&wri_sort_order={% if current_wri_sort_by == 'req_num' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Заявка (№, дата)</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=work_type&wri_sort_order={% if current_wri_sort_by == 'work_type' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Тип робіт</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=status&wri_sort_order={% if current_wri_sort_by == 'status' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Статус опрац. ОІД</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=trip_dates&wri_sort_order={% if current_wri_sort_by == 'trip_dates' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Термін відрядження</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=deadline&wri_sort_order={% if current_wri_sort_by == 'deadline' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}" style="text-wrap: wrap;">Кінцевий термін  опрац.</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=proc_date&wri_sort_order={% if current_wri_sort_by == 'proc_date' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Дата факт. опрац.</a></th>
                        </tr>
                    </thead>
             <tbody>
                        {% for item in work_request_items %}
                            {# --- Початок блоку для визначення кольору рядка --- #}

							
                            {% if item.work_type == 'Атестація' and item.final_attestation_date or item.work_type == 'ІК' and item.final_ik_date %}
                                <tr class="table-success">
                            {% elif item.doc_processing_deadline and item.doc_processing_deadline < today_date %}
                                <tr class="table-danger">
                            {% else %}
                                <tr>
                            {% endif %}
                            {# --- Кінець блоку для визначення кольору рядка --- #}
                            
                                <td>
                                    <small>{{ item.request.unit.code }}</small><br> 
                                    <a href="{% url 'oids:oid_detail_view_name' item.oid.id %}">{{ item.oid.cipher }}</a>
                                </td>
                                <td>
                                    {{ item.oid.pemin_sub_type|default:"-" }}
                                </td>
                                <td>
                                    <a href="{% url 'oids:work_request_detail' pk=item.request.pk %}">
                                        №{{ item.request.incoming_number }} від {{ item.request.incoming_date|date:"d.m.Y" }}
                                    </a>
                                </td>
                                <td>{{ item.get_work_type_display }}</td>
                                <td>{{ item.get_status_display }}</td>
                               <td>
                                    {% if item.deadline_trigger_trip %}
                                        {{ item.deadline_trigger_trip.start_date|date:"d.m.Y" }} - {{ item.deadline_trigger_trip.end_date|date:"d.m.Y" }}
                                    {% elif item.request.trips.all.0 %}
                                        {% with last_trip=item.request.trips.all.0 %}
                                            {{ last_trip.start_date|date:"d.m.Y" }} - {{ last_trip.end_date|date:"d.m.Y" }}
                                        {% endwith %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                               
                                <td>{{ item.doc_processing_deadline|date:"d.m.Y"|default:"-" }}</td>
                                <td>
                                    {% if item.work_type == 'Атестація' and item.final_attestation_date %}
                                        {{ item.final_attestation_date|date:"d.m.Y" }}
                                    {% elif item.work_type == 'ІК' and item.final_ik_date %}
                                        {{ item.final_ik_date|date:"d.m.Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
             {% else %}
                <p>Елементи заявок, що відповідають фільтрам, відсутні.</p>
             {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{# Залишаємо тільки JS, потрібний для цієї сторінки #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof TomSelect !== 'undefined') {
		const oidsForUnitsUrl = "{% url 'oids:ajax_load_oids_for_multiple_units' %}";
		
		function setupCascade(unitElementId, oidElementId) {
			const unitElement = document.getElementById(unitElementId);
			const oidElement = document.getElementById(oidElementId);

			if (!unitElement || !oidElement) {
				console.error(`Setup failed: Elements not found for #${unitElementId} or #${oidElementId}`);
				return;
			}

			const tsOid = new TomSelect(oidElement, {
				create: false, 
				placeholder: 'Спочатку оберіть ВЧ...',
				valueField: 'id',
				labelField: 'text',
				searchField: ['text'],
				allowEmptyOption: true,
				plugins: ['remove_button'],
			});

			const tsUnit = new TomSelect(unitElement, {
				placeholder: 'Оберіть одну або декілька ВЧ...',
				searchField: ['text'],
				allowEmptyOption: true,
				plugins: ['remove_button'],
			});

			const loadOidsForUnits = (selectedUnitIds) => {
				tsOid.clear();
				tsOid.clearOptions();
				tsOid.disable();

				if (!selectedUnitIds || selectedUnitIds.length === 0) {
					return;
				}

				const params = new URLSearchParams();
				selectedUnitIds.forEach(id => params.append('unit_ids[]', id));
				const fetchUrl = `${oidsForUnitsUrl}?${params.toString()}`;

				fetch(fetchUrl)
					.then(response => response.json())
					.then(data => {
						const options = data.map(oid => ({
							id: oid.id.toString(),
							text: `${oid.cipher} (${oid.oid_type_display})`
						}));
						tsOid.addOptions(options);
						tsOid.enable();
					})
					.catch(error => {
						console.error(`Failed to load OIDs:`, error);
						tsOid.enable();
					});
			};

			tsUnit.on('change', loadOidsForUnits);

			if (tsUnit.items && tsUnit.items.length > 0) {
				loadOidsForUnits(tsUnit.items);
			} else {
				tsOid.disable();
			}
		}
		setupCascade('id_wri_filter_unit', 'id_wri_filter_oid');
    }
});
</script>
{% endblock %}