{# oids/templates/oids/processing_control_dashboard.html #}
{% extends "oids/base.html" %}
{% load static %} {# Якщо потрібно #}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">{{ page_title }}</h2>

    {# --- Блок 1: Читання Технічних Завдань --- #}
    <div class="card mb-4">
        <div class="card-header"><h4 class="mb-0">Контроль опрацювання Технічних Завдань (ТЗ)</h4></div>
        <div class="card-body">
            <form method="GET" class="mb-3 p-3 border bg-light rounded" id="ttFilterForm">
                {# Зберігаємо параметри іншої таблиці/фільтра #}
                {% for key, value in request.GET.items %}
                    {% if key != tt_filter_form.prefix|add:"-unit" and key != tt_filter_form.prefix|add:"-oid" and key != tt_filter_form.prefix|add:"-review_result" and key != "tt_page" and key != "tt_sort_by" and key != "tt_sort_order" %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label for="{{ tt_filter_form.unit.id_for_label }}">{{ tt_filter_form.unit.label }}:</label>
                        {{ tt_filter_form.unit }}
                    </div>
                    <div class="col-md-3">
                         <label for="{{ tt_filter_form.oid.id_for_label }}">{{ tt_filter_form.oid.label }}:</label>
                        {{ tt_filter_form.oid }}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ tt_filter_form.review_result.id_for_label }}">{{ tt_filter_form.review_result.label }}:</label>
                        {{ tt_filter_form.review_result }}
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Фільтр ТЗ</button>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <a href="{% url 'oids:processing_control_dashboard' %}" class="btn btn-outline-secondary btn-sm w-100">Скинути всі фільтри</a>
                    </div>
                </div>
            </form>

            {% if technical_tasks.object_list %}
            <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            {# Додаємо посилання для сортування #}
                            {% url 'oids:processing_control_dashboard' as base_url %}
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=unit&tt_sort_order={% if current_tt_sort_by == 'unit' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">ВЧ / ОІД</a></th>
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=input_num&tt_sort_order={% if current_tt_sort_by == 'input_num' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Вхідний № ТЗ</a></th>
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=input_date&tt_sort_order={% if current_tt_sort_by == 'input_date' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Вхідна дата ТЗ</a></th>
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=deadline&tt_sort_order={% if current_tt_sort_by == 'deadline' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Термін опрац.</a></th>
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=status&tt_sort_order={% if current_tt_sort_by == 'status' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Статус ТЗ</a></th>
							<th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=updated_at&tt_sort_order={% if current_tt_sort_by == 'updated_at' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Дата оновлення</a></th>
								<!-- {% if current_sort_by == 'updated_at' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %} -->
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=executor&tt_sort_order={% if current_tt_sort_by == 'executor' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Хто/Коли опрацював</a></th>
                            <th>Примітки</th>
                        </tr>
                    </thead>
					
                    <tbody>
                        {% for task in technical_tasks %}
							<tr {% if task.read_till_date and task.read_till_date < today_date and task.review_result == ReviewResultChoices.READ %}class="table-danger"{% elif task.review_result == ReviewResultChoices.APPROVED or task.review_result == ReviewResultChoices.AWAITING_DOCS %}class="table-success"{% endif %}>
                            <td>
                                <small>{{ task.oid.unit.code }}</small><br>
                                <a href="{% url 'oids:oid_detail_view_name' task.oid.id %}#task-{{task.id}}">{{ task.oid.cipher }}</a>
                            </td>
                            <td>{{ task.input_number }}</td>
                            <td>{{ task.input_date|date:"d.m.Y" }}</td>
                            <td>{{ task.read_till_date|date:"d.m.Y" }}</td>
                            <td>{{ task.get_review_result_display }}</td>
							<td>{{ task.updated_at|date:"d.m.Y"|default:"-" }}</td>
                            <td>
                                {{ task.reviewed_by.full_name|default:"-" }}
                                {% if task.reviewed_by and task.updated_at != task.created_at and task.review_result != 'READ' %}
                                    <br><small class="text-muted">({{ task.updated_at|date:"d.m.Y H:i" }})</small>
                                {% endif %}
                            </td>
                            <td>{{ task.note|truncatechars:30|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
					
                </table>
            </div>
            {% include "oids/includes/pagination.html" with page_obj=technical_tasks param_prefix="tt_" current_filters=request.GET.urlencode no_scroll=True %}
            {% else %}
            <p>Технічні завдання, що відповідають фільтрам, відсутні.</p>
            {% endif %}
        </div>
    </div>

	{# oids/templates/oids/processing_control_dashboard.html #}
    {# --- Блок 2: Опрацювання документів з відрядження --- #}
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Контроль опрацювання документів Заявок (після відряджень)</h4>
        </div>
        <div class="card-body">
            <form method="GET" class="mb-3 p-3 border bg-light rounded" id="wriFilterForm">
                {% for key, value in request.GET.items %}
{% if key != wri_filter_form.prefix|add:"-unit" and key != wri_filter_form.prefix|add:"-oid" and key != wri_filter_form.prefix|add:"-status" and key != wri_filter_form.prefix|add:"-processed" and key != wri_filter_form.prefix|add:"-deadline_from" and key != wri_filter_form.prefix|add:"-deadline_to" and key != wri_filter_form.prefix|add:"-trip_date_from" and key != wri_filter_form.prefix|add:"-trip_date_to" and key != "wri_page" and key != "wri_sort_by" and key != "wri_sort_order" %}                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
               <div class="row g-2 align-items-end">
    <div class="col-md-3">
        {{ wri_filter_form.unit.label_tag }}
        {{ wri_filter_form.unit }}
    </div>
    <div class="col-md-3">
        {{ wri_filter_form.oid.label_tag }}
        {{ wri_filter_form.oid }}
    </div>
    <div class="col-md-3">
        {{ wri_filter_form.status.label_tag }}
        {{ wri_filter_form.status }}
    </div>
    <div class="col-md-3">
        {{ wri_filter_form.processed.label_tag }}
        {{ wri_filter_form.processed }}
    </div>
</div>
<div class="row g-2 mt-2 align-items-end">
    <div class="col-md-2">
        {{ wri_filter_form.deadline_from.label_tag }}
        {{ wri_filter_form.deadline_from }}
    </div>
    <div class="col-md-2">
        {{ wri_filter_form.deadline_to.label_tag }}
        {{ wri_filter_form.deadline_to }}
    </div>
    <div class="col-md-2">
        {{ wri_filter_form.trip_date_from.label_tag }}
        {{ wri_filter_form.trip_date_from }}
    </div>
    <div class="col-md-2">
        {{ wri_filter_form.trip_date_to.label_tag }}
        {{ wri_filter_form.trip_date_to }}
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary btn-sm w-100">Фільтр Заявок</button>
    </div>
    <div class="col-md-2">
         <a href="{% url 'oids:processing_control_dashboard' %}" class="btn btn-outline-secondary btn-sm w-100">Скинути</a>
    </div>
</div>
            </form>

            {% if work_request_items.object_list %}
            <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=unit&wri_sort_order={% if current_wri_sort_by == 'unit' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">ВЧ / ОІД</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=unit&wri_sort_order={% if current_wri_sort_by == 'unit' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Тип ЕОТ</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=req_num&wri_sort_order={% if current_wri_sort_by == 'req_num' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Заявка (№, дата)</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=work_type&wri_sort_order={% if current_wri_sort_by == 'work_type' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Тип робіт</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=status&wri_sort_order={% if current_wri_sort_by == 'status' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Статус опрац. ОІД</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=trip_dates&wri_sort_order={% if current_wri_sort_by == 'trip_dates' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Термін відрядження</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=deadline&wri_sort_order={% if current_wri_sort_by == 'deadline' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}" style="text-wrap: wrap;">Кінцевий термін  опрац.</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=proc_date&wri_sort_order={% if current_wri_sort_by == 'proc_date' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Дата факт. опрац.</a></th>
                        </tr>
                    </thead>
             <tbody>
                        {% for item in work_request_items %}
                            {# --- Початок блоку для визначення кольору рядка --- #}

							
                            {% if item.work_type == 'Атестація' and item.final_attestation_date or item.work_type == 'ІК' and item.final_ik_date %}
                                <tr class="table-success">
                            {% elif item.doc_processing_deadline and item.doc_processing_deadline < today_date %}
                                <tr class="table-danger">
                            {% else %}
                                <tr>
                            {% endif %}
                            {# --- Кінець блоку для визначення кольору рядка --- #}
                            
                                <td>
                                    <small>{{ item.request.unit.code }}</small><br> 
                                    <a href="{% url 'oids:oid_detail_view_name' item.oid.id %}">{{ item.oid.cipher }}</a>
                                </td>
                                <td>
                                    {{ item.oid.pemin_sub_type|default:"-" }}
                                </td>
                                <td>
                                    <a href="{% url 'oids:work_request_detail' pk=item.request.pk %}">
                                        №{{ item.request.incoming_number }} від {{ item.request.incoming_date|date:"d.m.Y" }}
                                    </a>
                                </td>
                                <td>{{ item.get_work_type_display }}</td>
                                <td>{{ item.get_status_display }}</td>
                               <td>
                                    {% if item.deadline_trigger_trip %}
                                        {{ item.deadline_trigger_trip.start_date|date:"d.m.Y" }} - {{ item.deadline_trigger_trip.end_date|date:"d.m.Y" }}
                                    {% elif item.request.trips.all.0 %}
                                        {% with last_trip=item.request.trips.all.0 %}
                                            {{ last_trip.start_date|date:"d.m.Y" }} - {{ last_trip.end_date|date:"d.m.Y" }}
                                        {% endwith %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                               
                                <td>{{ item.doc_processing_deadline|date:"d.m.Y"|default:"-" }}</td>
                                <td>
                                    {% if item.work_type == 'Атестація' and item.final_attestation_date %}
                                        {{ item.final_attestation_date|date:"d.m.Y" }}
                                    {% elif item.work_type == 'ІК' and item.final_ik_date %}
                                        {{ item.final_ik_date|date:"d.m.Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% include "oids/includes/pagination.html" with page_obj=work_request_items param_prefix="wri_" current_filters=request.GET.urlencode no_scroll=True %}
            {% else %}
            <p>Елементи заявок, що відповідають фільтрам, відсутні.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("--- DOMContentLoaded: Initializing dashboard scripts ---");

    if (typeof TomSelect === 'undefined') {
        console.error("CRITICAL: TomSelect library is not loaded!");
        return;
    }

    const oidsForUnitsUrl = "{% url 'oids:ajax_load_oids_for_multiple_units' %}";

    function setupCascade(unitElementId, oidElementId) {
        const unitElement = document.getElementById(unitElementId);
        const oidElement = document.getElementById(oidElementId);

        if (!unitElement || !oidElement) {
            console.error(`Setup failed: Elements not found for #${unitElementId} or #${oidElementId}`);
            return;
        }

        const tsOid = new TomSelect(oidElement, {
            placeholder: 'Спочатку оберіть ВЧ...',
            valueField: 'id',
            labelField: 'text',
            searchField: ['text'],
        });

        const tsUnit = new TomSelect(unitElement, {
            placeholder: 'Оберіть одну або декілька ВЧ...'
        });

        // Функція для завантаження ОІДів
        const loadOidsForUnits = (selectedUnitIds) => {
            console.log(`[${unitElementId}] Unit selection changed. Selected IDs:`, selectedUnitIds);
            
            tsOid.clear();
            tsOid.clearOptions();
            tsOid.disable();

            if (!selectedUnitIds || selectedUnitIds.length === 0) {
                console.log(`[${unitElementId}] No units selected. OID field remains disabled.`);
                return;
            }

            const params = new URLSearchParams();
            selectedUnitIds.forEach(id => params.append('unit_ids[]', id));
            const fetchUrl = `${oidsForUnitsUrl}?${params.toString()}`;

            console.log(`[${unitElementId}] Fetching OIDs from:`, fetchUrl);

            fetch(fetchUrl)
                .then(response => {
                    if (!response.ok) { throw new Error('Network response was not ok'); }
                    return response.json();
                })
                .then(data => {
                    console.log(`[${unitElementId}] Received ${data.length} OIDs.`, data);
                    // --- ПОЧАТОК ВИПРАВЛЕННЯ ---
                    // Перетворюємо отримані дані у формат, зрозумілий для TomSelect.
                    // Кожен елемент тепер буде мати 'id' та 'text'.
                    const options = data.map(oid => ({
                        id: oid.id.toString(),
                        text: `${oid.cipher} (${oid.oid_type_display})`
                    }));
                    // --- КІНЕЦЬ ВИПРАВЛЕННЯ ---
					tsOid.addOptions(options);
                    tsOid.enable();         // Вручну вмикаємо поле
                    console.log(`[${unitElementId}] OID field is now enabled.`);
                })
                .catch(error => {
                    console.error(`[${unitElementId}] Failed to load OIDs:`, error);
                    tsOid.enable(); // Все одно вмикаємо поле, щоб користувач не застряг
                });
        };

        // Прив'язуємо обробник події
        tsUnit.on('change', loadOidsForUnits);

        // Початкове завантаження, якщо ВЧ вже обрані
        if (tsUnit.items && tsUnit.items.length > 0) {
            console.log(`[${unitElementId}] Initial units selected:`, tsUnit.items);
            loadOidsForUnits(tsUnit.items);
        } else {
             tsOid.disable();
        }
    }

    // Запускаємо налаштування для обох блоків
    setupCascade('id_tt_filter_unit', 'id_tt_filter_oid');
    setupCascade('id_wri_filter_unit', 'id_wri_filter_oid');

    console.log("--- Dashboard scripts initialization complete ---");
});
</script>
{% endblock %}