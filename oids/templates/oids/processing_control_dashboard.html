{# oids/templates/oids/processing_control_dashboard.html #}
{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">{{ page_title }}</h2>

    {# --- Блок: Опрацювання документів з відрядження --- #}
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Контроль опрацювання документів Заявок (після відряджень)</h4>
        </div>
        <div class="card-body">
            {# ... (вся форма фільтрації для wri_filter_form залишається тут) ... #}
            <form method="GET" class="mb-3 p-3 border bg-light rounded" id="wriFilterForm">
                 <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        {{ wri_filter_form.unit.label_tag }}
                        {{ wri_filter_form.unit }}
                    </div>
                    <div class="col-md-3">
                        {{ wri_filter_form.oid.label_tag }}
                        {{ wri_filter_form.oid }}
                    </div>
                    <div class="col-md-3">
                        {{ wri_filter_form.status.label_tag }}
                        {{ wri_filter_form.status }}
                    </div>
                    <div class="col-md-3">
                        {{ wri_filter_form.processed.label_tag }}
                        {{ wri_filter_form.processed }}
                    </div>
                </div>
                <div class="row g-2 mt-2 align-items-end">
                    <div class="col-md-2">
                        {{ wri_filter_form.deadline_from.label_tag }}
                        {{ wri_filter_form.deadline_from }}
                    </div>
                    <div class="col-md-2">
                        {{ wri_filter_form.deadline_to.label_tag }}
                        {{ wri_filter_form.deadline_to }}
                    </div>
                    <div class="col-md-2">
                        {{ wri_filter_form.trip_date_from.label_tag }}
                        {{ wri_filter_form.trip_date_from }}
                    </div>
                    <div class="col-md-2">
                        {{ wri_filter_form.trip_date_to.label_tag }}
                        {{ wri_filter_form.trip_date_to }}
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Фільтр Заявок</button>
                    </div>
                    <div class="col-md-2">
                         <a href="{% url 'oids:processing_control_dashboard' %}" class="btn btn-outline-secondary btn-sm w-100">Скинути</a>
                    </div>
                </div>
            </form>
            
            {# ... (вся таблиця для work_request_items залишається тут) ... #}
             {% if work_request_items.object_list %}
                {# ... код таблиці ... #}
             {% else %}
                <p>Елементи заявок, що відповідають фільтрам, відсутні.</p>
             {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{# Залишаємо тільки JS, потрібний для цієї сторінки #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof TomSelect !== 'undefined') {
		const oidsForUnitsUrl = "{% url 'oids:ajax_load_oids_for_multiple_units' %}";
		
		function setupCascade(unitElementId, oidElementId) {
			const unitElement = document.getElementById(unitElementId);
			const oidElement = document.getElementById(oidElementId);

			if (!unitElement || !oidElement) {
				console.error(`Setup failed: Elements not found for #${unitElementId} or #${oidElementId}`);
				return;
			}

			const tsOid = new TomSelect(oidElement, {
				create: false, 
				placeholder: 'Спочатку оберіть ВЧ...',
				valueField: 'id',
				labelField: 'text',
				searchField: ['text'],
				allowEmptyOption: true,
				plugins: ['remove_button'],
			});

			const tsUnit = new TomSelect(unitElement, {
				placeholder: 'Оберіть одну або декілька ВЧ...',
				searchField: ['text'],
				allowEmptyOption: true,
				plugins: ['remove_button'],
			});

			const loadOidsForUnits = (selectedUnitIds) => {
				tsOid.clear();
				tsOid.clearOptions();
				tsOid.disable();

				if (!selectedUnitIds || selectedUnitIds.length === 0) {
					return;
				}

				const params = new URLSearchParams();
				selectedUnitIds.forEach(id => params.append('unit_ids[]', id));
				const fetchUrl = `${oidsForUnitsUrl}?${params.toString()}`;

				fetch(fetchUrl)
					.then(response => response.json())
					.then(data => {
						const options = data.map(oid => ({
							id: oid.id.toString(),
							text: `${oid.cipher} (${oid.oid_type_display})`
						}));
						tsOid.addOptions(options);
						tsOid.enable();
					})
					.catch(error => {
						console.error(`Failed to load OIDs:`, error);
						tsOid.enable();
					});
			};

			tsUnit.on('change', loadOidsForUnits);

			if (tsUnit.items && tsUnit.items.length > 0) {
				loadOidsForUnits(tsUnit.items);
			} else {
				tsOid.disable();
			}
		}
		setupCascade('id_wri_filter_unit', 'id_wri_filter_oid');
    }
});
</script>
{% endblock %}