{# oids/templates/oids/processing_control_dashboard.html #}
{% extends "oids/base.html" %}
{% load static %} {# Якщо потрібно #}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">{{ page_title }}</h2>

    {# --- Блок 1: Читання Технічних Завдань --- #}
    <div class="card mb-4">
        <div class="card-header"><h4 class="mb-0">Контроль опрацювання Технічних Завдань (ТЗ)</h4></div>
        <div class="card-body">
            <form method="GET" class="mb-3 p-3 border bg-light rounded" id="ttFilterForm">
                {# Зберігаємо параметри іншої таблиці/фільтра #}
                {% for key, value in request.GET.items %}
                    {% if key != tt_filter_form.prefix|add:"-unit" and key != tt_filter_form.prefix|add:"-oid" and key != tt_filter_form.prefix|add:"-review_result" and key != "tt_page" and key != "tt_sort_by" and key != "tt_sort_order" %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label for="{{ tt_filter_form.unit.id_for_label }}">{{ tt_filter_form.unit.label }}:</label>
                        {{ tt_filter_form.unit }}
                    </div>
                    <div class="col-md-3">
                         <label for="{{ tt_filter_form.oid.id_for_label }}">{{ tt_filter_form.oid.label }}:</label>
                        {{ tt_filter_form.oid }}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ tt_filter_form.review_result.id_for_label }}">{{ tt_filter_form.review_result.label }}:</label>
                        {{ tt_filter_form.review_result }}
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Фільтр ТЗ</button>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <a href="{% url 'oids:processing_control_dashboard' %}" class="btn btn-outline-secondary btn-sm w-100">Скинути всі фільтри</a>
                    </div>
                </div>
            </form>

            {% if technical_tasks.object_list %}
            <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            {# Додаємо посилання для сортування #}
                            {% url 'oids:processing_control_dashboard' as base_url %}
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=unit&tt_sort_order={% if current_tt_sort_by == 'unit' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">ВЧ / ОІД</a></th>
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=input_num&tt_sort_order={% if current_tt_sort_by == 'input_num' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Вхідний № ТЗ</a></th>
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=input_date&tt_sort_order={% if current_tt_sort_by == 'input_date' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Вхідна дата ТЗ</a></th>
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=deadline&tt_sort_order={% if current_tt_sort_by == 'deadline' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Термін опрац.</a></th>
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=status&tt_sort_order={% if current_tt_sort_by == 'status' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Статус ТЗ</a></th>
                            <th><a href="{{ base_url }}?{{ request.GET.urlencode }}&tt_sort_by=executor&tt_sort_order={% if current_tt_sort_by == 'executor' and current_tt_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Хто/Коли опрацював</a></th>
                            <th>Примітки</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in technical_tasks %}
                        <tr {% if task.read_till_date and task.read_till_date < today_date and task.review_result == 'READ' %}class="table-danger"{% elif task.review_result == 'APPROVED' %}class="table-success"{% endif %}>
                            <td>
                                <small>{{ task.oid.unit.code }}</small><br>
                                <a href="{% url 'oids:oid_detail_view_name' task.oid.id %}#task-{{task.id}}">{{ task.oid.cipher }}</a>
                            </td>
                            <td>{{ task.input_number }}</td>
                            <td>{{ task.input_date|date:"d.m.Y" }}</td>
                            <td>{{ task.read_till_date|date:"d.m.Y" }}</td>
                            <td>{{ task.get_review_result_display }}</td>
                            <td>
                                {{ task.reviewed_by.full_name|default:"-" }}
                                {% if task.reviewed_by and task.updated_at != task.created_at and task.review_result != 'READ' %}
                                    <br><small class="text-muted">({{ task.updated_at|date:"d.m.Y H:i" }})</small>
                                {% endif %}
                            </td>
                            <td>{{ task.note|truncatechars:30|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% include "oids/includes/pagination.html" with page_obj=technical_tasks param_prefix="tt_" current_filters=request.GET.urlencode no_scroll=True %}
            {% else %}
            <p>Технічні завдання, що відповідають фільтрам, відсутні.</p>
            {% endif %}
        </div>
    </div>

     {# --- Блок 2: Опрацювання документів з відрядження --- #}
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Контроль опрацювання документів Заявок (після відряджень)</h4>
        </div>
        <div class="card-body">
            <form method="GET" class="mb-3 p-3 border bg-light rounded" id="wriFilterForm">
                {% for key, value in request.GET.items %}
                    {% if key != wri_filter_form.prefix|add:"-unit" and key != wri_filter_form.prefix|add:"-oid" and key != wri_filter_form.prefix|add:"-status" and key != wri_filter_form.prefix|add:"-processed" and key != wri_filter_form.prefix|add:"-deadline_from" and key != wri_filter_form.prefix|add:"-deadline_to" and key != "wri_page" and key != "wri_sort_by" and key != "wri_sort_order" %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
                 <div class="row g-2 align-items-start">
                    <div class="col-md-3">{{ wri_filter_form.unit.label_tag }} {{ wri_filter_form.unit }}</div>
                    <div class="col-md-3">{{ wri_filter_form.oid.label_tag }} {{ wri_filter_form.oid }}</div>
                    <div class="col-md-3">{{ wri_filter_form.status.label_tag }} {{ wri_filter_form.status }}</div>
                    <div class="col-md-3">{{ wri_filter_form.processed.label_tag }} {{ wri_filter_form.processed }}</div>
                </div>
                <div class="row g-2 mt-1 align-items-end">
                    <div class="col-md-3">{{ wri_filter_form.deadline_from.label_tag }} {{ wri_filter_form.deadline_from }}</div>
                    <div class="col-md-3">{{ wri_filter_form.deadline_to.label_tag }} {{ wri_filter_form.deadline_to }}</div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Фільтр Заявок</button>
                    </div>
                </div>
            </form>

            {% if work_request_items.object_list %}
            <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=unit&wri_sort_order={% if current_wri_sort_by == 'unit' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">ВЧ / ОІД</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=req_num&wri_sort_order={% if current_wri_sort_by == 'req_num' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Заявка (№, дата)</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=work_type&wri_sort_order={% if current_wri_sort_by == 'work_type' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Тип робіт</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=status&wri_sort_order={% if current_wri_sort_by == 'status' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Статус опрац. ОІД</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=trip_dates&wri_sort_order={% if current_wri_sort_by == 'trip_dates' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Термін відрядження</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=deadline&wri_sort_order={% if current_wri_sort_by == 'deadline' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}" style="text-wrap: wrap;">Кінцевий термін  опрац.</a></th>
                            <th><a href="?{{ request.GET.urlencode }}&wri_sort_by=proc_date&wri_sort_order={% if current_wri_sort_by == 'proc_date' and current_wri_sort_order == 'asc' %}desc{% else %}asc{% endif %}">Дата факт. опрац.</a></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in work_request_items %} {# work_request_items - це page_obj з WRI #}
                        {# Визначаємо останнє завершене відрядження для заявки цього елемента #}
                        {% with last_trip=item.request.trips.all.0 %} {# .0 - перший елемент, бо ми сортували по -end_date #}
                        <tr {% if item.doc_processing_deadline and item.doc_processing_deadline < today_date and not item.docs_actually_processed_on %}class="table-danger"{% elif item.docs_actually_processed_on %}class="table-success"{% endif %}>
                            <td>
                                <small>{{ item.request.unit.code }} / {{ item.oid.unit.code }}</small><br> 
                                <a href="{% url 'oids:oid_detail_view_name' item.oid.id %}">{{ item.oid.cipher }}</a>
                            </td>
                            <td>
                                {# TODO: Посилання на деталі заявки, якщо є <a href="#">  </a>#}
                                    
                               №{{ item.request.incoming_number }} від {{ item.request.incoming_date|date:"d.m.Y" }}
                            </td>
                            <td>{{ item.get_work_type_display }}</td>
                            <td>{{ item.get_status_display }}</td>
                           <td>
								{% if item.deadline_trigger_trip %} {# Якщо є зв'язок з конкретним відрядженням #}
									{{ item.deadline_trigger_trip.start_date|date:"d.m.Y" }} - {{ item.deadline_trigger_trip.end_date|date:"d.m.Y" }}
								{% elif item.request.trips.all.0 %} {# Інакше - останнє відрядження заявки #}
									{% with last_trip=item.request.trips.all.0 %}
										{{ last_trip.start_date|date:"d.m.Y" }} - {{ last_trip.end_date|date:"d.m.Y" }}
									{% endwith %}
								{% else %}
									<span class="text-muted">-</span>
								{% endif %}
							</td>
                           
                            <td>{{ item.doc_processing_deadline|date:"d.m.Y"|default:"-" }}</td>
                            <td>{{ item.docs_actually_processed_on|date:"d.m.Y"|default:"-" }}</td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% include "oids/includes/pagination.html" with page_obj=work_request_items param_prefix="wri_" current_filters=request.GET.urlencode no_scroll=True %}
            {% else %}
            <p>Елементи заявок, що відповідають фільтрам, відсутні.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("ProcessingControl JS: DOMContentLoaded.");
    if (typeof TomSelect === 'undefined') { console.error("ProcessingControl JS: TomSelect not loaded!"); return; }

    const oidsForUnitUrl = "{% url 'oids:ajax_load_oids_for_unit' %}"; 

    function initFilterTomSelect(element, placeholder, onInitCallback) {
        if (!element) {
            console.warn("TomSelect init: Element not found for placeholder:", placeholder);
            return null;
        }
        let htmlOpts = [];
        Array.from(element.options).forEach(opt => {if(opt.value) htmlOpts.push({id: opt.value, text: opt.text, selected: opt.selected});});
        
        const config = {
            create: false, placeholder: placeholder, allowEmptyOption: true,
            options: htmlOpts, // Використовуємо опції з HTML
            valueField: 'id', labelField: 'text', searchField: ['text']
        };
        const instance = new TomSelect(element, config);
        console.log(`TomSelect init for #${element.id}. HTML Opts: ${htmlOpts.length}, TS DOM Opts: ${instance.dropdown_content.querySelectorAll('.option').length}`);
        if (instance.dropdown_content.querySelectorAll('.option').length === 0 && htmlOpts.length > 0) {
            instance.addOptions(htmlOpts); instance.refreshOptions(false);
            htmlOpts.forEach(opt => { if(opt.selected) instance.addItem(opt.id, true);});
        }
        if (typeof onInitCallback === 'function') {
            onInitCallback(instance); // Колбек після ініціалізації
        }
        return instance;
    }

    // Фільтр для Технічних Завдань
    const ttUnitFilterElement = document.getElementById('id_tt-unit'); // ID з форми tt_filter_form
    const ttOidFilterElement = document.getElementById('id_tt-oid');

    let tsTtUnit = ttUnitFilterElement ? initFilterTomSelect(ttUnitFilterElement, 'Всі ВЧ') : null;
    let tsTtOid = ttOidFilterElement ? initFilterTomSelect(ttOidFilterElement, 'Всі ОІДи (оберіть ВЧ)', true) : null; // true - disabled
	// let tsTtOid = ttOidFilterElement ? initFilterTomSelect(ttOidFilterElement, 'Всі ОІДи (оберіть ВЧ)', !ttUnitFilterElement?.value) : null; 
    if (tsTtUnit && tsTtOid) {
        tsTtUnit.on('change', function(unitId){
            console.log("TT Filter: Unit changed to:", unitId);
            tsTtOid.clear(); tsTtOid.clearOptions(); tsTtOid.sync();
            if (unitId && unitId !== "") {
                tsTtOid.enable(); tsTtOid.placeholder = 'Завантаження ОІДів...';
                fetch(`${oidsForUnitUrl}?unit_id=${unitId}`)
                    .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t);}))
                    .then(data => {
                        const options = data.map(oid => ({id: oid.id.toString(), text: `${oid.cipher} (${oid.full_name || ''})`}));
                        tsTtOid.addOptions(options); tsTtOid.refreshOptions(false);
                        tsTtOid.placeholder = options.length ? 'Всі ОІДи для ВЧ' : 'Немає ОІДів';
                    }).catch(e => { tsTtOid.placeholder = 'Помилка ОІД'; });
            } else {
                tsTtOid.disable(); tsTtOid.placeholder = 'Всі ОІДи (оберіть ВЧ)';
            }
        });
        if (tsTtUnit.getValue()) tsTtUnit.trigger('change');
    }

    // Фільтр для Елементів Заявок
    const wriUnitFilterElement = document.getElementById('id_wri-unit'); // ID з форми wri_filter_form
    const wriOidFilterElement = document.getElementById('id_wri-oid');

    let tsWriUnit = wriUnitFilterElement ? initFilterTomSelect(wriUnitFilterElement, 'Всі ВЧ') : null;

	// let tsWriOid = wriOidFilterElement ? initFilterTomSelect(wriOidFilterElement, 'Всі ОІДи (оберіть ВЧ)', true) : null; // true - disabled
    let tsWriOid = wriOidFilterElement ? initFilterTomSelect(wriOidFilterElement, 'Всі ОІДи (оберіть ВЧ)', !wriUnitFilterElement?.value) : null;

    if (tsWriUnit && tsWriOid) {
		tsWriUnit.on('change', function(unitId){
			console.log("WRI Filter: Unit changed to:", unitId);
            tsWriOid.clear(); tsWriOid.clearOptions(); tsWriOid.sync();
            if (unitId && unitId !== "") {
				tsWriOid.enable(); tsWriOid.placeholder = 'Завантаження ОІДів...';
                fetch(`${oidsForUnitUrl}?unit_id=${unitId}`)
				.then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t);}))
                    .then(data => {
                        const options = data.map(oid => ({id: oid.id.toString(), text: `${oid.cipher} (${oid.full_name || ''})`}));
                        tsWriOid.addOptions(options); tsWriOid.refreshOptions(false);
                        tsWriOid.placeholder = options.length ? 'Всі ОІДи для ВЧ' : 'Немає ОІДів';
                    }).catch(e => { tsWriOid.placeholder = 'Помилка ОІД'; });
            } else {
                tsWriOid.disable(); tsWriOid.placeholder = 'Всі ОІДи (оберіть ВЧ)';
            }
        });
        if (tsWriUnit.getValue()) tsWriUnit.trigger('change');
    }
	
	function setupOidFilterCascade(unitSelectInstance, oidTomSelectInstance) {
		if (!unitSelectInstance || !oidTomSelectInstance) return;
        
        unitSelectInstance.on('change', function(unitId){
            oidTomSelectInstance.clear(); oidTomSelectInstance.clearOptions(); oidTomSelectInstance.sync();
            if (unitId && unitId !== "") {
                oidTomSelectInstance.enable(); oidTomSelectInstance.placeholder = 'Завантаження ОІДів...';
                fetch(`${oidsForUnitUrl}?unit_id=${unitId}`)
                    .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t);}))
                    .then(data => {
                        const options = data.map(oid => ({id: oid.id.toString(), text: `${oid.cipher} (${oid.full_name || ''})`}));
                        oidTomSelectInstance.addOptions(options); oidTomSelectInstance.refreshOptions(false);
                        oidTomSelectInstance.placeholder = options.length ? 'Всі ОІДи для ВЧ' : 'Немає ОІДів';
                    }).catch(e => { oidTomSelectInstance.placeholder = 'Помилка ОІД'; });
            } else {
                oidTomSelectInstance.disable(); oidTomSelectInstance.placeholder = 'Всі ОІДи (оберіть ВЧ)';
            }
        });
        if (unitSelectInstance.getValue()) unitSelectInstance.trigger('change');
    }
	if (tsTtUnit && tsTtOid) setupOidFilterCascade(tsTtUnit, tsTtOid);
    if (tsWriUnit && tsWriOid) setupOidFilterCascade(tsWriUnit, tsWriOid);
});
</script>
{% endblock %}

<!-- 
Що потрібно буде доопрацювати:

Пагінація для двох таблиць: Переконайтеся, що ваш pagination.html може коректно працювати з параметрами param_prefix та current_filters, щоб посилання пагінації для однієї таблиці не скидали фільтри/сторінку іншої. Можливо, доведеться генерувати URL для пагінації більш явно в JS або модифікувати логіку pagination.html.
Сортування: Аналогічно до попередніх сторінок, можна додати сортування для стовпців обох таблиць.
AJAX для фільтрів (опціонально): Замість перезавантаження всієї сторінки при застосуванні фільтрів, можна оновити тільки відповідну таблицю через AJAX.
Виділення протермінованих завдань: Передайте today_date = datetime.date.today() у контекст з view, щоб працювало підсвічування.
Це основа для вашої сторінки контролю. Почніть з цього, протестуйте фільтрацію та пагінацію. 
-->