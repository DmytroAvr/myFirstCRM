<!-- C:\myFirstCRM\oids\templates\oids\document_request.html -->
<style>
    body {
        font-family: 'Times New Roman', Times, serif;
        margin: auto;
        padding: 20px;
        max-width: 80%;
    }
    input[type="checkbox"][name$="-DELETE"] {
        display: none;
    }
    label[for$="-DELETE"] {
        display: none;
    }
    textarea {
        rows:4;
        cols:50;
    }
    p textarea {
    vertical-align: top; /* –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –ø–æ –≤–µ—Ä—Ö—É */
    height: 30px; /* –ü–æ—á–∞—Ç–∫–æ–≤–∞ –≤–∏—Å–æ—Ç–∞ */
    width: 400px; /* –®–∏—Ä–∏–Ω–∞ */
    min-height: 20px; /* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≤–∏—Å–æ—Ç–∞ */
}

</style>

<body>
    <form method="post">
        {% csrf_token %}

        <h3>–ó–∞—è–≤–∫–∞ –Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è —Ä–æ–±—ñ—Ç</h3>
        {{ header_form.as_p }}

        <h3>–û–Ü–î –≤ –∑–∞—è–≤—Ü—ñ:</h3>
        <div id="formset">
            <!-- {{ formset.management_form }}
            {% for form in formset %}
                <div class="document-form" style="border: 1px solid #ccc; margin: 10px; padding: 10px; position: relative;">
                    {{ form.as_p }}
                    <button type="button" class="remove-form">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
                </div>
            {% endfor %} -->
            {{ formset.management_form }}
            {% for form in formset %}
            <div class="document-form" data-form-index="{{ forloop.counter0 }}" style="border: 1px solid #ccc; margin: 10px; padding: 10px; position: relative;">
            {{ form.as_p }}
            <button type="button" class="remove-form">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
            {% endfor %}
        </div>

        <button type="button" id="add-form">‚ûï –î–æ–¥–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</button>
        <br><br>
        <button type="submit">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏</button>
    </form>
</body>

<script>
    document.querySelector('#id_unit').addEventListener('change', function () {
        const unitId = this.value;
        const oidSelect = document.querySelector('#id_oid');
        fetch(`/oids/ajax/load-oids/?unit=${unitId}`)
            .then(response => response.json())
            .then(data => {
                oidSelect.innerHTML = '';
                data.forEach(oid => {
                    const option = new Option(oid.name, oid.id);
                    oidSelect.add(option);
                });
            });
    });

    document.addEventListener('DOMContentLoaded', function () { 
        const unitSelect = document.querySelector('#id_unit');

        unitSelect.addEventListener('change', function () {
            const unitId = this.value;

            fetch(`/oids/ajax/load-oids/?unit=${unitId}`)
                .then(response => response.json())
                .then(data => {
                    // –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ —Ñ–æ—Ä–º–∏
                    document.querySelectorAll('.document-form').forEach((formDiv, index) => {
                        const oidSelect = formDiv.querySelector(`#id_form-${index}-oid`);
                        if (oidSelect) {
                            oidSelect.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç–∏


                            // –î–æ–¥–∞—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç
                            const emptyOption = document.createElement('option');
                            emptyOption.value = '';
                            emptyOption.textContent = '---------';
                            oidSelect.appendChild(emptyOption);

                            // –¢–µ–ø–µ—Ä –¥–æ–¥–∞—Ç–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ OID
                            data.forEach(oid => {
                                const option = document.createElement('option');
                                option.value = oid.id;
                                option.textContent = oid.name;
                                oidSelect.appendChild(option);
                            });
                        }
                    });
                });
        });
    });


    // button to add new form
    document.addEventListener('DOMContentLoaded', function () {
        const formset = document.getElementById('formset');
        const addFormBtn = document.getElementById('add-form');
        const totalForms = document.querySelector('#id_form-TOTAL_FORMS');

        function updateDeleteButtons() {
            document.querySelectorAll('.remove-form').forEach(btn => {
                btn.removeEventListener('click', removeForm);
                btn.addEventListener('click', removeForm);
            });
        }

        function removeForm(event) {
            const formDiv = event.target.closest('.document-form');
            formDiv.remove();
            // –û–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Ñ–æ—Ä–º
            const forms = document.querySelectorAll('.document-form');
            totalForms.value = forms.length;

            // –ü–µ—Ä–µ–Ω—É–º–µ—Ä–∞—Ü—ñ—è —ñ–Ω–ø—É—Ç—ñ–≤
            forms.forEach((form, index) => {
                form.querySelectorAll('input, select, textarea, label').forEach(el => {
                    if (el.name) el.name = el.name.replace(/form-\d+-/, `form-${index}-`);
                    if (el.id) el.id = el.id.replace(/form-\d+-/, `form-${index}-`);
                    if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/form-\d+-/, `form-${index}-`);
                });
            });
        }

        addFormBtn.addEventListener('click', function () {
            const forms = document.querySelectorAll('.document-form');
            const newForm = forms[0].cloneNode(true);
            const newIndex = forms.length;

            // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª—è
            newForm.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type !== 'hidden') el.value = '';
            });

            // –ó–º—ñ–Ω–∏—Ç–∏ name/id –Ω–∞ –Ω–æ–≤–∏–π —ñ–Ω–¥–µ–∫—Å
            newForm.querySelectorAll('input, select, textarea, label').forEach(el => {
                if (el.name) el.name = el.name.replace(/form-\d+-/, `form-${newIndex}-`);
                if (el.id) el.id = el.id.replace(/form-\d+-/, `form-${newIndex}-`);
                if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/form-\d+-/, `form-${newIndex}-`);
            });

            formset.appendChild(newForm);
            totalForms.value = newIndex + 1;
            updateDeleteButtons();
        });

        updateDeleteButtons();
    });
    
</script>