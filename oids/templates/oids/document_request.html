<!-- C:\myFirstCRM\oids\templates\oids\document_request.html -->
<style>
    body {
        font-family: 'Times New Roman', Times, serif;
        margin: auto;
        padding: 20px;
        max-width: 80%;
    }
    input, select{
        min-width: 300px;
    }
    input[type="checkbox"][name$="-DELETE"] {
        display: none;
    }
    label[for$="-DELETE"] {
        display: none;
    }
    textarea {
        rows:4;
        cols:50;
    }
    p textarea {
    vertical-align: top; /* –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –ø–æ –≤–µ—Ä—Ö—É */
    height: 30px; /* –ü–æ—á–∞—Ç–∫–æ–≤–∞ –≤–∏—Å–æ—Ç–∞ */
    width: 400px; /* –®–∏—Ä–∏–Ω–∞ */
    min-height: 20px; /* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≤–∏—Å–æ—Ç–∞ */
}
    .alert-success {
        color: rgb(69, 143, 9);
        text-align: center;
        font-size: 30;
        font-weight: 700;
    }
    

</style>

<body>
    <script>
        const selectedUnitId = document.querySelector('#id_unit')?.value;
    </script>
    <form method="post">
        {% csrf_token %}

        <h3>–ó–∞—è–≤–∫–∞ –Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è —Ä–æ–±—ñ—Ç</h3>
        {{ header_form.as_p }}

        <h3>–û–Ü–î –≤ –∑–∞—è–≤—Ü—ñ:</h3>
        <div id="formset">
           {{ formset.management_form }}

            {% for form in formset %}
            <div class="document-form" data-form-index="{{ forloop.counter0 }}" style="border: 1px solid #ccc; margin: 10px; padding: 10px; position: relative;">
                <div class="form-row">
                    <label for="{{ form.oid.id_for_label }}">–û–±‚Äô—î–∫—Ç —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–æ—ó –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ:</label>
                    {{ form.oid }}
                </div>
                <div class="form-row">
                    <label for="{{ form.work_type.id_for_label }}">–¢–∏–ø —Ä–æ–±–æ—Ç–∏:</label>
                    {{ form.work_type }}
                </div>                
                <br>
                <!-- –ö–Ω–æ–ø–∫–∏ –ø–æ—Ä—É—á —ñ–∑ –∫–æ–∂–Ω–∏–º oid-–ø–æ–ª–µ–º -->
                <button type="button" class="add-oid-button" style="margin-right: 30px;">‚ûï –î–æ–¥–∞—Ç–∏ –û–Ü–î</button>
                <button type="button" class="remove-form" style="background-color: #eedbdb;">üóë –í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–ª–µ</button>
            </div>
            {% endfor %}
        </div>
        
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-success">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <button type="button" id="add-form">‚ûï –î–æ–¥–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</button>
        <br><br>
        <button type="submit" style="background-color: #ddf5a5;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏</button>
    </form>


     <!-- 
    <button type="button" class="add-oid-button" style="margin-right: 30px;">‚ûï –î–æ–¥–∞—Ç–∏ –û–Ü–î</button> 
    -->
    <!-- script –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏ aside -->
    <script>
        let targetSelect = null; // –≥–ª–æ–±–∞–ª—å–Ω–æ –∑–±–µ—Ä–µ–∂–µ–º–æ, –≤ —è–∫–µ –ø–æ–ª–µ –≤—Å—Ç–∞–≤–∏—Ç–∏ –Ω–æ–≤–∏–π –û–Ü–î

        document.addEventListener("DOMContentLoaded", function () {
            const unitSelect = document.querySelector('#id_unit');

            // –ö–ª—ñ–∫ –ø–æ "–î–æ–¥–∞—Ç–∏ –û–Ü–î"
            document.querySelectorAll('.add-oid-button').forEach(button => {
                button.addEventListener('click', function (e) {
                    const unitId = unitSelect.value;
                    if (!unitId) {
                        alert("‚ö†Ô∏è –°–ø–µ—Ä—à—É –æ–±–µ—Ä—ñ—Ç—å –≤—ñ–π—Å—å–∫–æ–≤—É —á–∞—Å—Ç–∏–Ω—É —É —Ñ–æ—Ä–º—ñ –∑–≤–µ—Ä—Ö—É.");
                        return;
                    }
                    // –í–∏–∑–Ω–∞—á–∏—Ç–∏ select-oid, —è–∫–∏–π –ø–æ—Ä—É—á —ñ–∑ –∫–Ω–æ–ø–∫–æ—é
                    const formDiv = e.target.closest('.document-form');
                    targetSelect = formDiv.querySelector('select[name$="-oid"]');

                    // –í—ñ–¥–∫—Ä–∏—Ç–∏ aside + overlay
                    document.getElementById('oid-aside').style.display = "block";
                    document.getElementById('overlay').style.display = "block";
                });
            });

            // –ó–∞–∫—Ä–∏—Ç–∏ aside –≤—Ä—É—á–Ω—É
            document.getElementById('oid-aside-close').addEventListener('click', function () {
                document.getElementById('oid-aside').style.display = "none";
                document.getElementById('overlay').style.display = "none";
            });

            // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –û–Ü–î
            document.getElementById("oid-create-form").addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const currentUnitId = unitSelect.value;
                formData.append('unit_id', currentUnitId);

                // –∑–∞–ø—É—Å–∫–∞—î 
                // # D:\myFirstCRM\oids\urls.py
                // path('ajax/create/', views.create_oid_ajax, name='create_oid_ajax'),

                fetch("{% url 'create_oid_ajax' %}", {
                    method: "POST",
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("‚úÖ –û–Ü–î —Å—Ç–≤–æ—Ä–µ–Ω–æ");

                        // –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É —ñ –∑–∞–∫—Ä–∏—Ç–∏
                        this.reset();
                        document.getElementById('oid-aside').style.display = "none";
                        document.getElementById('overlay').style.display = "none";

                        if (targetSelect) {
                            const newOption = document.createElement('option');
                            newOption.value = data.oid.id;
                            newOption.textContent = data.oid.name;
                            newOption.selected = true;
                            targetSelect.appendChild(newOption);
                        }
                    } else {
                        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –û–Ü–î:\n" + JSON.stringify(data.errors));
                    }
                })
                .catch(err => {
                    console.error("‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–≤:", err);
                    alert("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–≤‚Äô—è–∑–∫—É —ñ–∑ —Å–µ—Ä–≤–µ—Ä–æ–º");
                });
            });
        });
    </script>
    <!-- Aside –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –û–Ü–î -->
    <aside id="oid-aside" style="display:none; position: fixed; z-index: 999; right: 0; top: 0; width: 300px; background: #f9f9f9; padding: 20px; border-left: 1px solid #ccc;">
        <h4>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –û–Ü–î –¥–æ –≤/—á <span id="insert_unit"></span></h4>
        <form id="oid-create-form">
            {% csrf_token %}
            <label for="id_name">–ù–∞–∑–≤–∞ –û–Ü–î:</label>
            <input type="text" name="name" id="id_name" required><br>

            <label for="id_room">–ü—Ä–∏–º—ñ—â–µ–Ω–Ω—è:</label>
            <input type="text" name="room" id="id_room"><br>

            <label for="id_oid_type">–¢–∏–ø –û–Ü–î:</label>
            <select name="oid_type" id="id_oid_type">
                <option value="–ü–ï–ú–Ü–ù">–ü–ï–ú–Ü–ù</option>
                <option value="–ú–û–í–ù–ê">–ú–û–í–ù–ê</option>
            </select><br>
    
            <label for="id_status">–°—Ç–∞—Ç—É—Å:</label>
            <select name="status" id="id_status">
                <option value="—Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è">–°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è</option>
                <option value="–¥—ñ—é—á–∏–π">–î—ñ—é—á–∏–π</option>
            </select><br>

            <label for="id_note">–ü—Ä–∏–º—ñ—Ç–∫–∞:</label>
            <textarea name="note" id="id_note"></textarea><br><br>

            <button type="submit" style="background-color: #ddf5a5;">‚ûï –î–æ–¥–∞—Ç–∏ –û–Ü–î</button>
            <button type="button" id="oid-aside-close" onclick="document.getElementById('oid-aside').style.display='none'">‚úñ –ó–∞–∫—Ä–∏—Ç–∏</button>
            <!-- <button type="button" id="oid-aside-close">‚úñ –ó–∞–∫—Ä–∏—Ç–∏</button> -->

        </form>
    </aside>
        <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:998;"></div>

</body>

<script>

    // —Ñ—ñ–ª—å—Ç—Ä –û–Ü–î –Ω–∞ –±–∞–∑—ñ —á–∞—Ç–∏–Ω–∏ –¥–ª—è –æ–¥–Ω—ñ—î—ó form
    // document.querySelector('#id_unit').addEventListener('change', function () {
    //     const unitId = this.value;
    //     const oidSelect = document.querySelector('#id_oid');
    //     fetch(`/oids/ajax/load-oids/?unit=${unitId}`)
    //         .then(response => response.json())
    //         .then(data => {
    //             oidSelect.innerHTML = '';
    //             data.forEach(oid => {
    //                 const option = new Option(oid.name, oid.id);
    //                 oidSelect.add(option);
    //             });
    //         });
    // });
        
        
    // js –¥–ª—è –æ–¥–∏–Ω –û–Ü–î –∑ requestHeaderForm —è–∫ —Ñ—ñ–ª—å—Ç—Ä –≤ —É—Å—ñ requestItemFormSet
    document.addEventListener('DOMContentLoaded', function () { 
        const unitSelect = document.querySelector('#id_unit');

        unitSelect.addEventListener('change', function () {
            const unitId = this.value;

            fetch(`/oids/ajax/load-oids/?unit=${unitId}`)
                .then(response => response.json())
                .then(data => {
                    // –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ —Ñ–æ—Ä–º–∏
                    document.querySelectorAll('.document-form').forEach((formDiv, index) => {
                        const oidSelect = formDiv.querySelector(`#id_form-${index}-oid`);
                        if (oidSelect) {
                            oidSelect.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç–∏

                            // –î–æ–¥–∞—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç
                            const emptyOption = document.createElement('option');
                            emptyOption.value = '';
                            emptyOption.textContent = '---------';
                            oidSelect.appendChild(emptyOption);

                            // –¢–µ–ø–µ—Ä –¥–æ–¥–∞—Ç–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ OID
                            data.forEach(oid => {
                                const option = document.createElement('option');
                                option.value = oid.id;
                                option.textContent = oid.name;
                                oidSelect.appendChild(option);
                            });
                        }
                    });
                });
        });
    });

   
    // button to add one more form !!!! requestItemFormSet
    document.addEventListener('DOMContentLoaded', function () {
        const formset = document.getElementById('formset');
        const addFormBtn = document.getElementById('add-form');
        const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
        
        
        function updateDeleteButtons() {
            document.querySelectorAll('.remove-form').forEach(btn => {
                btn.removeEventListener('click', removeForm);
                btn.addEventListener('click', removeForm);
            });
        }

        function removeForm(event) {
            const formDiv = event.target.closest('.document-form');
            formDiv.remove();
            // –û–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Ñ–æ—Ä–º
            const forms = document.querySelectorAll('.document-form');
            totalForms.value = forms.length;

            // –ü–µ—Ä–µ–Ω—É–º–µ—Ä–∞—Ü—ñ—è —ñ–Ω–ø—É—Ç—ñ–≤
            forms.forEach((form, index) => {
                form.querySelectorAll('input, select, textarea, label').forEach(el => {
                    if (el.name) el.name = el.name.replace(/form-\d+-/, `form-${index}-`);
                    if (el.id) el.id = el.id.replace(/form-\d+-/, `form-${index}-`);
                    if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/form-\d+-/, `form-${index}-`);
                });
            });
        }

        addFormBtn.addEventListener('click', function () {
            const forms = document.querySelectorAll('.document-form');
            const newForm = forms[0].cloneNode(true);
            const newIndex = forms.length;

            // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª—è
            newForm.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type !== 'hidden') el.value = '';
            });

            // –ó–º—ñ–Ω–∏—Ç–∏ name/id –Ω–∞ –Ω–æ–≤–∏–π —ñ–Ω–¥–µ–∫—Å
            newForm.querySelectorAll('input, select, textarea, label').forEach(el => {
                if (el.name) el.name = el.name.replace(/form-\d+-/, `form-${newIndex}-`);
                if (el.id) el.id = el.id.replace(/form-\d+-/, `form-${newIndex}-`);
                if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/form-\d+-/, `form-${newIndex}-`);
            });

            formset.appendChild(newForm);
            totalForms.value = newIndex + 1;
            updateDeleteButtons();
        });

        updateDeleteButtons();
    });
    
</script>