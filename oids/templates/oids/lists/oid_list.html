{# oids/templates/oids/lists/oid_list.html #}
{% extends "oids/base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
	 <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{{ page_title }}</h2>
        <div>
            <a href="?{{ request.GET.urlencode }}&export=excel" class="btn btn-success">
                Експорт в Excel
            </a>
        </div>
    </div>

	{# Форма для фільтрації ОІД #}
	{# --- НОВА ФОРМА ФІЛЬТРІВ --- #}
<form method="GET" class="mb-4 p-3 border bg-light rounded">
    <div class="row g-3">
        <div class="col-md-4">
            {{ form.city.label_tag }}
            {{ form.city }}
        </div>
        <div class="col-md-4">
            {{ form.unit.label_tag }}
            {{ form.unit }}
        </div>
        <div class="col-md-2">
            {{ form.oid_type.label_tag }}
            {{ form.oid_type }}
        </div>
        <div class="col-md-2">
            {{ form.pemin_sub_type.label_tag }}
            {{ form.pemin_sub_type }}
        </div>
        <div class="col-md-2">
            {{ form.status.label_tag }}
            {{ form.status }}
        </div>
        <div class="col-md-2">
            {{ form.sec_level.label_tag }}
            {{ form.sec_level }}
        </div>
    </div>
    <div class="row g-3 mt-2">
        <div class="col-md-8">
            {{ form.search_query.label_tag }}
            {{ form.search_query }}
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-primary w-100">Фільтрувати</button>
        </div>
        <div class="col-md-2 align-self-end">
            <a href="{% url 'oids:list_oids' %}" class="btn btn-secondary w-100">Скинути</a>
        </div>
    </div>
</form>

	{# <a href="URL_ДЛЯ_ДОДАВАННЯ_ОІД" class="btn btn-primary mb-3">Додати новий ОІД</a> #}

	{% if object_list %}
	<div class="table-responsive">
		<table class="table table-striped table-bordered table-hover">
			<thead class="thead-dark">
				<tr>
					{% url 'oids:list_oids' as list_url %}
					{# Побудова базових параметрів для фільтрації, щоб не втрачати їх при сортуванні #}
					{% with unit_param=current_filter_unit_id|default_if_none:""|stringformat:"s" type_param=current_filter_oid_type|default_if_none:"" status_param=current_filter_status|default_if_none:"" sec_param=current_filter_sec_level|default_if_none:"" search_param=current_search_query|default_if_none:"" %}
					{% with base_filter_params="filter_unit="|add:unit_param|add:"&filter_oid_type="|add:type_param|add:"&filter_status="|add:status_param|add:"&filter_sec_level="|add:sec_param|add:"&search_query="|add:search_param %}
					<th>№ з/п</th>
					<th>
						<a href="{{ list_url }}?sort_by=city&sort_order={% if current_sort_by == 'city' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							Місто {% if current_sort_by == 'city' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>
						<a href="{{ list_url }}?sort_by=unit&sort_order={% if current_sort_by == 'unit' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							ВЧ {% if current_sort_by == 'unit' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>
						<a href="{{ list_url }}?sort_by=cipher&sort_order={% if current_sort_by == 'cipher' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							ОІД (Шифр) {% if current_sort_by == 'cipher' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>
						<a href="{{ list_url }}?sort_by=full_name&sort_order={% if current_sort_by == 'full_name' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							Повна назва {% if current_sort_by == 'full_name' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>
						<a href="{{ list_url }}?sort_by=oid_type&sort_order={% if current_sort_by == 'oid_type' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							Тип {% if current_sort_by == 'oid_type' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>
						<a href="{{ list_url }}?sort_by=pemin_sub_type&sort_order={% if current_sort_by == 'pemin_sub_type' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							Клас {% if current_sort_by == 'pemin_sub_type' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>
						<a href="{{ list_url }}?sort_by=room&sort_order={% if current_sort_by == 'room' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							Приміщення {% if current_sort_by == 'room' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>
						<a href="{{ list_url }}?sort_by=status&sort_order={% if current_sort_by == 'status' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							Стан {% if current_sort_by == 'status' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>
						<a href="{{ list_url }}?sort_by=sec_level&sort_order={% if current_sort_by == 'sec_level' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							Гриф {% if current_sort_by == 'sec_level' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>Примітки</th>
					<th>
						<a href="{{ list_url }}?sort_by=created_at&sort_order={% if current_sort_by == 'created_at' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
							Дата внесення ОІД {% if current_sort_by == 'created_at' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
						</a>
					</th>
					<th>Дії</th>
					{% endwith %}
					{% endwith %}
				</tr>
			</thead>
			<tbody>
				{% for oid_item in object_list %}
				<tr>
					<td>{{ page_obj.start_index|add:forloop.counter0 }}.</td>
					<td>
						{% if oid_item.unit.city %}{{ oid_item.unit.city }}
						{% else %}
						N/A
						{% endif %}
					</td>
					<td>
						{% if oid_item.unit %} {{ oid_item.unit.code }}						
						{% else %}
						N/A
						{% endif %}
					</td>
					<td>
						<a href="{% url 'oids:oid_detail_view_name' oid_item.id %}">
							{{ oid_item.cipher }}
						</a>
					</td>
					<td>{{ oid_item.full_name|default_if_none:"Не вказано" }}</td>
					<td>{{ oid_item.get_oid_type_display }}</td>
					<td>{{ oid_item.get_pemin_sub_type_display|default:"-" }}</td>
					<td>{{ oid_item.room|default_if_none:"-" }}</td>
					<td>{{ oid_item.get_status_display }}</td>
					<td>{{ oid_item.get_sec_level_display }}</td>
					<td>{{ oid_item.note|truncatewords:10|default:"-" }}</td>
					<td>{{ oid_item.created_at|date:"d.m.Y H:i"|default:"-" }}</td>
					<td>
						<a href="{% url 'oids:oid_detail_view_name' oid_item.id %}" class="btn btn-sm btn-info">Деталі</a>
						{# <a href="#" class="btn btn-sm btn-warning">Редагувати</a> #}
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	{% if page_obj %}
	{% include "../includes/pagination.html" with page_obj=page_obj sort_by=current_sort_by sort_order=current_sort_order_is_desc|yesno:"desc,asc" filter_unit=current_filter_unit_id filter_oid_type=current_filter_oid_type filter_status=current_filter_status filter_sec_level=current_filter_sec_level search_query=current_search_query %}
	{% endif %}
	{% else %}
	<p>Об'єкти інформаційної діяльності не знайдено (або не відповідають критеріям фільтрації).</p>
	{% if current_filter_unit_id or current_filter_oid_type or current_filter_status or current_filter_sec_level or current_search_query %}
	<a href="{% url 'oids:list_oids' %}" class="btn btn-primary">Скинути всі фільтри</a>
	{% endif %}
	{% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof TomSelect !== 'undefined') {
        console.log("Initializing TomSelect for OID list filters...");
        // Знаходимо всі поля з класом 'tomselect-field'
        document.querySelectorAll('.tomselect-field').forEach(function(element) {
            new TomSelect(element, {
                // TomSelect автоматично розпізнає атрибут 'multiple'
                // і ввімкне режим множинного вибору.
                plugins: ['remove_button'], // Додає 'хрестик' для видалення обраних елементів
            });
        });
    }
});
</script>
{% endblock %}