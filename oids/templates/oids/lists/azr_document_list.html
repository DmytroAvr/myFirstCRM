{% extends "oids/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>{{ page_title }}</h3>
        <a href="?{{ request.GET.urlencode }}&export=1" class="btn btn-success">
            <i class="fas fa-file-excel"></i> Експорт в Excel
        </a>
    </div>

    {# --- ОНОВЛЕНА ФОРМА ФІЛЬТРАЦІЇ --- #}
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" id="filter-form">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ filter_form.unit.id_for_label }}" class="form-label">{{ filter_form.unit.label }}</label>
                        {{ filter_form.unit }}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ filter_form.oid.id_for_label }}" class="form-label">{{ filter_form.oid.label }}</label>
                        {{ filter_form.oid }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ filter_form.document_number.id_for_label }}" class="form-label">{{ filter_form.document_number.label }}</label>
                        {{ filter_form.document_number }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ filter_form.registered_number.id_for_label }}" class="form-label">{{ filter_form.registered_number.label }}</label>
                        {{ filter_form.registered_number }}
                    </div>
                    <div class="col-md-2">
                        <label for="{{ filter_form.date_from.id_for_label }}" class="form-label">{{ filter_form.date_from.label }}</label>
                        {{ filter_form.date_from }}
                    </div>
                    <div class="col-md-2">
                        <label for="{{ filter_form.date_to.id_for_label }}" class="form-label">{{ filter_form.date_to.label }}</label>
                        {{ filter_form.date_to }}
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Фільтрувати</button>
                    <a href="{% url 'oids:list_azr_documents' %}" class="btn btn-outline-secondary">Скинути</a>
                </div>
            </form>
        </div>
    </div>

    {# --- ТАБЛИЦЯ З ДАНИМИ --- #}
    <div class="card">
        <div class="card-body table-responsive">
            <table class="table table-hover">
                   <thead>
						<tr>
							<th><a href="?{{ sort_url_part }}&sort={% if current_sort == 'oid__unit__code' %}-{% endif %}oid__unit__code">ВЧ</a></th>
							<th><a href="?{{ sort_url_part }}&sort={% if current_sort == 'oid__cipher' %}-{% endif %}oid__cipher">Шифр ОІД</a></th>
							<th><a href="?{{ sort_url_part }}&sort={% if current_sort == 'document_number' %}-{% endif %}document_number">Підг. №</a></th>
							<th><a href="?{{ sort_url_part }}&sort={% if current_sort == 'process_date' %}-{% endif %}process_date">Від</a></th>
							<th><a href="?{{ sort_url_part }}&sort={% if current_sort == 'dsszzi_registered_number' %}-{% endif %}dsszzi_registered_number">Зареєстрований №</a></th>
							<th><a href="?{{ sort_url_part }}&sort={% if current_sort == 'dsszzi_registered_date' %}-{% endif %}dsszzi_registered_date">Від якого числа</a></th>
						</tr>
					</thead>
                <tbody>
                    {% for doc in documents %}
                    <tr>
                        <td>{{ doc.oid.unit.code }}</td>
                        <td><a href="{% url 'oids:oid_detail_view_name' doc.oid.id %}">{{ doc.oid.cipher }}</a></td>
                        <td>{{ doc.document_number }}</td>
                        <td>{{ doc.process_date|date:"d.m.Y" }}</td>
                        <td>{{ doc.dsszzi_registered_number|default:"-" }}</td>
                        <td>{{ doc.dsszzi_registered_date|date:"d.m.Y"|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">Документи не знайдено.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% include "oids/includes/pagination.html" with page_obj=documents %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Ініціалізуємо TomSelect для поля ВЧ
    const unitSelect = new TomSelect('#id_filter_unit', {
        plugins: ['remove_button'],
        placeholder: 'Оберіть ВЧ...'
    });

    // Ініціалізуємо TomSelect для поля ОІД
    const oidSelect = new TomSelect('#id_filter_oid', {
        plugins: ['remove_button'],
        placeholder: 'Спочатку оберіть ВЧ...',
        valueField: 'id',
        labelField: 'text',
        searchField: ['text']
    });

    // Спочатку поле ОІДів неактивне
    oidSelect.disable();

    // Функція для завантаження ОІДів
    const loadOidsForUnits = (unitIds) => {
        // Зберігаємо поточний вибір, щоб відновити його після завантаження
        const selectedOids = oidSelect.items;
        
        oidSelect.clear();
        oidSelect.clearOptions();
        oidSelect.disable();

        if (!unitIds || unitIds.length === 0) {
            return;
        }
        
        const url = `{% url 'oids:ajax_load_oids_for_multiple_units' %}?unit_ids[]=${unitIds.join('&unit_ids[]=')}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const options = data.map(oid => ({
                    id: oid.id.toString(),
                    text: `${oid.cipher} (${oid.oid_type_display})`
                }));
                oidSelect.addOptions(options);
                oidSelect.enable();
                // Відновлюємо попередній вибір, якщо опції для нього ще існують
                selectedOids.forEach(oidId => {
                    if (oidSelect.getOption(oidId)) {
                        oidSelect.addItem(oidId, true); // true - без виклику події 'change'
                    }
                });
            })
            .catch(error => console.error('Помилка завантаження ОІДів:', error));
    };

    // Слухач подій для зміни ВЧ
    unitSelect.on('change', (value) => {
        loadOidsForUnits(value);
    });

    // Початкове завантаження ОІДів, якщо ВЧ вже обрані (наприклад, після перезавантаження сторінки з фільтром)
    if (unitSelect.items.length > 0) {
        loadOidsForUnits(unitSelect.items);
    }
});
</script>
{% endblock %}