{% extends "oids/base.html" %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">{{ page_title }}</h2>
    <a href="{% url 'oids:send_attestation_for_registration' %}" class="btn btn-primary mb-3">
        <i class="fas fa-plus"></i> Сформувати нову відправку
    </a>

    {# Форма фільтрації - проста #}
    <form method="get" class="mb-3 p-3 border bg-light rounded">
        <div class="row g-2">
            <div class="col-md-4">
                <label for="id_filter_status" class="form-label">Статус відправки:</label>
                <select name="status" id="id_filter_status" class="form-select form-select-sm">
                    <option value="">Всі статуси</option>
                    {% for val, text in status_choices %}
                        <option value="{{ val }}" {% if current_filter_status == val %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="id_filter_unit" class="form-label">Військова частина:</label>
                 <select name="unit_id" id="id_filter_unit" class="form-select form-select-sm">
                    <option value="">Всі ВЧ</option>
                    {% for unit_opt in all_units %}
                        <option value="{{ unit_opt.id }}" {% if current_filter_unit_id == unit_opt.id %}selected{% endif %}>{{ unit_opt.code }} - {{ unit_opt.name|default_if_none:"" }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-secondary btn-sm w-100">Фільтрувати</button>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <a href="{% url 'oids:list_attestation_registrations' %}" class="btn btn-outline-secondary btn-sm w-100">Скинути</a>
            </div>
        </div>
    </form>


    {% if object_list %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Вихідний № листа</th>
                    <th>Дата вих. листа</th>
                    <th>ВЧ (у відправці)</th>
                    <th>К-ть Актів</th>
                    <th>Хто відправив</th>
                    <th>Статус</th>
                    <th>Дії</th>
                </tr>
            </thead>
            <tbody>
                {% for reg in object_list %}
                <tr>
                    <td>{{ reg.outgoing_letter_number }}</td>
                    <td>{{ reg.outgoing_letter_date|date:"d.m.Y" }}</td>
                    <td>
                        {% for unit_obj in reg.units.all %}
                            {{ unit_obj.code }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            (не вказано)
                        {% endfor %}
                    </td>
                    <td>{{ reg.registered_documents.count }}</td> {# Кількість документів, пов'язаних з цією відправкою #}
                    <td>{{ reg.sent_by.full_name|default:"-" }}</td>
                    <td><span class="badge bg-info text-dark">{{ reg.get_status_display }}</span></td>
                    <td>
                        {% if reg.status == 'sent' %}
                        <a href="{% url 'oids:record_attestation_response_for_registration' reg.id %}" class="btn btn-sm btn-success">
                            Внести відповідь
                        </a>
                        {% elif reg.response_received %}
                         <a href="#" class="btn btn-sm btn-outline-secondary disabled">Відповідь внесено</a>
                         {# TODO: Посилання на перегляд/редагування відповіді #}
                        {% endif %}
                        {# TODO: Посилання на деталі відправки #}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
        {% include "../includes/pagination.html" with page_obj=page_obj status=current_filter_status unit_id=current_filter_unit_id %}
    {% else %}
        <p>Відправки на реєстрацію відсутні.</p>
    {% endif %}
</div>
{% endblock %}