{# oids/templates/oids/lists/work_request_list.html #}
{% extends "oids/base.html" %}
{% load my_custom_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{{ page_title }}</h2>
        <div>
            <a href="{% url 'oids:add_work_request' %}" class="btn btn-primary">Додати нову Заявку</a>
            
            {# --- НОВА КНОПКА ЕКСПОРТУ --- #}
            <a href="?{{ request.GET.urlencode }}&export=excel" class="btn btn-success">
                Експорт в Excel
            </a>
        </div>
    </div>
{# oids/templates/oids/lists/work_request_list.html #}

{# --- НОВА ФОРМА ФІЛЬТРІВ --- #}
<form method="GET" class="mb-4 p-3 border bg-light rounded">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            {{ form.unit.label_tag }}
            {{ form.unit }}
        </div>
        <div class="col-md-2">
            {{ form.status.label_tag }}
            {{ form.status }}
        </div>
        <div class="col-md-3">
            {{ form.date_from.label_tag }}
            {{ form.date_from }}
        </div>
        <div class="col-md-3">
            {{ form.date_to.label_tag }}
            {{ form.date_to }}
        </div>
    </div>
    <div class="row g-3 mt-2">
        <div class="col-md-8">
            {{ form.search_query.label_tag }}
            {{ form.search_query }}
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-primary w-100">Фільтрувати</button>
        </div>
        <div class="col-md-2 align-self-end">
            <a href="{% url 'oids:list_work_requests' %}" class="btn btn-secondary w-100">Скинути</a>
        </div>
    </div>
</form>

    {% if object_list %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
                <thead class="thead-dark">
                    <tr>
                        {% url 'oids:list_work_requests' as list_url %}
                        {% with unit_param=current_filter_unit_id|default_if_none:""|stringformat:"s" status_param=current_filter_status|default_if_none:"" date_from_param=current_filter_date_from|default_if_none:"" date_to_param=current_filter_date_to|default_if_none:"" search_param=current_search_query|default_if_none:"" %}
                        {% with base_filter_params="filter_unit="|add:unit_param|add:"&filter_status="|add:status_param|add:"&filter_date_from="|add:date_from_param|add:"&filter_date_to="|add:date_to_param|add:"&search_query="|add:search_param %}
                        <th>№<br>з/п</th>
						<th>
                            <a href="{{ list_url }}?sort_by=unit&sort_order={% if current_sort_by == 'unit' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
                                ВЧ {% if current_sort_by == 'unit' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{{ list_url }}?sort_by=number&sort_order={% if current_sort_by == 'number' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
                                Вх. номер заявки {% if current_sort_by == 'number' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{{ list_url }}?sort_by=date&sort_order={% if current_sort_by == 'date' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
                                Вх. дата заявки {% if current_sort_by == 'date' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{{ list_url }}?sort_by=status&sort_order={% if current_sort_by == 'status' and not current_sort_order_is_desc %}desc{% else %}asc{% endif %}&{{ base_filter_params }}">
                                Статус {% if current_sort_by == 'status' %}{% if current_sort_order_is_desc %}▼{% else %}▲{% endif %}{% endif %}
                            </a>
                        </th>
                        <th>ОІДи в заявці (Тип робіт / Статус по ОІД)</th>
                        <th>Примітки</th>
                        <th>Дії</th>
                        {% endwith %}
                        {% endwith %}
                    </tr>
                </thead>
                <tbody>
					<!-- wr це змінна для work_request -->
                    {% for wr in object_list %}
                        <tr>
							<td>{{ page_obj.start_index|add:forloop.counter0 }}.</td>
                            <td>
                                {% if wr.unit %}
                                <a href="{% url 'oids:main_dashboard' %}?unit={{ wr.unit.id }}">
                                    {{ wr.unit.code }}
                                </a>
                                {% else %} N/A {% endif %}
                            </td>
                            <td>{{ wr.incoming_number }}</td>
                            <td>{{ wr.incoming_date|date:"d.m.Y" }}</td>
                            <td><span class=" bg-{{ wr.status.name }}">{{ wr.get_status_display }}</span></td> {# Додав трохи стилю для статусу #}
                            <td>
                                {% if wr.items.all %}
                                <ul class="list-unstyled mb-0">
                                    {% for item in wr.items.all %}
                                        <li>
                                            <a href="{% url 'oids:oid_detail_view_name' item.oid.id %}">{{ item.oid.cipher }}</a>
                                            <small class="text-muted">({{ item.get_work_type_display }} / {{ item.get_status_display }})</small>
                                        </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                    <small class="text-muted">Немає ОІД</small>
                                {% endif %}
                            </td>
                            <td>{{ wr.note|truncatewords:10|default:"-" }}</td>
                           <td>
								{% if wr.pk %}
									<a href="{% url 'oids:work_request_detail' pk=wr.pk %}" class="btn btn-sm btn-outline-primary">Деталі</a>
								{% else %}
									<span class="text-danger">Помилка: відсутній ID</span>
								{% endif %}
							</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if page_obj %}
            {% include "../includes/pagination.html" with page_obj=page_obj sort_by=current_sort_by sort_order=current_sort_order_is_desc|yesno:"desc,asc" filter_unit=current_filter_unit_id filter_status=current_filter_status filter_date_from=current_filter_date_from filter_date_to=current_filter_date_to search_query=current_search_query query=query %}
        {% endif %}
    {% else %}
        <p>Заявки на проведення робіт не знайдено (або не відповідають критеріям фільтрації).</p>
        {% if current_filter_unit_id or current_filter_status or current_filter_date_from or current_filter_date_to or current_search_query %}
         <a href="{% url 'oids:list_work_requests' %}" class="btn btn-primary">Скинути всі фільтри</a>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof TomSelect !== 'undefined') {
        document.querySelectorAll('.tomselect-field').forEach(function(element) {
            new TomSelect(element, {
                plugins: ['remove_button'],
            });
        });
    }
});
</script>
{% endblock %}