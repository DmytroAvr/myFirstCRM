<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Форма ознайомлення з ОІД</title>
  <style>
    h2 {
      text-align: center;
    }
    :root {
      --bg-light: #ffffff;
      --bg-dark: #1a1a1a;
      --text-light: #1a1a1a;
      --text-dark: #f0f0f0;
      --input-bg-light: #f9f9f9;
      --input-bg-dark: #2c2c2c;
      --border-light: #cccccc;
      --border-dark: #444444;
      --btn-bg-light: #e0e0e0;
      --btn-bg-dark: #333333;
      --btn-text-light: #000;
      --btn-text-dark: #fff;
    }

    body {
      margin: 20px;
      font-family: sans-serif;
      background-color: var(--bg-light);
      color: var(--text-light);
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-theme {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    .theme-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: transparent;
      color: inherit;
      border: 1px solid currentColor;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.9rem;
      border-radius: 5px;
    }

    form {
      max-width: 800px;
      margin: auto;
    }

    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.3rem;
    }

    select, input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-light);
      background-color: var(--input-bg-light);
      color: var(--text-light);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    .dark-theme select,
    .dark-theme input,
    .dark-theme textarea {
      background-color: var(--input-bg-dark);
      color: var(--text-dark);
      border: 1px solid var(--border-dark);
    }

    .inline-note {
      display: inline-block;
      margin: 10px 10px 10px 0;
    }

    button {
      margin-top: 20px;
      padding: 8px 14px;
      font-size: 0.95rem;
      border-radius: 5px;
      cursor: pointer;
      border: 1px solid var(--border-light);
      background-color: var(--btn-bg-light);
      color: var(--btn-text-light);
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-theme button {
      background-color: var(--btn-bg-dark);
      color: var(--btn-text-dark);
      border: 1px solid var(--border-dark);
    }

    .add-oid-button {
      background-color: #cdeafe;
      color: #000;
      margin-left: 10px;
    }

    .dark-theme .add-oid-button {
      background-color: #2f5d7e;
      color: #fff;
    }
  </style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()">Змінити тему</button>


{% block content %}
<h2>Додати технічне завдання</h2>

<form id="my-form" method="post">
  {% csrf_token %}
  {{ form.unit.label_tag }} {{ form.unit }}
  <br>
  {{ form.oid.label_tag }}
  <select name="oid" id="id_oid">
    <option value="">---------</option>
    {% for oid in form.fields.oid.queryset %}
    <option value="{{ oid.id }}">{{ oid.name }}</option>
    {% endfor %}
  </select>
  <p style="display: inline;">         - Не знайшли потрібного ОІД?  </p><button type="button" class="add-oid-button" style="margin-right: 30px;">➕ Додати ОІД</button> 

  <br><br>
  {{ form.input_number.label_tag }} {{ form.input_number }}
  {{ form.input_date.label_tag }} {{ form.input_date }}
  {{ form.reviewed_by.label_tag }} {{ form.reviewed_by }}
  {{ form.review_result.label_tag }} {{ form.review_result }}
  {{ form.note.label_tag }} {{ form.note }}

  <br>
  <button type="submit">Зберегти</button>
</form>
<!-- alert - "Дані збережено" для id="my-form" -->
<script>
    document.getElementById("my-form").addEventListener("submit", function(e) {
        e.preventDefault();  // зупиняє стандартне відправлення
        const formData = new FormData(this);

        fetch(this.action, {
            method: "POST",
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken') // якщо треба
            }
        })
        .then(response => {
            if (response.ok) {
                alert("✅ Дані збережено!");
                location.reload();  // або redirect, якщо треба
            } else {
                alert("⚠️ Помилка при збереженні.");
            }
        });
    });

    // Функція для отримання CSRF-токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
<!-- Посилання на створення нового ОІД -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

{% endblock %}

<script>
  $('#id_unit').change(function() {
    var unitId = $(this).val();
    $.ajax({
      url: '{% url "ajax_load_oids_for_unit" %}',
      data: {'unit': unitId},
      success: function(data) {
        var $oid = $('#id_oid');
        $oid.empty();
        $oid.append('<option value="">---------</option>');
        data.forEach(function(item) {
          $oid.append('<option value="' + item.id + '">' + item.name + '</option>');
        });
      }
    });
  });
</script>


     <!-- 
    <button type="button" class="add-oid-button" style="margin-right: 30px;">➕ Додати ОІД</button> 
    -->
    <!-- script для забезпечення роботи aside -->
    <script>
        let targetSelect = null; // глобально збережемо, в яке поле вставити новий ОІД

        document.addEventListener("DOMContentLoaded", function () {
            const unitSelect = document.querySelector('#id_unit');

            // Клік по "Додати ОІД"
            document.querySelectorAll('.add-oid-button').forEach(button => {
                button.addEventListener('click', function (e) {
                    const unitId = unitSelect.value;
                    if (!unitId) {
                        alert("⚠️ Спершу оберіть військову частину у формі зверху.");
                        return;
                    }
                    // Визначити select-oid, який поруч із кнопкою
                    
                    const formDiv = e.target.closest('form');
                    targetSelect = formDiv.querySelector('#id_oid');

                    // Відкрити aside + overlay
                    document.getElementById('oid-aside').style.display = "block";
                    document.getElementById('overlay').style.display = "block";
                });
            });

            // Закрити aside вручну
            document.getElementById('oid-aside-close').addEventListener('click', function () {
                document.getElementById('oid-aside').style.display = "none";
                document.getElementById('overlay').style.display = "none";
            });

            // Відправка форми створення ОІД
            document.getElementById("oid-create-form").addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const currentUnitId = unitSelect.value;
                formData.append('unit_id', currentUnitId);

                fetch("{% url 'create_oid_ajax' %}", {
                    method: "POST",
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("✅ ОІД створено");

                        // Очистити форму і закрити
                        this.reset();
                        document.getElementById('oid-aside').style.display = "none";
                        document.getElementById('overlay').style.display = "none";

                        if (targetSelect) {
                            const newOption = document.createElement('option');
                            newOption.value = data.oid.id;
                            newOption.textContent = data.oid.name;
                            newOption.selected = true;
                            targetSelect.appendChild(newOption);
                        }
                    } else {
                        alert("❌ Помилка створення ОІД:\n" + JSON.stringify(data.errors));
                    }
                })
                .catch(err => {
                    console.error("❌ Сервер не відповів:", err);
                    alert("⚠️ Помилка зв’язку із сервером");
                });

                
            });
        });
    </script>
    <!-- Aside для створення ОІД -->
    <aside id="oid-aside" style="display:none; position: fixed; z-index: 999; right: 0; top: 0; width: 300px; background: #f9f9f9; padding: 20px; border-left: 1px solid #ccc;">
        <h4>Додати новий ОІД до в/ч <span id="insert_unit"></span></h4>
        <form id="oid-create-form">
            {% csrf_token %}
            <label for="id_name">Назва ОІД:</label>
            <input type="text" name="name" id="id_name" required><br>

            <label for="id_sec_level">Гриф:</label>
            <select name="sec_level" id="id_sec_level">
                <option value="Т">Т</option>
                <option value="Цілком Т">ЦТ</option>
            </select><br>

            <label for="id_room">Приміщення:</label>
            <input type="text" name="room" id="id_room"><br>

            <label for="id_oid_type">Тип ОІД:</label>
            <select name="oid_type" id="id_oid_type">
                <option value="ПЕМІН">ПЕМІН</option>
                <option value="МОВНА">МОВНА</option>
            </select><br>
    
            <label for="id_status">Статус:</label>
            <select name="status" id="id_status">
                <option value="створюється">Створюється</option>
                <option value="діючий">Діючий</option>
            </select><br>

            <label for="id_note">Примітка:</label>
            <textarea name="note" id="id_note"></textarea><br><br>

            <button type="submit" style="background-color: #ddf5a5;">➕ Додати ОІД</button>
            <button type="button" id="oid-aside-close" onclick="document.getElementById('oid-aside').style.display='none'">✖ Закрити</button>
            <!-- <button type="button" id="oid-aside-close">✖ Закрити</button> -->

        </form>
    </aside>
        <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:998;"></div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("form").forEach(form => {
            form.setAttribute("autocomplete", "off");
        });
    });

     function toggleTheme() {
    document.body.classList.toggle('dark-theme');
  }
</script>