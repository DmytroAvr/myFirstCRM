{% extends "oids/base.html" %}
{% load static %}

{% block title %}Головна панель ОІД{% endblock %}

{% block content %}
<div class="header">
    <h1>Панель керування Об'єктами Інформаційної Діяльності</h1>
    <div class="nav-buttons">
        <a href="{{ add_request_url }}">Додати заявку</a>
        <a href="{{ plan_trip_url }}">Запланувати відрядження</a>
        <a href="{{ add_document_processing_url }}">Додати опрацювання документів</a>
    </div>
</div>

<div class="dashboard-columns" style="display: flex; gap: 20px;">
    {# Стовпчик 1: Військові частини (фільтр) #}
    <div class="column" style="flex: 1; border: 1px solid #ccc; padding: 10px;">
        <h3>Військові частини</h3>
        <form method="get" action="{% url 'oids:main_dashboard' %}" id="unitFilterFormMain">
            <select name="unit" id="id_unit_filter" class="select2" style="width: 100%;" 
                    onchange="this.form.submit();" 
                    data-placeholder="Оберіть ВЧ для фільтрації...">
                <option value=""></option> {# Для плейсхолдера Select2 #}
                {% for unit_obj in all_units %}
                    <option value="{{ unit_obj.id }}" {% if unit_obj.id|stringformat:"s" == selected_unit_id %}selected{% endif %}>
                        {{ unit_obj.code }} - {{ unit_obj.name|default:unit_obj.city }} ({{ unit_obj.territorial_management.name|default:"ТУ не вказано" }})
                    </option>
                {% endfor %}
            </select>
            {# <button type="submit">Фільтрувати</button> #}
        </form>
    </div>

    {# Стовпчик 2: ОІД - тепер рендеряться на сервері #}
    <div class="column column-oids" style="flex: 2; border: 1px solid #ccc; padding: 10px;">
        <h3>
            Об'єкти інформаційної діяльності 
            <span>
                {% if selected_unit_object %}
                    (для ВЧ: {{ selected_unit_object.code }} - {{ selected_unit_object.name|default:selected_unit_object.city }})
                {% elif selected_unit_id %}
                    (для обраної ВЧ) {# Якщо selected_unit_object чомусь None, але ID є #}
                {% else %}
                    (Оберіть ВЧ для відображення ОІД)
                {% endif %}
            </span>
        </h3>

        {% if selected_unit_id %} {# Показуємо списки ОІД тільки якщо ВЧ обрана #}
            <div class="oid-list-section">
                <h4>ОІД, що створюються</h4>
                <ul id="oidsCreatingList">
                    {% for oid_data in oids_creating %}
                        <li>
                            <a href="{{ oid_data.detail_url }}">{{ oid_data.cipher }} - {{ oid_data.full_name }} ({{ oid_data.oid_type_display }})</a>
                            <span>({{ oid_data.status_display }})</span>
                        </li>
                    {% empty %}
                        <li>Немає ОІД у стані створення для обраної ВЧ.</li>
                    {% endfor %}
                </ul>
            </div>
            <hr>
            <div class="oid-list-section">
                <h4>Діючі ОІД</h4>
                <ul id="oidsActiveList">
                    {% for oid_data in oids_active %}
                        <li class="oid-item">
                            <a href="{{ oid_data.detail_url }}">{{ oid_data.cipher }} - {{ oid_data.full_name }} ({{ oid_data.oid_type_display }})</a>
                            <div class="expirations" style="font-size: 0.8em; color: grey; margin-left: 10px;">
                                {% if oid_data.ik_expiration_date %}ІК до: {{ oid_data.ik_expiration_date|date:"d.m.Y" }}<br>{% endif %}
                                {% if oid_data.attestation_expiration_date %}Атестація до: {{ oid_data.attestation_expiration_date|date:"d.m.Y" }}<br>{% endif %}
                                {% if oid_data.prescription_expiration_date %}Припис до: {{ oid_data.prescription_expiration_date|date:"d.m.Y" }}{% endif %}
                            </div>
                        </li>
                    {% empty %}
                        <li>Немає діючих ОІД для обраної ВЧ.</li>
                    {% endfor %}
                </ul>
            </div>
            <hr>
            <div class="oid-list-section">
                <h4>Скасовані/Припинені ОІД</h4>
                <ul id="oidsCancelledList">
                    {% for oid_data in oids_cancelled %}
                        <li>
                            <a href="{{ oid_data.detail_url }}">{{ oid_data.cipher }} - {{ oid_data.full_name }} ({{ oid_data.oid_type_display }})</a>
                            <span>({{ oid_data.status_display }})</span>
                        </li>
                    {% empty %}
                        <li>Немає скасованих/припинених ОІД для обраної ВЧ.</li>
                    {% endfor %}
                </ul>
            </div>
        {% elif not selected_unit_id %}
             <p>Будь ласка, оберіть військову частину для відображення списку ОІД.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block page_specific_js %}
<script>
    // $(document).ready(function() {
    //     // Ініціалізація Select2 для #id_unit_filter (якщо select2-init.js цього не робить)
    //     // $('#id_unit_filter').select2({
    //     //     placeholder: "Оберіть ВЧ...",
    //     //     allowClear: true,
    //     //     language: "uk"
    //     // });
    // });
    // filtering_dynamic.js зараз не потрібен для основного функціоналу цієї сторінки,
    // оскільки фільтрація відбувається перезавантаженням.
    // Він знадобиться, якщо ти захочеш додати AJAX для оновлення списків ОІД
    // або для динамічних select-ів у формах, на які ведуть кнопки.
</script>
{% endblock %}