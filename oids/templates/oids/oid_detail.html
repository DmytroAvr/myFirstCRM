{% extends "oids/base.html" %}

{% block title %}Деталі ОІД: {{ oid.cipher }}{% endblock %}

{% block page_title %}Деталі ОІД: {{ oid.cipher }} ({{ oid.full_name|default:"Без назви" }}){% endblock %}


{% block content %}
<head>
	<style>
		h3 {
			padding-top: 30px;
		}
		.oid-info {
			font-size: 18px;
		}
		.oid-info__item-underline {
			font-family: "Times New Roman", Times, serif;
			font-size: 21px;
			text-decoration: underline;
		}
		
	</style>
</head>
<p><a href="{% url 'oids:main_dashboard' %}">← Повернутися до панелі керування</a></p>

<h2>Основна інформація про ОІД</h2>
<ul class="oid-info">
    <li class="oid-info__list-item"><strong>Територіальне управління:</strong>  <span class="oid-info__item-underline"> {{ oid.unit.territorial_management.name|default:"Не вказано" }}</span></li>
    <li class="oid-info__list-item"><strong>Місто:</strong>  <span class="oid-info__item-underline">  {{ oid.unit.city|default:"-" }}</a></span></li>
    <li class="oid-info__list-item"><strong>Військова частина:</strong>  <span class="oid-info__item-underline"> <a href="{% url 'oids:main_dashboard' %}?unit={{ oid.unit.id }}">{{ oid.unit.code }} - ({{ oid.unit.name|default:oid.unit.city }})</a></span></li>
    <li class="oid-info__list-item"><strong>Шифр:</strong> <span class="oid-info__item-underline">{{ oid.cipher }}</span></li>
    <li class="oid-info__list-item"><strong>Гриф ОІД:</strong>  <span class="oid-info__item-underline"> {{ oid.get_sec_level_display }}</span></li>
    <li class="oid-info__list-item"><strong>Повна назва:</strong>  <span class="oid-info__item-underline"> {{ oid.full_name|default:"Не вказано" }}</span></li>
    <li class="oid-info__list-item"><strong>Тип ОІД:</strong>  <span class="oid-info__item-underline"> {{ oid.get_oid_type_display }}</span></li>
    <li class="oid-info__list-item"><strong>Клас ОІД:</strong>  <span class="oid-info__item-underline"> {{ oid.get_pemin_sub_type_display|default:"-"}}</span></li>
    <li class="oid-info__list-item"><strong>Приміщення:</strong>  <span class="oid-info__item-underline"> {{ oid.room }}</span></li>
    <li class="oid-info__list-item"><strong>Поточний стан:</strong>  <span class="oid-info__item-underline"> {{ oid.get_status_display }} >>> <a href="{% url 'oids:update_specific_oid_status' oid_id_from_url=oid.id %}">Змінити статус ОІД</a> </span></li> 
    <li class="oid-info__list-item"><strong>Примітки:</strong>  <span class="oid-info__item-underline"> {{ oid.note|default:"-" }}</span></li>
    {% if last_attestation_expiration %}
        <li><strong>Атестація дійсна до:</strong> {{ last_attestation_expiration|date:"d.m.Y" }}</li>
    {% endif %}
    {% if last_ik_expiration %}
        <li><strong>ІК дійсний до:</strong> {{ last_ik_expiration|date:"d.m.Y" }}</li>
    {% endif %}
</ul>

<h3>Історія змін статусу</h3>
{% if status_changes %}
    <table>
        <thead>
            <tr>
                <th>Дата зміни</th>
                <th>Попередній статус</th>
                <th>Новий статус</th>
                <th>Причина</th>
                <th>Хто змінив</th>
                <th>Документ-ініціатор</th>
            </tr>
        </thead>
        <tbody>
            {% for change in status_changes %}
                <tr>
                    <td>{{ change.changed_at|date:"d.m.Y H:i" }}</td>
                    <td>{{ change.old_status }}</td>
                    <td>{{ change.new_status }}</td>
                    <td>{{ change.reason|default:"-" }}</td>
                    <td>{{ change.changed_by.full_name|default:"Невідомо" }}</td>
                    <td>
                        {% if change.initiating_document %}
                            <a href="{% url 'oids:oid_detail_view_name' oid.id %}#req-{{ doc.work_request_item.request.id }}">
                                {{ change.initiating_document.document_type.name }} №{{ change.initiating_document.document_number }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Історія змін статусу відсутня.</p>
{% endif %}

<h3>Пов'язані заявки</h3>
{% if work_requests_for_oid %}
    <table>
        <thead>
            <tr>
                <th>Вхідний номер заявки</th>
                <th>Дата заявки</th>
                <th>Статус заявки</th>
                <th>ОІД в заявці (тип роботи, статус)</th>
            </tr>
        </thead>
        <tbody>
            {% for request_obj in work_requests_for_oid %}
                <tr>
                    <td>{{ request_obj.incoming_number }}</td>
                    <td>{{ request_obj.incoming_date|date:"d.m.Y" }}</td>
                    <td>{{ request_obj.get_status_display }}</td>
                    <td>
                        <ul>
                        {% for item in request_obj.items.all %}
                            {% if item.oid == oid %} {# Перевіряємо, чи це елемент для поточного ОІД #}
                                <li>{{ item.oid.cipher }} ({{ item.get_work_type_display }}, {{ item.get_status_display }})</li>
                            {% endif %}
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Заявки на проведення робіт для цього ОІД відсутні.</p>
{% endif %}

<h3>Технічні завдання</h3>
{% if technical_tasks %}
    <table>
        <thead>
            <tr>
                <th>Вхідний номер</th>
                <th>Вхідна дата</th>
                <th>Результат розгляду</th>
                <th>Хто ознайомився</th>
                <th>Примітки</th>
                <th>Дата додання</th>
            </tr>
        </thead>
        <tbody>
            {% for tt in technical_tasks %}
                <tr>
                    <td>{{ tt.input_number }}</td>
                    <td>{{ tt.input_date|date:"d.m.Y" }}</td>
                    <td>{{ tt.get_review_result_display }}</td>
                    <td>{{ tt.reviewed_by.full_name|default:"-" }}</td>
                    <td>{{ tt.note|default:"-" }}</td>
                    <td>{{ tt.created_at|date:"d.m.Y H:i" }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Технічні завдання для цього ОІД відсутні.</p>
{% endif %}

<h3>Опрацьовані документи</h3>
{% if documents %}
    <table>
        <thead>
            <tr>
                <th>Тип документа</th>
                <th>Номер</th>
                <th>Дата опрацювання</th>
                <th>Дата робіт</th>
                <th>Термін дії</th>
                <th>Автор</th>
                <th>Заявка</th>
                <th>Примітки</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
                <tr id="doc-{{ doc.id }}">
                    <td>{{ doc.document_type.name }}</td>
                    <td>{{ doc.document_number }}</td>
                    <td>{{ doc.process_date|date:"d.m.Y" }}</td>
                    <td>{{ doc.work_date|date:"d.m.Y" }}</td>
                    <td>
                        {% if doc.expiration_date %}
                            {{ doc.expiration_date|date:"d.m.Y" }}
                        {% else %}
                            Безстроково
                        {% endif %}
                    </td>
                    <td>{{ doc.author.full_name|default:"-" }}</td>
                    <td>
                        {% if doc.work_request_item %}
                            <a href="{% url 'oids:oid_detail_view_name' oid.id %}#req-{{ doc.work_request_item.request.id }}">
                                Заявка {{ doc.work_request_item.request.incoming_number }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ doc.note|default:"-" }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Опрацьовані документи для цього ОІД відсутні.</p>
{% endif %}

<h3>Історія відряджень</h3>
{% if trips_for_oid %}
    <table>
        <thead>
            <tr>
                <th>Період</th>
                <th>Військові частини</th>
                <th>Особи у відрядженні</th>
                <th>Мета</th>
                <th>Пов'язані заявки</th>
            </tr>
        </thead>
        <tbody>
            {% for trip in trips_for_oid %}
                <tr>
                    <td>{{ trip.start_date|date:"d.m.Y" }} - {{ trip.end_date|date:"d.m.Y" }}</td>
                    <td>
                        <ul>
                            {% for unit in trip.units.all %}
                                <li>{{ unit.code }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td>
                        <ul>
                            {% for person in trip.persons.all %}
                                <li>{{ person.full_name }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td>{{ trip.purpose|default:"-" }}</td>
                    <td>
                        <ul>
                            {% for req in trip.work_requests.all %}
                                <li>Заявка {{ req.incoming_number }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Відрядження, що стосуються цього ОІД, відсутні.</p>
{% endif %}

<h3>Реєстрації актів атестації</h3>
{% if attestation_acts_for_oid %}
    <table class="table table-sm table-bordered"> {# Додав table-sm та table-bordered для кращого вигляду #}
        <thead class="thead-light"> {# Змінив thead-dark на thead-light #}
            <tr>
                <th>Акт атестації (документ №)</th>
                <th>Дата акту</th>
                <th>Статус відправки / Вих. лист</th>
                <th>Номер реєстрації ДССЗЗІ</th>
                <th>Дата реєстрації ДССЗЗІ</th>
                <th>Лист-відповідь ДССЗЗІ</th>
            </tr>
        </thead>
        <tbody>
            {% for act_doc in attestation_acts_for_oid %}
                <tr>
                    <td>
                        <a href="#doc-{{ act_doc.id }}">{{ act_doc.document_number }}</a>
                    </td>
                    <td>{{ act_doc.work_date|date:"d.m.Y" }}</td>
                    <td>
                        {% if act_doc.attestation_registration_sent %}
                            Відправлено листом 
                            №{{ act_doc.attestation_registration_sent.outgoing_letter_number }}
                            від {{ act_doc.attestation_registration_sent.outgoing_letter_date|date:"d.m.Y" }}
                            ({{ act_doc.attestation_registration_sent.get_status_display }})
                        {% else %}
                            Не відправлено
                        {% endif %}
                    </td>
                    <td>{{ act_doc.dsszzi_registered_number|default:"-" }}</td>
                    <td>
                        {% if act_doc.dsszzi_registered_date %}
                            {{ act_doc.dsszzi_registered_date|date:"d.m.Y" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if act_doc.attestation_registration_sent and act_doc.attestation_registration_sent.response_received %}
                            Відповідь №{{ act_doc.attestation_registration_sent.response_received.response_letter_number }}
                            від {{ act_doc.attestation_registration_sent.response_received.response_letter_date|date:"d.m.Y" }}
                        {% elif act_doc.attestation_registration_sent and act_doc.attestation_registration_sent.status == 'sent' %}
                            Очікується
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Акти атестації для цього ОІД, що потребують або пройшли реєстрацію, відсутні.</p>
{% endif %}
		{# Важливо: для посилань типу <a href="...#req-{{ doc.work_request_item.request.id }}"> #}
		{# Переконайтеся, що у відповідних таблицях (наприклад, для Заявок) є елементи з такими id #}
		{# Наприклад, для таблиці Заявок: #}
		{# <tr id="req-{{ request_obj.id }}"> #}

{% endblock %}

<!-- 
<a href="{% url 'oids:add_document_for_oid_view_name' oid_id=oid.id %}">Додати документ для цього ОІД</a>
{# Або коротше, якщо порядок аргументів збігається: #}
<a href="{% url 'oids:add_document_for_oid_view_name' oid.id %}">Додати документ для цього ОІД</a> -->