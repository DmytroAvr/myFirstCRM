{% extends "oids/base.html" %}

{% block title %}Деталі ОІД: {{ oid.cipher }}{% endblock %}

{% block page_title %}Деталі ОІД: {{ oid.cipher }} ({{ oid.full_name|default:"Без назви" }}){% endblock %}

{% block content %}
<p><a href="{% url 'oids:main_dashboard' %}?unit={{ oid.unit.id }}">← Повернутися до списку ОІД частини {{ oid.unit.code }}</a></p>
<p><a href="{% url 'oids:main_dashboard' %}">← Повернутися на головну панель</a></p>

<h2>Основна інформація про ОІД</h2>
<ul>
    <li><strong>Шифр:</strong> {{ oid.cipher }}</li>
    <li><strong>Повна назва:</strong> {{ oid.full_name|default:"Не вказано" }}</li>
    <li><strong>Тип ОІД:</strong> {{ oid.get_oid_type_display }}</li>
    <li><strong>Військова частина:</strong> <a href="{% url 'oids:main_dashboard' %}?unit={{ oid.unit.id }}">{{ oid.unit.code }} - {{ oid.unit.name|default:oid.unit.city }}</a></li>
    <li><strong>Територіальне управління:</strong> {{ oid.unit.territorial_management.name|default:"Не вказано" }}</li>
    <li><strong>Приміщення:</strong> {{ oid.room }}</li>
    <li><strong>Поточний стан:</strong> {{ oid.get_status_display }}</li>
    <li><strong>Гриф ОІД:</strong> {{ oid.get_sec_level_display }}</li>
    <li><strong>Примітки:</strong> {{ oid.note|default:"-" }}</li>
    {% if last_attestation_expiration %}
        <li><strong>Атестація дійсна до:</strong> {{ last_attestation_expiration|date:"d.m.Y" }}</li>
    {% endif %}
    {% if last_ik_expiration %}
        <li><strong>ІК дійсний до:</strong> {{ last_ik_expiration|date:"d.m.Y" }}</li>
    {% endif %}
    {% if last_prescription_expiration %}
        <li><strong>Припис дійсний до:</strong> {{ last_prescription_expiration|date:"d.m.Y" }}</li>
    {% endif %}
</ul>

<h3>Історія змін статусу</h3>
{% if status_changes %}
    <table>
        <thead>
            <tr>
                <th>Дата зміни</th><th>Попередній статус</th><th>Новий статус</th><th>Причина</th><th>Хто змінив</th><th>Документ-ініціатор</th>
            </tr>
        </thead>
        <tbody>
            {% for change in status_changes %}
            <tr>
                <td>{{ change.changed_at|date:"d.m.Y H:i" }}</td>
                <td>{{ change.old_status }}</td>
                <td>{{ change.new_status }}</td>
                <td>{{ change.reason|default:"-" }}</td>
                <td>{{ change.changed_by.full_name|default:"Невідомо" }}</td>
                <td>
                    {% if change.initiating_document %}
                        Док. №{{ change.initiating_document.document_number }} ({{change.initiating_document.document_type.name}})
                    {% else %}-{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Історія змін статусу відсутня.</p>
{% endif %}

<h3>Пов'язані заявки на проведення робіт</h3>
{% if work_requests_for_oid %}
    <table>
        <thead><tr><th>Номер заявки</th><th>Дата заявки</th><th>Статус</th><th>Тип робіт в заявці для цього ОІД</th></tr></thead>
        <tbody>
        {% for req in work_requests_for_oid %}
            <tr>
                <td>{{ req.incoming_number }}</td>
                <td>{{ req.incoming_date|date:"d.m.Y" }}</td>
                <td>{{ req.get_status_display }}</td>
                <td>
                    <ul>
                    {% for item in req.items.all %}
                        {% if item.oid_id == oid.id %} {# Показуємо тільки тип роботи для поточного ОІД #}
                            <li>{{ item.get_work_type_display }} (статус по ОІД: {{item.get_status_display}})</li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Заявки відсутні.</p>
{% endif %}

<h3>Опрацьовані документи</h3>
{% if documents %}
    <table>
        <thead><tr><th>Тип</th><th>Номер</th><th>Дата опрац.</th><th>Дата робіт</th><th>Термін дії</th><th>Автор</th><th>Примітки</th></tr></thead>
        <tbody>
        {% for doc in documents %}
            <tr id="doc-{{ doc.id }}">
                <td>{{ doc.document_type.name }}</td>
                <td>{{ doc.document_number }}</td>
                <td>{{ doc.process_date|date:"d.m.Y" }}</td>
                <td>{{ doc.work_date|date:"d.m.Y" }}</td>
                <td>{% if doc.expiration_date %}{{ doc.expiration_date|date:"d.m.Y" }}{% else %}Безстроково{% endif %}</td>
                <td>{{ doc.author.full_name|default:"-" }}</td>
                <td>{{ doc.note|default:"-" }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Документи відсутні.</p>
{% endif %}

{# Додай тут секції для TechnicalTask, Trip, AttestationRegistration, TripResultForUnit аналогічно #}

{% endblock %}