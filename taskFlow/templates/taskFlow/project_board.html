{% extends 'base.html' %}
{% load static %}

{% block title %}{{ project.name }} - –î–æ—à–∫–∞ - TaskFlow{% endblock %}

{% block extra_css %}
<style>
    .board-container {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding-bottom: 1rem;
        min-height: calc(100vh - 200px);
    }
    .board-column {
        flex: 0 0 320px;
        background: #f8fafc;
        border-radius: 0.5rem;
        padding: 1rem;
        max-height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }
    .column-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e2e8f0;
    }
    .column-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
    }
    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    .task-count {
        background: white;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
    }
    .tasks-container {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.25rem;
    }
    .tasks-container::-webkit-scrollbar {
        width: 6px;
    }
    .tasks-container::-webkit-scrollbar-track {
        background: transparent;
    }
    .tasks-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    .task-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        cursor: move;
        transition: all 0.2s;
        border-left: 3px solid transparent;
    }
    .task-card:hover {
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        transform: translateY(-2px);
    }
    .task-card.dragging {
        opacity: 0.5;
    }
    .task-card.drag-over {
        border-left-color: #3b82f6;
        background: #eff6ff;
    }
    .task-card.overdue {
        border-left-color: #ef4444;
    }
    .task-card.due-today {
        border-left-color: #f97316;
    }
    .task-key {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        font-family: monospace;
    }
    .task-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0.5rem 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .task-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        flex-wrap: wrap;
    }
    .priority-badge {
        font-size: 0.625rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .priority-low { background: #f1f5f9; color: #64748b; }
    .priority-medium { background: #fef3c7; color: #92400e; }
    .priority-high { background: #fed7aa; color: #9a3412; }
    .priority-critical { background: #fecaca; color: #991b1b; }
    .assignee-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.625rem;
        font-weight: 600;
    }
    .due-date {
        font-size: 0.625rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .due-date.overdue { color: #dc2626; font-weight: 700; }
    .due-date.today { color: #f97316; font-weight: 700; }
    .add-task-btn {
        width: 100%;
        padding: 0.75rem;
        border: 2px dashed #cbd5e1;
        background: white;
        border-radius: 0.5rem;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
    }
    .add-task-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
        background: #eff6ff;
    }
    .project-header {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        margin-bottom: 1.5rem;
    }
    .board-filters {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'taskFlow:project_list' %}">–ü—Ä–æ—î–∫—Ç–∏</a></li>
            <li class="breadcrumb-item"><a href="{% url 'taskFlow:project_detail' project.pk %}">{{ project.name }}</a></li>
            <li class="breadcrumb-item active">–î–æ—à–∫–∞</li>
        </ol>
    </nav>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ—î–∫—Ç—É -->
    <div class="project-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-1">
                    <code class="badge bg-primary">{{ project.key }}</code>
                    {{ project.name }}
                </h1>
                {% if project.description %}
                <p class="text-muted mb-0">{{ project.description }}</p>
                {% endif %}
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'taskFlow:task_create' %}?project={{ project.pk }}" class="btn btn-primary">
                    <i class="bi bi-plus-lg"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è
                </a>
                <a href="{% url 'taskFlow:task_list' %}?project={{ project.pk }}" class="btn btn-outline-secondary">
                    <i class="bi bi-list-ul"></i> –°–ø–∏—Å–æ–∫
                </a>
            </div>
        </div>
    </div>

    <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
    <div class="board-filters">
        <div class="row g-2 align-items-center">
            <div class="col-auto">
                <span class="text-muted small fw-semibold">–§—ñ–ª—å—Ç—Ä–∏:</span>
            </div>
            <div class="col-auto">
                <select class="form-select form-select-sm" id="filterAssignee">
                    <option value="">–í—Å—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ</option>
                    {% for person in persons %}
                    <option value="{{ person.id }}">{{ person.full_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <select class="form-select form-select-sm" id="filterPriority">
                    <option value="">–í—Å—ñ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∏</option>
                    <option value="critical">–ö—Ä–∏—Ç–∏—á–Ω–∏–π</option>
                    <option value="high">–í–∏—Å–æ–∫–∏–π</option>
                    <option value="medium">–°–µ—Ä–µ–¥–Ω—ñ–π</option>
                    <option value="low">–ù–∏–∑—å–∫–∏–π</option>
                </select>
            </div>
            <div class="col-auto">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="showOverdue" checked>
                    <label class="form-check-label small" for="showOverdue">
                        –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ
                    </label>
                </div>
            </div>
            <div class="col-auto ms-auto">
                <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                    <i class="bi bi-x-circle"></i> –°–∫–∏–Ω—É—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <!-- –ö–∞–Ω–±–∞–Ω –¥–æ—à–∫–∞ -->
    <div class="board-container">
        {% for column in board_data %}
        <div class="board-column" data-status-id="{{ column.status.id }}">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–ª–æ–Ω–∫–∏ -->
            <div class="column-header">
                <div class="column-title">
                    <div class="status-dot" style="background-color: {% if column.status.color == 'bg-gray-500' %}#6b7280{% elif column.status.color == 'bg-blue-500' %}#3b82f6{% elif column.status.color == 'bg-green-500' %}#10b981{% elif column.status.color == 'bg-yellow-500' %}#eab308{% elif column.status.color == 'bg-purple-500' %}#a855f7{% elif column.status.color == 'bg-red-500' %}#ef4444{% else %}#6b7280{% endif %}"></div>
                    <span>{{ column.status.name }}</span>
                </div>
                <span class="task-count">{{ column.count }}</span>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–¥–∞–Ω—å -->
            <div class="tasks-container" 
                 ondrop="drop(event)" 
                 ondragover="allowDrop(event)"
                 ondragleave="dragLeave(event)">
                {% for task in column.tasks %}
                <div class="task-card {% if task.is_overdue %}overdue{% elif task.is_due_today %}due-today{% endif %}" 
                     draggable="true" 
                     ondragstart="drag(event)"
                     ondragend="dragEnd(event)"
                     data-task-id="{{ task.id }}"
                     data-assignee-id="{{ task.assignee.id|default:'' }}"
                     data-priority="{{ task.priority }}"
                     data-overdue="{% if task.is_overdue %}true{% else %}false{% endif %}"
                     onclick="window.location='{% url 'taskFlow:task_detail' task.pk %}'">
                    
                    <!-- –ö–ª—é—á -->
                    <div class="task-key">
                        {{ task.key }}
                        {% if task.is_overdue %}
                            <i class="bi bi-exclamation-triangle-fill text-danger ms-1"></i>
                        {% elif task.is_due_today %}
                            <i class="bi bi-clock-fill text-warning ms-1"></i>
                        {% endif %}
                    </div>

                    <!-- –ù–∞–∑–≤–∞ -->
                    <div class="task-title">{{ task.title }}</div>

                    <!-- –ú–µ—Ç–∞–¥–∞–Ω—ñ -->
                    <div class="task-meta">
                        <!-- –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç -->
                        <span class="priority-badge priority-{{ task.priority }}">
                            {% if task.priority == 'low' %}üü¢
                            {% elif task.priority == 'medium' %}üü°
                            {% elif task.priority == 'high' %}üü†
                            {% elif task.priority == 'critical' %}üî¥
                            {% endif %}
                        </span>

                        <!-- –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å -->
                        {% if task.assignee %}
                        <div class="assignee-avatar" title="{{ task.assignee.full_name }}">
                            {{ task.assignee.full_name|slice:":1"|upper }}
                        </div>
                        {% endif %}

                        <!-- –¢–µ—Ä–º—ñ–Ω -->
                        {% if task.due_date %}
                        <div class="due-date {% if task.is_overdue %}overdue{% elif task.is_due_today %}today{% endif %}">
                            <i class="bi bi-calendar3"></i>
                            {{ task.due_date|date:"d.m" }}
                        </div>
                        {% endif %}

                        <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
                        {% if task.comments.count > 0 %}
                        <div class="due-date">
                            <i class="bi bi-chat-left-text"></i>
                            {{ task.comments.count }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- –Ø–∫—â–æ –Ω–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å -->
                {% if not column.tasks %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.3;"></i>
                    <p class="small mb-0 mt-2">–ù–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å</p>
                </div>
                {% endif %}
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è -->
            <button class="add-task-btn mt-2" onclick="createTask('{{ column.status.id }}')">
                <i class="bi bi-plus-lg"></i> –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è
            </button>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Drag and Drop —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å
    let draggedElement = null;

    function drag(event) {
        draggedElement = event.target;
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('taskId', event.target.dataset.taskId);
    }

    function dragEnd(event) {
        event.target.classList.remove('dragging');
        document.querySelectorAll('.tasks-container').forEach(container => {
            container.classList.remove('drag-over');
        });
    }

    function allowDrop(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        if (event.target.classList.contains('tasks-container')) {
            event.target.classList.add('drag-over');
        }
    }

    function dragLeave(event) {
        if (event.target.classList.contains('tasks-container')) {
            event.target.classList.remove('drag-over');
        }
    }

    function drop(event) {
        event.preventDefault();
        
        const container = event.target.closest('.tasks-container');
        if (!container) return;
        
        container.classList.remove('drag-over');
        
        const taskId = event.dataTransfer.getData('taskId');
        const newStatusId = container.closest('.board-column').dataset.statusId;
        
        updateTaskStatus(taskId, newStatusId);
    }

    function updateTaskStatus(taskId, newStatusId) {
        fetch(`/tasks/api/tasks/${taskId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `status_id=${newStatusId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è', 'error');
        });
    }

    function createTask(statusId) {
        window.location.href = `{% url 'taskFlow:task_create' %}?project={{ project.pk }}&status=${statusId}`;
    }

    // –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è
    function filterTasks() {
        const assigneeFilter = document.getElementById('filterAssignee').value;
        const priorityFilter = document.getElementById('filterPriority').value;
        const showOverdue = document.getElementById('showOverdue').checked;

        document.querySelectorAll('.task-card').forEach(card => {
            let show = true;

            if (assigneeFilter && card.dataset.assigneeId !== assigneeFilter) {
                show = false;
            }

            if (priorityFilter && card.dataset.priority !== priorityFilter) {
                show = false;
            }

            if (!showOverdue && card.dataset.overdue === 'true') {
                show = false;
            }

            card.style.display = show ? 'block' : 'none';
        });

        updateCounters();
    }

    function updateCounters() {
        document.querySelectorAll('.board-column').forEach(column => {
            const visibleTasks = column.querySelectorAll('.task-card[style="display: block;"], .task-card:not([style*="display: none"])').length;
            const counter = column.querySelector('.task-count');
            counter.textContent = visibleTasks;
        });
    }

    function resetFilters() {
        document.getElementById('filterAssignee').value = '';
        document.getElementById('filterPriority').value = '';
        document.getElementById('showOverdue').checked = true;
        filterTasks();
    }

    document.getElementById('filterAssignee').addEventListener('change', filterTasks);
    document.getElementById('filterPriority').addEventListener('change', filterTasks);
    document.getElementById('showOverdue').addEventListener('change', filterTasks);

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showToast(message, type = 'info') {
        alert(message);
    }

    document.querySelectorAll('.task-card').forEach(card => {
        card.addEventListener('dragstart', (e) => {
            e.stopPropagation();
        });
    });
</script>
{% endblock %}