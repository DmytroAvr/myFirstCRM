{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è{% else %}–°—Ç–≤–æ—Ä–µ–Ω–Ω—è{% endif %} –∑–∞–≤–¥–∞–Ω–Ω—è - TaskFlow{% endblock %}

{% block extra_css %}
<style>
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'taskFlow:project_list' %}">–ü—Ä–æ—î–∫—Ç–∏</a></li>
            <li class="breadcrumb-item"><a href="{% url 'taskFlow:task_list' %}">–ó–∞–≤–¥–∞–Ω–Ω—è</a></li>
            {% if is_edit %}
                <li class="breadcrumb-item"><a href="{% url 'taskFlow:task_detail' task.pk %}">{{ task.key }}</a></li>
                <li class="breadcrumb-item active">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</li>
            {% else %}
                <li class="breadcrumb-item active">–ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</li>
            {% endif %}
        </ol>
    </nav>

    <div class="form-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-4">
            <h1 class="h2">
                {% if is_edit %}
                    <i class="bi bi-pencil-square text-primary"></i>
                    –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è {{ task.key }}
                {% else %}
                    <i class="bi bi-plus-circle text-primary"></i>
                    –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è
                {% endif %}
            </h1>
            <p class="text-muted">
                {% if is_edit %}
                    –í–Ω–µ—Å—ñ—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –∑–º—ñ–Ω–∏ —Ç–∞ –∑–±–µ—Ä–µ–∂—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è
                {% else %}
                    –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è
                {% endif %}
            </p>
        </div>

        <!-- –§–æ—Ä–º–∞ -->
        <form method="post" class="form-card">
            {% csrf_token %}

            <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-info-circle"></i>
                    –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
                </h3>

                <div class="row g-3">
                    <!-- –ü—Ä–æ—î–∫—Ç -->
                    <div class="col-md-6">
                        <label for="project" class="form-label required-field">–ü—Ä–æ—î–∫—Ç</label>
                        <select class="form-select" 
                                id="project" 
                                name="project" 
                                required
                                {% if is_edit %}disabled{% endif %}>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ—î–∫—Ç...</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" 
                                    {% if is_edit and task.project.id == project.id %}selected
                                    {% elif not is_edit and selected_project == project.id|stringformat:"s" %}selected
                                    {% endif %}>
                                {{ project.name }} ({{ project.key }})
                            </option>
                            {% endfor %}
                        </select>
                        {% if is_edit %}
                            <input type="hidden" name="project" value="{{ task.project.id }}">
                            <small class="text-muted">–ü—Ä–æ—î–∫—Ç –Ω–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</small>
                        {% endif %}
                    </div>

                    <!-- –°—Ç–∞—Ç—É—Å -->
                    <div class="col-md-6">
                        <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">–£—Å—Ç–∞–ª–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å</option>
                            {% for status in statuses %}
                            <option value="{{ status.id }}"
                                    {% if is_edit and task.status.id == status.id %}selected
                                    {% elif not is_edit and selected_status == status.id|stringformat:"s" %}selected
                                    {% endif %}>
                                {{ status.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">–£—Å—Ç–∞–ª–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å –¥–æ–¥–∞—î –≤ –ë–ï–ö–õ–û–ì</small>
                    </div>

                    <!-- –ù–∞–∑–≤–∞ -->
                    <div class="col-12">
                        <label for="title" class="form-label required-field">–ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è</label>
                        <input type="text" 
                               class="form-control" 
                               id="title" 
                               name="title" 
                               value="{% if is_edit %}{{ task.title }}{% endif %}"
                               placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–æ—Ç–∫—É –Ω–∞–∑–≤—É –∑–∞–≤–¥–∞–Ω–Ω—è..."
                               required
                               maxlength="255">
                    </div>

                    <!-- –û–ø–∏—Å -->
                    <div class="col-12">
                        <label for="description" class="form-label">–û–ø–∏—Å</label>
                        <textarea class="form-control" 
                                  id="description" 
                                  name="description" 
                                  rows="6"
                                  placeholder="–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –∑–∞–≤–¥–∞–Ω–Ω—è...">{% if is_edit %}{{ task.description }}{% endif %}</textarea>
                        <small class="text-muted">–û–ø–∏—à—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–æ</small>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-people"></i>
                    –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
                </h3>

                <div class="row g-3">
                    <!-- –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å -->
                    <div class="col-md-6">
                        <label for="assignee" class="form-label">
                            <i class="bi bi-person"></i>
                            –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å
                        </label>
                        <select class="form-select" id="assignee" name="assignee">
                            <option value="">–ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ</option>
                            {% for person in persons %}
                            <option value="{{ person.id }}"
                                    {% if is_edit and task.assignee and task.assignee.id == person.id %}selected{% endif %}>
                                {{ person.full_name }} - {{ person.get_group_display }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª -->
                    <div class="col-md-6">
                        <label for="department" class="form-label">
                            <i class="bi bi-building"></i>
                            –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª
                        </label>
                        <select class="form-select" id="department" name="department">
                            <option value="">–ù–µ –æ–±—Ä–∞–Ω–æ</option>
                            {% for value, label in departments %}
                            <option value="{{ value }}"
                                    {% if is_edit and task.department == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç -->
                    <div class="col-md-6">
                        <label for="priority" class="form-label">
                            <i class="bi bi-exclamation-triangle"></i>
                            –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç
                        </label>
                        <select class="form-select" id="priority" name="priority">
                            {% for value, label in priorities %}
                            <option value="{{ value }}"
                                    {% if is_edit and task.priority == value %}selected
                                    {% elif not is_edit and value == 'medium' %}selected
                                    {% endif %}>
                                {% if value == 'low' %}üü¢ {{ label }}
                                {% elif value == 'medium' %}üü° {{ label }}
                                {% elif value == 'high' %}üü† {{ label }}
                                {% elif value == 'critical' %}üî¥ {{ label }}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- –¢–µ—Ä–º—ñ–Ω –≤–∏–∫–æ–Ω–∞–Ω–Ω—è -->
                    <div class="col-md-6">
                        <label for="due_date" class="form-label">
                            <i class="bi bi-calendar-event"></i>
                            –¢–µ—Ä–º—ñ–Ω –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
                        </label>
                        <input type="date" 
                               class="form-control" 
                               id="due_date" 
                               name="due_date"
                               value="{% if is_edit and task.due_date %}{{ task.due_date|date:'Y-m-d' }}{% endif %}"
                               min="{{ today|date:'Y-m-d' }}">
                        <small class="text-muted">–î–µ–¥–ª–∞–π–Ω –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è</small>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="d-flex gap-2 justify-content-between align-items-center">
                <a href="{% if is_edit %}{% url 'taskFlow:task_detail' task.pk %}{% else %}{% url 'taskFlow:task_list' %}{% endif %}" 
                   class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i>
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </a>
                
                <div class="d-flex gap-2">
                    {% if is_edit %}
                    <button type="button" 
                            class="btn btn-outline-danger"
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteModal">
                        <i class="bi bi-trash"></i>
                        –í–∏–¥–∞–ª–∏—Ç–∏
                    </button>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i>
                        {% if is_edit %}–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏{% else %}–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è{% endif %}
                    </button>
                </div>
            </div>
        </form>

        <!-- –ü—ñ–¥–∫–∞–∑–∫–∏ -->
        <div class="alert alert-info mt-4">
            <h6 class="alert-heading">
                <i class="bi bi-lightbulb"></i>
                –ü—ñ–¥–∫–∞–∑–∫–∏
            </h6>
            <ul class="mb-0 small">
                <li>–ü–æ–ª—è –≤—ñ–¥–º—ñ—á–µ–Ω—ñ <span class="text-danger">*</span> —î –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º–∏</li>
                <li>–ö–ª—é—á –∑–∞–≤–¥–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, PROJ-123) –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</li>
                <li>–í–∏ –∑–º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è</li>
                <li>–í—Å—ñ –∑–º—ñ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø–∏—Å—É—é—Ç—å—Å—è –≤ —ñ—Å—Ç–æ—Ä—ñ—é</li>
            </ul>
        </div>
    </div>
</div>

<!-- Modal –≤–∏–¥–∞–ª–µ–Ω–Ω—è (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è) -->
{% if is_edit %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è <strong>{{ task.key }}</strong>?</p>
                <p class="text-danger mb-0">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ –±—É–¥–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏! –í—Å—ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ —Ç–∞ —ñ—Å—Ç–æ—Ä—ñ—è —Ç–∞–∫–æ–∂ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <form method="post" action="{% url 'taskFlow:task_delete' task.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i>
                        –í–∏–¥–∞–ª–∏—Ç–∏ –Ω–∞–∑–∞–≤–∂–¥–∏
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
	// –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ñ–æ—Ä–º–∏
    document.querySelector('form').addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const project = document.getElementById('project').value;
        
        if (!title) {
            e.preventDefault();
            alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∑–∞–≤–¥–∞–Ω–Ω—è');
            document.getElementById('title').focus();
            return false;
        }
        
        if (!project) {
            e.preventDefault();
            alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –ø—Ä–æ—î–∫—Ç');
            document.getElementById('project').focus();
            return false;
        }
    });

    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏
    const formFields = ['title', 'description', 'priority'];
    const formKey = 'taskflow_draft_task';
    
    // –û—Å–Ω–æ–≤–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
    const form = document.querySelector('form.form-card');
    const dueDateInput = document.getElementById('due_date');

    // --- 1. –õ–æ–≥—ñ–∫–∞ –¥–∞—Ç ---
    const today = new Date().toISOString().split('T')[0];
    if (dueDateInput) {
        dueDateInput.setAttribute('min', today);
        dueDateInput.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const todayDate = new Date(today);
            if (selectedDate < todayDate) {
                if (!confirm('–í–∏ –æ–±—Ä–∞–ª–∏ –¥–∞—Ç—É –≤ –º–∏–Ω—É–ª–æ–º—É. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) {
                    this.value = '';
                }
            }
        });
    }

    // --- 2. –õ–æ–≥—ñ–∫–∞ –î—Ä–∞—Ñ—Ç—ñ–≤ (–¢—ñ–ª—å–∫–∏ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è) ---
    {% if not is_edit %}
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥—Ä–∞—Ñ—Ç—É
    window.addEventListener('load', function() {
        const draft = localStorage.getItem(formKey);
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –¥—Ä–∞—Ñ—Ç —ñ —á–∏ –ø–æ–ª—è —Ñ–æ—Ä–º–∏ –ø–æ—Ä–æ–∂–Ω—ñ (—â–æ–± –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ —Å–µ—Ä–≤–µ—Ä–∞)
        const titleInput = document.getElementById('title');
        const isFormEmpty = titleInput.value.trim() === '';

        if (draft && isFormEmpty) {
            const data = JSON.parse(draft);
            if (confirm('–ó–Ω–∞–π–¥–µ–Ω–æ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –¥—Ä–∞—Ñ—Ç. –í—ñ–¥–Ω–æ–≤–∏—Ç–∏?')) {
                formFields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element && data[field]) {
                        element.value = data[field];
                    }
                });
            } else {
                // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–º–æ–≤–∏–≤—Å—è - –≤–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π –¥—Ä–∞—Ñ—Ç
                localStorage.removeItem(formKey);
            }
        }
    });

    // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥—Ä–∞—Ñ—Ç—É –ø—Ä–∏ –≤–≤–µ–¥–µ–Ω–Ω—ñ
    formFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('input', function() {
                const draft = {};
                formFields.forEach(f => {
                    const el = document.getElementById(f);
                    if (el) draft[f] = el.value;
                });
                localStorage.setItem(formKey, JSON.stringify(draft));
            });
        }
    });
    {% endif %}

    // --- 3. –Ñ–¥–∏–Ω–∞ —Ç–æ—á–∫–∞ –í–∞–ª—ñ–¥–∞—Ü—ñ—ó —Ç–∞ –í—ñ–¥–ø—Ä–∞–≤–∫–∏ ---
    if (form) {
        form.addEventListener('submit', function(e) {
            const title = document.getElementById('title').value.trim();
            const project = document.getElementById('project').value;
            
            // –í–ê–õ–Ü–î–ê–¶–Ü–Ø
            if (!title) {
                e.preventDefault();
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∑–∞–≤–¥–∞–Ω–Ω—è');
                document.getElementById('title').focus();
                return false;
            }
            
            if (!project) {
                e.preventDefault();
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –ø—Ä–æ—î–∫—Ç');
                document.getElementById('project').focus();
                return false;
            }

            // –û–ß–ò–©–ï–ù–ù–Ø –î–†–ê–§–¢–£
            // –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –º–∏ –ø—Ä–æ–π—à–ª–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é —ñ –¥—ñ–π—Å–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ñ–æ—Ä–º—É
            {% if not is_edit %}
                localStorage.removeItem(formKey);
            {% endif %}
            
            // –§–æ—Ä–º–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –¥–∞–ª—ñ...
            return true;
        });
    }
</script>
{% endblock %}